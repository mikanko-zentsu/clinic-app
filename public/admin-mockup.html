<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>〇〇接骨院 管理画面</title>
  <style>
    :root {
      --primary: hsl(199, 89%, 48%);
      --primary-dark: hsl(199, 89%, 35%);
      --primary-light: hsl(199, 89%, 95%);
      --background: hsl(210, 40%, 98%);
      --foreground: hsl(222, 47%, 11%);
      --border: hsl(214, 32%, 91%);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { overflow-x: hidden; }
    body {
      font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", sans-serif;
      background: var(--background);
      color: var(--foreground);
      display: flex;
      height: 100vh;
      overflow: hidden;
      max-width: 100vw;
    }

    /* ── Sidebar ── */
    .sidebar { width: 220px; min-width: 220px; background: hsl(222,47%,11%); display: flex; flex-direction: column; height: 100vh; }
    .sidebar-logo { padding: 20px 18px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .sidebar-logo .clinic-name { color: #fff; font-size: 14px; font-weight: 800; line-height: 1.5; }
    .sidebar-logo .admin-label { display: inline-block; margin-top: 5px; background: var(--primary); color: #fff; font-size: 10px; font-weight: 700; letter-spacing: 0.08em; padding: 1px 9px; border-radius: 20px; }
    .sidebar-nav { padding: 10px 8px; flex: 1; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 9px; cursor: pointer; color: hsl(214,32%,72%); font-size: 13px; font-weight: 500; margin-bottom: 2px; transition: all 0.12s; user-select: none; }
    .nav-item:hover { background: rgba(255,255,255,0.07); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; }
    .nav-icon { width: 16px; height: 16px; flex-shrink: 0; }
    .sidebar-footer { padding: 10px 8px; border-top: 1px solid rgba(255,255,255,0.08); }
    .logout-btn { display: flex; align-items: center; gap: 9px; padding: 9px 12px; border-radius: 9px; cursor: pointer; color: hsl(214,32%,55%); font-size: 12px; width: 100%; background: none; border: none; font-family: inherit; }
    .logout-btn:hover { background: rgba(255,255,255,0.06); color: #fff; }

    /* ── Main ── */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .topbar { background: #fff; border-bottom: 1px solid var(--border); padding: 0 22px; height: 56px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .topbar-title { font-size: 22px; font-weight: 800; white-space: nowrap; }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .date-badge { background: var(--primary-light); color: var(--primary-dark); font-size: 15px; font-weight: 700; padding: 4px 14px; border-radius: 20px; white-space: nowrap; }
    .user-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }

    /* ── Content: no scroll, flex column ── */
    .content { flex: 1; overflow: hidden; padding: 10px 12px 10px; display: flex; flex-direction: column; min-width: 0; }

    /* ── Pages ── */
    .page { display: none; }
    .page.active { display: flex; flex-direction: column; height: 100%; }

    /* ── Section title ── */
    .section-title { font-size: 10px; font-weight: 700; color: hsl(214,32%,52%); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 5px; flex-shrink: 0; }

    /* ════════════════════
       ① (Stats / Occ — 統合済み → summary-bar)
    ════════════════════ */
    /* ════════════════════
       ① Summary bar (title + stat cards + doc cards)
    ════════════════════ */
    .summary-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; flex-shrink: 0; overflow: hidden; }
    .summary-bar .summary-title-inline { font-weight: 700; color: hsl(214,32%,40%); white-space: nowrap; flex-shrink: 0; line-height: 1; }
    .summary-stat-card {
      background: #fff; border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 8px; box-sizing: border-box;
      display: flex; align-items: center; justify-content: center; white-space: nowrap;
    }
    .summary-stat-card .summary-card-text { font-weight: 700; color: #333; line-height: normal; }
    /* rl-summary-bar用（予約リストページ）旧スタイル維持 */
    .summary-stat-label { font-size: 10px; font-weight: 700; color: var(--foreground); line-height: 1.2; white-space: nowrap; margin-bottom: 2px; }
    .summary-stat-val { font-size: 18px; font-weight: 800; line-height: 1.1; }
    .summary-stat-res .summary-stat-val { color: var(--primary); }
    .summary-stat-avl .summary-stat-val { color: hsl(142,71%,40%); }
    .summary-stat-cnl .summary-stat-val { color: hsl(0,72%,51%); }
    .summary-doc-card { border-color: var(--border); }
    .summary-doc-card .summary-stat-label { font-weight: 700; color: var(--foreground); }
    .summary-doc-card .summary-stat-val { font-weight: 800; color: var(--foreground); }
    /* ════════════════════
       Section title (予約一覧タイトル)
    ════════════════════ */
    .summary-title { height: 28px; display: flex; align-items: center; overflow: hidden; margin-bottom: 5px; flex-shrink: 0; }
    .summary-title-text { display: inline-block; white-space: nowrap; font-weight: 700; color: hsl(214,32%,40%); line-height: 1; }
    /* ════════════════════
       Gantt card-header date
    ════════════════════ */
    .gantt-date-h2 { height: 28px; display: flex; align-items: center; overflow: hidden; margin: 0; }
    .gantt-date-text { display: inline-block; white-space: nowrap; font-weight: 800; color: hsl(222,47%,11%); line-height: 1; }

    /* ── Card ── */
    .card { background: #fff; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .card-header { padding: 9px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .card-header h2 { font-size: 13px; font-weight: 700; }
    .count-badge { background: var(--primary-light); color: var(--primary-dark); font-size: 11px; font-weight: 700; padding: 2px 9px; border-radius: 20px; }

    /* ── Placeholder ── */
    .placeholder { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; color: hsl(214,32%,60%); }
    .placeholder-icon { font-size: 50px; opacity: 0.35; }
    .placeholder-title { font-size: 18px; font-weight: 700; color: hsl(214,32%,50%); }
    .placeholder-sub { font-size: 13px; }

    /* ── Settings page ── */
    .settings-layout { display: flex; height: 100%; gap: 0; }
    .settings-sidebar { width: 190px; min-width: 190px; background: #fff; border: 1px solid var(--border); border-radius: 12px; overflow-y: auto; margin-right: 12px; }
    .stg-cat { padding: 10px 0; }
    .stg-cat-label { font-size: 14px; font-weight: 700; color: #111827; padding: 8px 16px 4px; }
    .stg-cat-item { display: flex; align-items: center; gap: 8px; padding: 9px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: #4b5563; border-left: 3px solid transparent; transition: all 0.12s; user-select: none; }
    .stg-cat-item:hover { background: #f9fafb; color: #1a1a1a; }
    .stg-cat-item.active { border-left-color: #3b82f6; background: #eff6ff; color: #1d4ed8; font-weight: 700; }
    .settings-content { flex: 1; overflow-y: auto; padding: 0 4px; }
    .stg-page-title { font-size: 17px; font-weight: 800; color: #1a1a1a; margin-bottom: 14px; }
    .stg-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 14px; }
    .stg-card-header { display: flex; align-items: center; justify-content: space-between; padding: 13px 18px; border-bottom: 1px solid #f0f0f0; }
    .stg-card-title { font-size: 14px; font-weight: 700; color: #1a1a1a; }
    .stg-card-note { font-size: 11px; color: #9ca3af; font-weight: 500; margin-left: 8px; }
    .stg-card-body { padding: 6px 18px; }
    .stg-row { display: flex; align-items: center; padding: 11px 0; border-bottom: 1px solid #f5f5f5; }
    .stg-row:last-child { border-bottom: none; }
    .stg-row-label { width: 220px; flex-shrink: 0; font-size: 13px; font-weight: 600; color: #6b7280; }
    .stg-row-value { flex: 1; font-size: 14px; font-weight: 500; color: #1a1a1a; }
    .stg-row-input { flex: 1; }
    .stg-row-input input, .stg-row-input select { width: 100%; max-width: 320px; padding: 7px 10px; border: 1.5px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: inherit; outline: none; }
    .stg-row-input input:focus, .stg-row-input select:focus { border-color: #3b82f6; }
    .stg-toggle { position: relative; width: 42px; height: 24px; border-radius: 12px; background: #d1d5db; cursor: pointer; transition: background 0.2s; border: none; padding: 0; }
    .stg-toggle.on { background: #3b82f6; }
    .stg-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 50%; background: #fff; transition: left 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .stg-toggle.on::after { left: 20px; }
    .stg-btn-edit { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; border: 1px solid #bdd8f0; background: #f0f7ff; color: #1a7fd4; }
    .stg-btn-edit:hover { background: #dceefb; }
    .stg-btn-save { padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit; border: none; background: #3b82f6; color: #fff; }
    .stg-btn-save:hover { background: #2563eb; }
    .stg-btn-cancel { padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; border: 1px solid #ddd; background: #f5f5f5; color: #666; }
    .stg-btn-cancel:hover { background: #e5e5e5; }
    .stg-actions { display: flex; gap: 8px; padding: 12px 18px; border-top: 1px solid #f0f0f0; justify-content: flex-end; }
    .stg-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #9ca3af; gap: 8px; }
    .stg-placeholder-icon { font-size: 36px; opacity: 0.4; }
    .stg-placeholder-text { font-size: 14px; font-weight: 600; }

    /* ════════════════════
       ② Gantt layout (no scroll)
    ════════════════════ */
    .dash-summary { flex-shrink: 0; }
    /* .dash-gap 削除済み */
    .dash-gantt { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .dash-gantt > .card { flex: 1; display: flex; flex-direction: column; min-height: 0; }

    /* Legend */
    .gantt-legend {
      display: flex; align-items: center; gap: 16px;
      padding: 6px 14px;
      border-bottom: 1px solid var(--border);
      background: hsl(210,40%,99%);
      flex-shrink: 0;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: hsl(214,32%,45%); }
    .legend-dot { display: inline-block; width: 11px; height: 11px; border-radius: 3px; }
    .legend-dot.lv { background: hsl(214,32%,87%); }
    .legend-dot.lr { background: linear-gradient(90deg, rgba(13,148,136,0.4) 0%, rgba(124,58,237,0.4) 50%, rgba(234,88,12,0.4) 100%); } /* ② doctor colors */
    .legend-dot.le { background: transparent; border: 1.5px dashed hsl(214,32%,72%); }
    .legend-dot.lp { background: #d1d5db; }                   /* ⑥ past empty */

    /* Scroll container — flex column, no overflow scroll */
    .gantt-scroll { flex: 1; display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; min-height: 0; }
    .gantt-session-wrap { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .gantt-session-bar {
      padding: 2px 10px;
      background: hsl(210,40%,97%);
      font-size: 10.5px; font-weight: 700; color: hsl(214,32%,48%);
      letter-spacing: 0.05em;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .gantt-session-inner { flex: 1; overflow: hidden; min-height: 0; }

    /* Gantt table — fills its container height */
    .gantt-table {
      border-collapse: separate;
      border-spacing: 2px;
      table-layout: fixed;
      width: 100%;
      height: 100%;
      padding: 2px 6px 4px;
    }
    .gantt-corner {
      width: 72px;
      padding: 4px 4px;
      background: hsl(210,40%,97%);
      border-radius: 6px;
      font-size: 9.5px; font-weight: 700; color: hsl(214,32%,50%);
      position: sticky; left: 0; z-index: 3;
      white-space: nowrap;
    }
    .gantt-time-th {
      padding: 4px 1px;
      text-align: center;
      font-weight: 700; color: #111;
      background: hsl(210,40%,97%);
      border-radius: 6px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      cursor: default;
      box-sizing: border-box;
      vertical-align: middle;
    }
    .time-th-text {
      display: inline-block;
      white-space: nowrap;
      font-weight: 700;
      color: #111;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      font-size: clamp(8px, 1vw, 12px);
    }
    /* 一括停止ボタン（カードヘッダー） */
    .btn-slot-control { padding: 5px 13px; border-radius: 20px; font-size: 12px; font-weight: 700; font-family: inherit; cursor: pointer; transition: all 0.12s; border: 1.5px solid; white-space: nowrap; }
    .btn-slot-control:disabled { opacity: 0.35; cursor: not-allowed; }
    .btn-slot-stop    { background: hsl(0,72%,96%);   color: hsl(0,72%,44%);   border-color: hsl(0,72%,78%); }
    .btn-slot-stop:not(:disabled):hover    { background: hsl(0,72%,51%);   color: #fff; border-color: hsl(0,72%,51%); }
    .btn-slot-unblock { background: hsl(142,71%,96%); color: hsl(142,55%,32%); border-color: hsl(142,71%,72%); }
    .btn-slot-unblock:not(:disabled):hover { background: hsl(142,71%,40%); color: #fff; border-color: hsl(142,71%,40%); }
    /* 枠選択モード */
    .gantt-selection-dim { background: hsl(214,32%,93%) !important; opacity: 0.4; pointer-events: none !important; cursor: default !important; }
    .gantt-selectable { cursor: pointer !important; pointer-events: auto !important; }
    .gantt-slot-selected { background: hsl(199,89%,82%) !important; border: 2px solid hsl(199,89%,45%) !important; }
    .gantt-slot-selected .gcell-add,
    .gantt-slot-selected .gcell-blocked { color: hsl(199,89%,28%); font-weight: 900; font-size: 16px; }
    /* 移動モード（ドラッグ方式） */
    .gantt-move-draggable { cursor: grab !important; border: 2px dashed var(--primary) !important; }
    .gantt-move-draggable:active { cursor: grabbing !important; }
    .gantt-move-drop-target { border: 2px dashed hsl(199,89%,48%) !important; background: hsl(199,89%,95%) !important; }
    .gantt-move-drop-hover { background: hsl(199,89%,85%) !important; border: 2px solid hsl(199,89%,48%) !important; }
    .gantt-move-dim { opacity: 0.5; pointer-events: none !important; cursor: default !important; }
    .drag-ghost { position: fixed; pointer-events: none; z-index: 9999; background: var(--primary); color: #fff; font-size: 13px; font-weight: 700; padding: 6px 14px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.18); white-space: nowrap; }
    .btn-move-enter { background: hsl(199,89%,93%); color: hsl(199,89%,35%); border-color: hsl(199,89%,70%); }
    .btn-move-enter:not(:disabled):hover { background: hsl(199,89%,48%); color: #fff; border-color: hsl(199,89%,48%); }
    .btn-move-active { background: #f59e0b !important; color: #fff !important; border-color: #f59e0b !important; }

    /* ⑤ Doctor name column — sticky, with tint bg set inline */
    .gantt-doc-td {
      width: 72px;
      height: 40px;
      padding: 4px 4px;
      position: sticky; left: 0; z-index: 2;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      box-sizing: border-box;
    }
    .gantt-doc-inner { display: flex; align-items: center; gap: 5px; }
    .gantt-doc-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .gantt-doc-name { font-weight: 800; line-height: 1.2; white-space: nowrap; }
    .gantt-doc-role { font-size: 9px; color: hsl(214,32%,55%); margin-top: 1px; }

    /* Slot cells */
    .gantt-cell {
      position: relative;
      text-align: center; vertical-align: middle;
      border-radius: 7px; cursor: pointer;
      transition: filter 0.1s, transform 0.08s;
      padding: 4px 2px;
      overflow: visible;
    }
    .gantt-cell:active { transform: scale(0.93); }

    /* ③ 来院済 → グレーアウト */
    .gantt-visited { background: hsl(214,32%,86%); }
    .gantt-visited:hover { filter: brightness(0.93); }
    .gantt-visited .gcell-name { color: #000000; }

    /* ② 予約済 — サマリーカードと同じ枠線 */
    .gantt-reserved { background: #ffffff; border: 1px solid var(--border); border-radius: 8px; }
    .gantt-reserved:hover { filter: brightness(0.92); }
    .gantt-reserved .gcell-name { color: #000000; }

    /* 未処理アラート — 予約済と同じ背景、名前は赤字 */
    .gantt-unprocessed { background: #ffffff !important; border: 1px solid var(--border) !important; border-radius: 8px !important; }
    .gantt-unprocessed .gcell-name { color: #ff0000 !important; font-weight: 800; }
    .gantt-unprocessed:hover { filter: brightness(0.93); }

    /* 上部アラートバー — 背景なし赤字テキスト */
    /* ④ cancelled → not rendered (shown as empty instead) */

    /* ⑥ 過去の空き枠 — gray, not clickable */
    .gantt-past-empty {
      background: hsl(214,32%,86%);
      pointer-events: none;
      cursor: default;
    }

    /* Empty cell — white bg */
    .gantt-empty {
      background: #fff;
      border: 1.5px dashed hsl(214,32%,72%);
      cursor: pointer;
    }
    .gantt-empty:hover { background: hsl(210,40%,97%); border-color: hsl(214,32%,48%); }

    /* Cell text */
    .gcell-name { display: block; font-weight: 700; line-height: 1.3; white-space: nowrap; overflow: visible; }
    .gcell-add { display: block; font-size: 20px; font-weight: 300; color: hsl(214,32%,55%); line-height: 1; transition: color 0.1s; }
    .gantt-empty:hover .gcell-add { color: hsl(214,32%,30%); }

    /* ════════════════════
       Modal
    ════════════════════ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.5);
      backdrop-filter: blur(3px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; pointer-events: none;
      transition: opacity 0.18s ease;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-card {
      background: #fff; border-radius: 22px;
      width: 460px; max-width: calc(100vw - 40px);
      padding: 28px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.22);
      transform: translateY(14px) scale(0.97);
      transition: transform 0.2s cubic-bezier(0.34,1.2,0.64,1);
    }
    .modal-overlay.open .modal-card { transform: translateY(0) scale(1); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; }
    .modal-title { font-size: 17px; font-weight: 800; }
    .modal-subtitle { font-size: 12px; color: hsl(214,32%,55%); margin-top: 3px; }
    .modal-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: hsl(214,32%,94%); cursor: pointer; display: flex; align-items: center; justify-content: center; color: hsl(214,32%,45%); font-size: 18px; line-height: 1; font-family: inherit; transition: background 0.1s; }
    .modal-close:hover { background: hsl(214,32%,86%); }
    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
    .info-table tr { border-bottom: 1px solid var(--border); }
    .info-table tr:last-child { border-bottom: none; }
    .info-table td { padding: 12px 4px; font-size: 13.5px; vertical-align: middle; }
    .info-table td:first-child { width: 100px; font-size: 12px; font-weight: 700; color: hsl(214,32%,52%); }
    .info-table td:last-child { font-weight: 600; }
    .modal-actions { display: flex; gap: 10px; margin-top: 22px; }
    .btn { flex: 1; padding: 13px 10px; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; border: none; font-family: inherit; transition: all 0.12s; }
    .btn-outline { background: #fff; border: 2px solid var(--border); color: var(--foreground); }
    .btn-outline:hover { border-color: hsl(214,32%,72%); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger { background: hsl(0,72%,51%); color: #fff; }
    .btn-danger:hover { background: hsl(0,72%,42%); }
    .btn-ghost { background: transparent; border: 2px solid var(--border); color: hsl(214,32%,52%); }
    .btn-ghost:hover { background: hsl(210,40%,97%); }
    .confirm-view { display: none; background: hsl(0,72%,97%); border: 1px solid hsl(0,72%,87%); border-radius: 14px; padding: 16px 18px; margin-top: 16px; font-size: 13.5px; color: hsl(0,60%,40%); line-height: 1.6; }
    .confirm-view.show { display: block; }
    .confirm-view strong { display: block; font-size: 14px; margin-bottom: 4px; }
    .input-label { font-size: 12.5px; font-weight: 700; color: hsl(214,32%,52%); margin-bottom: 6px; display: block; }
    .modal-input { width: 100%; padding: 13px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 18px; font-family: inherit; font-variant-numeric: tabular-nums; letter-spacing: 0.1em; outline: none; transition: border-color 0.15s; }
    .modal-input:focus { border-color: var(--primary); }
    .input-error { font-size: 12px; color: hsl(0,72%,45%); margin-top: 6px; min-height: 18px; }
    .booking-info { background: var(--primary-light); border-radius: 12px; padding: 14px 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px; }
    .booking-info-row { display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .booking-info-label { font-size: 11.5px; font-weight: 700; color: hsl(199,50%,45%); width: 56px; }
    .doctor-chip { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; color: #fff; }
    .status-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 16px; font-weight: 600; background: none; color: #000000; }
    .s-confirmed { }
    .s-done      { }
    .s-cancelled { }

    /* ④ 停止済みセル */
    .gantt-blocked { background: hsl(214,32%,86%); pointer-events: none; cursor: default; }
    .gcell-blocked { display: block; font-size: 10px; font-weight: 700; color: hsl(214,32%,42%); letter-spacing: 0.04em; }
    .legend-dot.ls { background: hsl(214,32%,78%); }
    /* ⑦-1 来院ボタン */
    .btn-success { background: hsl(142,71%,38%); color: #fff; }
    .btn-success:hover { background: hsl(142,71%,30%); }
    .btn-success:disabled { background: hsl(214,32%,82%); color: hsl(214,32%,50%); cursor: not-allowed; opacity: 1; }
    /* ⑦-2 診察券リンク */
    .card-link { background: none; border: none; cursor: pointer; font-size: 13.5px; font-weight: 700; font-family: inherit; color: var(--primary); text-decoration: underline; font-variant-numeric: tabular-nums; letter-spacing: 0.06em; padding: 0; }
    .card-link:hover { color: var(--primary-dark); }
    /* ④ 停止確認ビュー（warn色） */
    .confirm-view-warn { display: none; background: hsl(45,90%,97%); border: 1px solid hsl(45,90%,80%); border-radius: 14px; padding: 16px 18px; margin-top: 16px; font-size: 13.5px; color: hsl(35,60%,35%); line-height: 1.6; }
    .confirm-view-warn.show { display: block; }
    .confirm-view-warn strong { display: block; font-size: 14px; margin-bottom: 4px; }
    /* 患者詳細ページ */
    .pd-back { flex-shrink: 0; margin-bottom: 8px; }
    .pd-back-btn { background: none; border: none; cursor: pointer; font-size: 13px; font-weight: 600; color: hsl(214,32%,52%); font-family: inherit; padding: 4px 0; }
    .pd-back-btn:hover { color: var(--foreground); }
    .pd-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .pd-top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; }
    .pd-header-card { background: #fff; border: 1px solid var(--border); border-radius: 14px; padding: 20px 22px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    .pd-avatar { width: 52px; height: 52px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 800; flex-shrink: 0; }
    .pd-patient-name { font-size: 22px; font-weight: 800; }
    .pd-kana { font-size: 12px; color: hsl(214,32%,52%); margin-top: 2px; }
    .pd-card-num { font-size: 11px; color: hsl(214,32%,52%); margin-top: 4px; font-variant-numeric: tabular-nums; }
    .pd-info-card { background: #fff; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; flex-shrink: 0; }
    .pd-basic-grid { display: flex; flex-direction: column; }
    .pd-basic-row { display: flex; gap: 24px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    .pd-basic-row:last-child { border-bottom: none; }
    .pd-basic-half > .pd-basic-item { flex: 1; }
    .pd-basic-full > .pd-basic-item { flex: 1; }
    .pd-basic-item { display: flex; align-items: baseline; gap: 8px; }
    .pd-basic-label { font-size: 12px; font-weight: 600; color: #888; width: 100px; flex-shrink: 0; }
    .pd-basic-value { font-size: 16px; color: #1a1a1a; }
    /* ⑩ セクション見出し */
    .pd-section-title { font-size: 15px; font-weight: 800; color: #000000; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
    /* ⑩ カルテ画像 */
    .pd-charts-card { background: #fff; border: 1px solid var(--border); border-radius: 14px; padding: 16px 18px; flex-shrink: 0; }
    .charts-grid { display: flex; gap: 10px; flex-wrap: wrap; }
    .chart-thumb { width: 80px; height: 80px; border-radius: 10px; background: hsl(210,40%,94%); border: 2px solid hsl(210,40%,88%); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: border-color 0.12s, box-shadow 0.12s; }
    .chart-thumb:hover { border-color: var(--primary); box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
    .chart-thumb-label { font-size: 9.5px; font-weight: 700; color: hsl(214,32%,52%); text-align: center; }
    .chart-thumb-date  { font-size: 9px; color: hsl(214,32%,62%); }
    /* ⑩ 患者詳細 予約一覧 */
    .pd-reservations-card { background: #fff; border: 1px solid var(--border); border-radius: 14px; flex-shrink: 0; overflow: hidden; }
    .pd-res-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .pd-res-table th { padding: 9px 12px; font-size: 11px; font-weight: 700; color: hsl(214,32%,52%); background: hsl(210,40%,98%); text-align: left; border-bottom: 1px solid var(--border); }
    .pd-res-table td { padding: 10px 12px; border-bottom: 1px solid hsl(214,32%,94%); vertical-align: middle; font-size: 16px; }
    .pd-res-table tr:last-child td { border-bottom: none; }
    .btn-cancel-sm { padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; font-family: inherit; border: 1px solid #aaa; cursor: pointer; background: #fff; color: #ff0000; transition: opacity 0.12s; }
    .btn-cancel-sm:hover { opacity: 0.7; }
    .pd-notes-edit-btn { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 2px 10px; font-size: 11px; font-weight: 700; font-family: inherit; color: hsl(214,32%,52%); cursor: pointer; margin-left: 8px; transition: all 0.12s; }
    .pd-notes-edit-btn:hover { border-color: var(--primary); color: var(--primary); }
    .pd-notes-input { width: 100%; padding: 6px 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 13px; font-family: inherit; outline: none; }
    .pd-notes-save-btn { background: var(--primary); color: #fff; border: none; border-radius: 6px; padding: 4px 14px; font-size: 11px; font-weight: 700; font-family: inherit; cursor: pointer; margin-left: 6px; transition: background 0.12s; }
    .pd-notes-save-btn:hover { background: var(--primary-dark); }
    /* ⑨ 患者情報一覧ページ */
    .patient-list-wrap { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 10px; }
    .patient-search-bar { display: flex; gap: 8px; flex-shrink: 0; }
    .search-input { flex: 1; padding: 11px 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.15s; }
    .search-input:focus { border-color: var(--primary); }
    .patient-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .patient-table th { background: #f7f8fa; color: hsl(214,20%,55%); font-size: 11px; font-weight: 600; text-align: left; padding: 8px 10px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
    .patient-table td { padding: 10px 10px; font-size: 13px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
    .patient-table tr:last-child td { border-bottom: none; }
    .patient-table tbody tr { cursor: pointer; transition: background 0.1s; }
    .patient-table tbody tr:hover { background: #f8fbff; }
    .patient-table .pt-name { font-weight: 800; font-size: 16px; }
    .no-result { text-align: center; padding: 40px 0; color: hsl(214,32%,52%); font-size: 14px; }
    /* Lightbox */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .lightbox.open { opacity: 1; pointer-events: auto; }
    .lightbox-inner { position: relative; background: #fff; border-radius: 18px; padding: 28px 28px 20px; display: flex; flex-direction: column; align-items: center; }
    .lightbox-img { width: 320px; height: 240px; background: hsl(210,40%,92%); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .lightbox-icon { font-size: 80px; }
    .lightbox-caption { margin-top: 14px; font-size: 14px; font-weight: 700; color: hsl(214,32%,40%); }
    .lightbox-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; border: none; background: hsl(214,32%,94%); cursor: pointer; font-size: 18px; font-family: inherit; display: flex; align-items: center; justify-content: center; }
    .lightbox-close:hover { background: hsl(214,32%,86%); }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; background: hsl(222,47%,11%); color: #fff; padding: 12px 18px; border-radius: 12px; font-size: 13px; font-weight: 600; box-shadow: 0 8px 32px rgba(0,0,0,0.22); display: flex; align-items: center; gap: 9px; transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.2,0.64,1); z-index: 2000; pointer-events: none; }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* ═══ 予約一覧カレンダー ═══ */
    #rl-month-title { font-size: clamp(14px, 1.4vw, 18px); font-weight: 800; }
    .rl-dow-row {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 2px;
    }
    .rl-dow-cell {
      text-align: center; font-size: clamp(10px, 1.15vw, 15px); font-weight: 700; color: #111;
      padding: 4px 0; background: hsl(210,40%,97%); border-radius: 6px;
    }
    .rl-dow-sun { color: #111; }
    .rl-dow-sat { color: #111; }
    .rl-days-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;
    }
    .rl-day-cell {
      border-radius: 7px; padding: 2px 2px; text-align: center; height: clamp(54px, 5.8vw, 82px);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0px;
      border: 1px solid var(--border); transition: filter 0.1s, transform 0.08s;
      box-sizing: border-box;
    }
    .rl-day-cell:active { transform: scale(0.95); }
    .rl-day-empty { border-color: transparent; background: transparent; }
    /* 月〜金：白 */
    .rl-day-active { cursor: pointer; background: #fff; }
    .rl-day-active:hover { filter: brightness(0.95); border-color: var(--primary); }
    /* 土：薄い青 */
    .rl-day-active.rl-day-sat { background: hsl(210,80%,95%); }
    /* 日：薄いグレー（休診） */
    .rl-day-closed { background: hsl(220,10%,93%); cursor: default; border-color: hsl(220,10%,88%); }
    .rl-day-closed .rl-day-num { color: hsl(214,20%,70%); }
    .rl-day-closed .rl-day-label-closed { color: hsl(214,20%,70%); }
    /* 祝日：薄い赤背景、日付のみ赤（予約数は稼働率に応じて別途制御） */
    .rl-day-holiday { background: hsl(0,80%,95%) !important; border-color: hsl(0,60%,88%) !important; }
    .rl-day-holiday .rl-day-num { color: hsl(0,70%,50%); }
    /* 稼働率50%未満：予約数の文字色を赤に（日曜以外） */
    .rl-day-util-low .rl-count-val { color: hsl(0,70%,50%); }
    .rl-day-today { border: 2px solid var(--primary) !important; box-shadow: 0 2px 8px rgba(2,132,199,0.18); }
    /* 過去の日付：薄いグレー文字 */
    .rl-day-past .rl-day-num { color: hsl(214,20%,70%); }
    .rl-day-num { font-size: clamp(12px, 1.4vw, 18px); font-weight: 800; color: #111; line-height: 1.1; }
    .rl-day-count { display: flex; align-items: baseline; gap: 3px; font-variant-numeric: tabular-nums; }
    .rl-count-label { font-size: clamp(7px, 0.85vw, 11px); font-weight: 600; color: hsl(214,20%,60%); }
    .rl-count-val { font-size: clamp(11px, 1.4vw, 18px); font-weight: 800; color: #111; }
    .rl-count-total { font-size: clamp(8px, 1vw, 13px); font-weight: 700; color: #111; }
    .rl-day-past .rl-count-val { color: hsl(214,20%,70%); }
    .rl-day-past .rl-count-total { color: hsl(214,20%,70%); }
    .rl-day-past .rl-count-label { color: hsl(214,20%,78%); }
    .rl-day-label-closed { font-size: clamp(7px, 0.85vw, 11px); font-weight: 700; color: hsl(214,20%,70%); }
    .rl-nav-btn {
      padding: 5px 13px; border-radius: 20px; font-size: 12px; font-weight: 700;
      font-family: inherit; cursor: pointer; transition: all 0.12s;
      border: 1.5px solid var(--border); background: #fff; color: var(--foreground);
    }
    .rl-nav-btn:hover { border-color: var(--primary); color: var(--primary); }
    .rl-nav-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .rl-month-select {
      padding: 5px 10px; border-radius: 8px; border: 1.5px solid var(--border);
      font-size: 12px; font-weight: 700; font-family: inherit;
      color: var(--foreground); background: #fff; cursor: pointer; outline: none;
    }
    .rl-month-select:focus { border-color: var(--primary); }
    .rl-gantt-nav { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-shrink: 0; flex-wrap: wrap; }
    /* 月間KPIカード */
    .rl-kpi-bar {
      display: flex; gap: 6px; padding: 10px 14px 0; flex-shrink: 0; flex-wrap: wrap;
    }
    .rl-kpi-card {
      background: #fff; border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 6px; flex: 1; min-width: 70px; box-sizing: border-box;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .rl-kpi-label { font-size: 11px; font-weight: 700; color: var(--foreground); line-height: 1.2; white-space: nowrap; margin-bottom: 1px; }
    .rl-kpi-val { font-size: 22px; font-weight: 800; line-height: 1.1; color: #333333; }

    /* ═══ 診療カレンダー ═══ */
    .cal-section { background: #fff; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; }
    .cal-section-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--border); }
    .cal-section-title { font-size: 16px; font-weight: 700; color: #1a1a1a; margin: 0; }
    .cal-section-body { padding: 20px; }
    .cal-row { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .cal-row:last-child { border-bottom: none; }
    .cal-row-label { font-size: 13px; font-weight: 600; color: #888; width: 100px; flex-shrink: 0; }
    .cal-row-content { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .cal-day-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #e0e0e0; background: #f0f0f0; font-size: 13px; font-weight: 700; color: #999; cursor: default; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .cal-day-btn.active { background: #1a7fd4; color: #fff; border-color: #1a7fd4; }
    .cal-day-btn.editing { cursor: pointer; }
    .cal-day-btn.editing:hover { opacity: 0.8; }
    .cal-time-input { width: 48px; height: 32px; border: 1px solid #d0d0d0; border-radius: 6px; text-align: center; font-size: 14px; font-weight: 600; color: #1a1a1a; background: #fff; font-family: inherit; }
    .cal-time-input:focus { outline: none; border-color: #1a7fd4; }
    .cal-time-input[readonly] { background: #f8f8f8; border-color: transparent; color: #1a1a1a; }
    .cal-time-unit { font-size: 13px; color: #666; }
    .cal-time-sep { font-size: 14px; color: #888; margin: 0 6px; font-weight: 700; }
    .cal-time-label { font-size: 13px; color: #555; font-weight: 600; margin-right: 6px; min-width: 28px; }
    .cal-holiday-wrap { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .cal-holiday-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; background: #fee2e2; color: #dc2626; border-radius: 16px; font-size: 12px; font-weight: 600; }
    .cal-holiday-x { cursor: pointer; font-weight: 800; font-size: 14px; line-height: 1; }
    .cal-holiday-x:hover { color: #991b1b; }
    .cal-extra-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; background: #dcfce7; color: #16a34a; border-radius: 16px; font-size: 12px; font-weight: 600; }
    .cal-extra-badge .cal-holiday-x:hover { color: #166534; }
    /* Warning modal */
    .warn-modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.5); backdrop-filter: blur(3px); display: flex; align-items: center; justify-content: center; z-index: 1100; }
    .warn-modal-box { background: #fff; border-radius: 16px; padding: 28px; box-shadow: 0 24px 64px rgba(0,0,0,0.22); min-width: 340px; max-width: 440px; text-align: center; }
    .warn-modal-text { font-size: 15px; font-weight: 600; color: #1a1a1a; margin-bottom: 22px; line-height: 1.6; }
    .warn-modal-actions { display: flex; gap: 10px; justify-content: center; }
    .warn-modal-actions button { flex: 1; padding: 11px 10px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; border: none; font-family: inherit; transition: all 0.12s; }
    .warn-modal-cancel { background: #fff; border: 2px solid #e5e7eb !important; color: #374151; }
    .warn-modal-cancel:hover { border-color: #9ca3af !important; }
    .warn-modal-confirm { background: #dc2626; color: #fff; }
    .warn-modal-confirm:hover { background: #b91c1c; }
    /* Doctor schedule time inputs in edit mode */
    .ds-time-input { width: 80px; min-width: 80px; height: 28px; border: 1px solid #d0d0d0; border-radius: 5px; text-align: center; font-size: 12px; font-weight: 600; color: #1a1a1a; background: #fff; font-family: inherit; padding: 0 4px; box-sizing: border-box; }
    .ds-time-input:focus { outline: none; border-color: #3b82f6; }
    .ds-kyushin-btn { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid #fca5a5; background: #fef2f2; color: #dc2626; font-family: inherit; }
    .ds-kyushin-btn:hover { background: #fee2e2; }
    .ds-kaijo-btn { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid #bbb; background: #f5f5f5; color: #555; font-family: inherit; }
    .ds-kaijo-btn:hover { background: #e5e5e5; }
    /* Inline add doctor form */
    .doc-add-form { border: 2px solid #3b82f6; border-radius: 14px; padding: 20px; margin-top: 0; }
    .doc-add-form .doc-add-field { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .doc-add-form .doc-add-label { font-size: 13px; font-weight: 600; color: #888; width: 80px; flex-shrink: 0; }
    .doc-add-form .doc-add-input { flex: 1; padding: 8px 12px; border: 1.5px solid #d0d0d0; border-radius: 8px; font-size: 14px; font-family: inherit; outline: none; }
    .doc-add-form .doc-add-input:focus { border-color: #3b82f6; }
    .doc-add-form .doc-add-select { padding: 8px 12px; border: 1.5px solid #d0d0d0; border-radius: 8px; font-size: 14px; font-family: inherit; outline: none; background: #fff; }
    .doc-add-form .doc-add-select:focus { border-color: #3b82f6; }
    .cal-btn-add { padding: 5px 14px; border: 1.5px dashed #bbb; border-radius: 8px; background: none; font-size: 13px; color: #1a7fd4; cursor: pointer; font-weight: 600; font-family: inherit; }
    .cal-btn-add:hover { background: #f0f7ff; border-color: #1a7fd4; }
    /* Mini calendar */
    .mini-cal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .mini-cal-box { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); min-width: 300px; }
    .mini-cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .mini-cal-title { font-size: 15px; font-weight: 700; }
    .mini-cal-nav { border: none; background: none; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 6px; color: #555; font-family: inherit; }
    .mini-cal-nav:hover { background: #f0f0f0; }
    .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
    .mini-cal-dow { font-size: 11px; font-weight: 600; color: #888; padding: 4px 0; }
    .mini-cal-day { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 13px; cursor: pointer; border: none; background: none; font-family: inherit; }
    .mini-cal-day:hover { background: #e8f4fd; }
    .mini-cal-day.today { font-weight: 800; color: #1a7fd4; }
    .mini-cal-day.selected { background: #dc2626; color: #fff; font-weight: 700; }
    .mini-cal-day.selected:hover { background: #b91c1c; }
    .mini-cal-day.selected-green { background: #16a34a; color: #fff; font-weight: 700; }
    .mini-cal-day.selected-green:hover { background: #15803d; }
    .mini-cal-day.empty { cursor: default; pointer-events: none; }
    .mini-cal-day.sunday { color: #dc2626; }
    .mini-cal-day.saturday { color: #2563eb; }
    /* Doctor cards */
    .doc-card { border-top: 1px solid var(--border); padding: 20px; }
    .doc-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .doc-card-info { display: flex; align-items: baseline; gap: 10px; }
    .doc-card-name { font-size: 16px; font-weight: 700; color: #1a1a1a; }
    .doc-card-role { font-size: 12px; color: #888; font-weight: 600; }
    .doc-card-actions { display: flex; gap: 8px; }
    .doc-sched-wrap { overflow-x: auto; margin-bottom: 14px; }
    .doc-sched-table { border-collapse: collapse; table-layout: auto; }
    .doc-sched-table th, .doc-sched-table td { padding: 8px 12px; text-align: center; font-size: 13px; border: 1px solid #e8e8e8; white-space: nowrap; }
    .doc-sched-table th:first-child { width: 48px; }
    .doc-sched-table th { background: #f7f8fa; color: #888; font-weight: 600; font-size: 11px; }
    .doc-sched-table td { color: #1a1a1a; font-weight: 500; min-width: 185px; }
    .doc-sched-off { color: #ccc !important; font-weight: 400 !important; }
    .doc-btn-sm { padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; border: 1px solid; }
    .doc-btn-edit { background: #f0f7ff; color: #1a7fd4; border-color: #bdd8f0; }
    .doc-btn-edit:hover { background: #dceefb; }
    .doc-btn-del { background: #fff; color: #dc2626; border-color: #f0c0c0; }
    .doc-btn-del:hover { background: #fef2f2; }
    .doc-btn-save { background: #1a7fd4; color: #fff; border-color: #1a7fd4; }
    .doc-btn-save:hover { background: #1569b0; }
  </style>
</head>
<body>

<!-- ════════ SIDEBAR ════════ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="clinic-name" id="sidebar-clinic-name">〇〇接骨院</div>
    <div class="admin-label">管理画面</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item active" onclick="nav('dashboard',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/>
        <rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/>
      </svg>ダッシュボード
    </div>
    <div class="nav-item" data-navid="list" onclick="nav('list',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/>
        <line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/>
      </svg>予約一覧
    </div>
    <div class="nav-item" data-navid="patient-list" onclick="nav('patient-list',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>
      </svg>患者情報
    </div>
    <div class="nav-item" onclick="nav('schedule',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
      </svg>診療カレンダー
    </div>
    <div class="nav-item" onclick="nav('analytics',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
      </svg>統計・分析
    </div>
    <div class="nav-item" data-navid="settings" onclick="nav('settings',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1.08-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1.08 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001.08 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09c-.658.003-1.25.396-1.51 1z"/>
      </svg>設定
    </div>
  </nav>
  <div class="sidebar-footer">
    <button class="logout-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
        <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
      </svg>ログアウト
    </button>
  </div>
</aside>

<!-- ════════ MAIN ════════ -->
<div class="main">
  <header class="topbar">
    <span class="topbar-title" id="page-title">ダッシュボード</span>
    <div class="topbar-right">
      <span class="date-badge" id="topbar-date"></span>
      <div class="user-avatar">管</div>
    </div>
  </header>

  <div class="content">

    <!-- ══ DASHBOARD ══ -->
    <div id="page-dashboard" class="page active">

      <!-- 休診日メッセージ（日曜日のみ表示） -->
      <div id="dash-closed-message" style="display:none;flex:1;align-items:center;justify-content:center;">
        <span style="font-size:22px;font-weight:800;color:hsl(214,32%,52%);">本日は休診日です</span>
      </div>
      <!-- ② ガントチャート (flex:1, no scroll) -->
      <div class="dash-gantt" id="dash-gantt-area">
        <div class="summary-bar" id="dash-summary-bar">
          <span class="summary-title-inline">本日の予約一覧</span>
          <div class="summary-stat-card"><span class="summary-card-text">予約数　<span id="stat-reservations">—</span></span></div>
          <div class="summary-stat-card"><span class="summary-card-text">稼働率　<span id="stat-utilization">—</span></span></div>
          <div class="summary-stat-card"><span class="summary-card-text">キャンセル　<span id="stat-cancelled">—</span></span></div>
          <div class="summary-stat-card"><span class="summary-card-text">田中　<span id="occ-tanaka-r">—</span></span></div>
          <div class="summary-stat-card"><span class="summary-card-text">鈴木　<span id="occ-suzuki-r">—</span></span></div>
          <div class="summary-stat-card"><span class="summary-card-text">佐藤　<span id="occ-sato-r">—</span></span></div>
          <span id="dash-unprocessed-alert" style="display:none;align-items:center;gap:4px;font-size:clamp(10px, 1.5vw, 22px);font-weight:700;color:#ff0000;margin-left:8px;white-space:nowrap;flex-shrink:0;">
            <span>&#9888;</span>
            <span>未処理の予約があります</span>
            <span id="dash-unprocessed-count">0</span>
            <span>件</span>
          </span>
        </div>
        <div class="card">
          <div class="card-header">
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <h2 class="gantt-date-h2"><span class="gantt-date-text" id="dash-gantt-date"></span></h2>
              <!-- 通常モード -->
              <div id="gantt-normal-controls" style="display:flex;align-items:center;gap:6px;">
                <button class="btn-slot-control btn-move-enter" id="btn-enter-move" onclick="enterDragMoveMode()">予約枠を移動する</button>
                <button class="btn-slot-control btn-slot-stop"    onclick="enterBlockMode('stop')">予約枠停止</button>
                <button class="btn-slot-control btn-slot-unblock" onclick="enterBlockMode('unblock')">予約枠停止解除</button>
              </div>
              <!-- 選択モード -->
              <div id="gantt-select-controls" style="display:none;align-items:center;gap:8px;">
                <span id="gantt-select-label" style="font-size:12px;font-weight:700;">停止モード：枠を選択</span>
                <button class="btn-slot-control btn-slot-stop" id="btn-execute-block" onclick="executeBlockMode()" disabled>0枠を停止</button>
                <button class="btn-slot-control btn-slot-stop" id="btn-bulk-all" onclick="executeBulkAll()">一括停止</button>
                <button class="btn-slot-control" style="background:hsl(214,32%,96%);color:hsl(214,32%,44%);border-color:hsl(214,32%,78%);" onclick="cancelBlockMode()">キャンセル</button>
              </div>
              <!-- 移動モード -->
              <div id="gantt-move-controls" style="display:none;align-items:center;gap:8px;">
                <button class="btn-slot-control btn-move-active" id="btn-move-active">移動モード中</button>
                <span id="gantt-move-label" style="font-size:12px;font-weight:700;color:#f59e0b;">移動したい予約枠をドラッグしてください</span>
                <button class="btn-slot-control" style="background:hsl(214,32%,96%);color:hsl(214,32%,44%);border-color:hsl(214,32%,78%);" onclick="cancelDragMoveMode()">閉じる</button>
              </div>
            </div>
          </div>

          <!-- ③④ 凡例：キャンセル除去、来院済→グレー -->
          <div class="gantt-legend">
            <span class="legend-item"><span class="legend-dot lv"></span>来院済</span>
            <span class="legend-item"><span class="legend-dot le"></span>予約可</span>

          </div>

          <div class="gantt-scroll">
            <!-- ② Morning section -->
            <div class="gantt-session-wrap">
              <div class="gantt-session-bar">── 午前診（09:00〜12:40）</div>
              <div class="gantt-session-inner" id="gantt-morning"></div>
            </div>
            <!-- ② Afternoon section -->
            <div class="gantt-session-wrap">
              <div class="gantt-session-bar">── 午後診（16:00〜19:40）</div>
              <div class="gantt-session-inner" id="gantt-afternoon"></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /dashboard -->

    <!-- Placeholder pages -->
    <div id="page-list" class="page">
      <!-- Calendar View -->
      <div id="list-calendar-view" style="display:flex;flex-direction:column;height:100%;">
        <div class="card" style="flex:1;display:flex;flex-direction:column;">
          <div class="card-header">
            <h2 id="rl-month-title" style="font-size:22px;font-weight:800;">2026年2月</h2>
            <div style="display:flex;align-items:center;gap:6px;">
              <select class="rl-month-select" id="rl-month-select" onchange="rlGoToMonth()"></select>
              <button class="rl-nav-btn" id="rl-prev-btn" onclick="rlPrevMonth()">←</button>
              <button class="rl-nav-btn" id="rl-next-btn" onclick="rlNextMonth()">→</button>
            </div>
          </div>
          <div style="flex:1;overflow-y:auto;padding:10px 14px;">
            <div id="rl-calendar-grid"></div>
          </div>
        </div>
        <div class="rl-kpi-bar" id="rl-kpi-bar">
          <div class="rl-kpi-card rl-kpi-reservations">
            <div class="rl-kpi-label">月間予約数</div>
            <div class="rl-kpi-val" id="rl-kpi-reservations">—</div>
          </div>
          <div class="rl-kpi-card rl-kpi-sameday">
            <div class="rl-kpi-label">当日予約数</div>
            <div class="rl-kpi-val" id="rl-kpi-sameday">—</div>
          </div>
          <div class="rl-kpi-card rl-kpi-utilization">
            <div class="rl-kpi-label">稼働率</div>
            <div class="rl-kpi-val" id="rl-kpi-utilization">—</div>
          </div>
          <div class="rl-kpi-card rl-kpi-cancel">
            <div class="rl-kpi-label">キャンセル率</div>
            <div class="rl-kpi-val" id="rl-kpi-cancel">—</div>
          </div>
          <div class="rl-kpi-card rl-kpi-repeat">
            <div class="rl-kpi-label">リピート率</div>
            <div class="rl-kpi-val" id="rl-kpi-repeat">—</div>
          </div>
          <div class="rl-kpi-card rl-kpi-new">
            <div class="rl-kpi-label">新患数</div>
            <div class="rl-kpi-val" id="rl-kpi-new">—</div>
          </div>
        </div>
      </div>
      <!-- Gantt View -->
      <div id="list-gantt-view" style="display:none;flex-direction:column;height:100%;">
        <div class="rl-gantt-nav" style="flex-wrap:nowrap;">
          <button class="rl-nav-btn" id="rl-prev-day" onclick="rlPrevDay()" style="flex-shrink:0;">← 前日</button>
          <button class="rl-nav-btn" id="rl-next-day" onclick="rlNextDay()" style="flex-shrink:0;">→ 翌日</button>
          <div id="rl-summary-bar" style="display:flex;align-items:center;gap:6px;margin-left:8px;flex-wrap:nowrap;flex-shrink:1;min-width:0;overflow:hidden;">
            <div class="summary-stat-card"><span class="summary-card-text">予約数　<span id="rl-stat-reservations">—</span></span></div>
            <div class="summary-stat-card"><span class="summary-card-text">稼働率　<span id="rl-stat-utilization">—</span></span></div>
            <div class="summary-stat-card"><span class="summary-card-text">田中　<span id="rl-occ-tanaka">—</span></span></div>
            <div class="summary-stat-card"><span class="summary-card-text">鈴木　<span id="rl-occ-suzuki">—</span></span></div>
            <div class="summary-stat-card"><span class="summary-card-text">佐藤　<span id="rl-occ-sato">—</span></span></div>
          </div>
          <span id="rl-unprocessed-alert" style="display:none;align-items:center;gap:4px;font-size:clamp(10px, 1.5vw, 22px);font-weight:700;color:#ff0000;margin-left:8px;white-space:nowrap;flex-shrink:0;">
            <span>&#9888;</span>
            <span>未処理の予約があります</span>
            <span id="rl-unprocessed-count">0</span>
            <span>件</span>
          </span>
          <button class="rl-nav-btn" onclick="rlBackToCalendar()" style="margin-left:auto;flex-shrink:0;">月一覧に戻る</button>
        </div>
        <div class="dash-gantt" style="flex:1;">
          <div class="card" style="flex:1;display:flex;flex-direction:column;min-height:0;">
            <div class="card-header">
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <h2 class="gantt-date-h2"><span class="gantt-date-text" id="rl-gantt-date">—</span></h2>
                <div id="rl-gantt-normal-controls" style="display:flex;align-items:center;gap:6px;">
                  <button class="btn-slot-control btn-move-enter" id="rl-btn-enter-move" onclick="enterDragMoveMode()">予約枠を移動する</button>
                  <button class="btn-slot-control btn-slot-stop" onclick="enterBlockMode('stop')">予約枠停止</button>
                  <button class="btn-slot-control btn-slot-unblock" onclick="enterBlockMode('unblock')">予約枠停止解除</button>
                </div>
                <div id="rl-gantt-select-controls" style="display:none;align-items:center;gap:8px;">
                  <span id="rl-gantt-select-label" style="font-size:12px;font-weight:700;">停止モード：枠を選択</span>
                  <button class="btn-slot-control btn-slot-stop" id="rl-btn-execute-block" onclick="executeBlockMode()" disabled>0枠を停止</button>
                  <button class="btn-slot-control btn-slot-stop" id="rl-btn-bulk-all" onclick="executeBulkAll()">一括停止</button>
                  <button class="btn-slot-control" style="background:hsl(214,32%,96%);color:hsl(214,32%,44%);border-color:hsl(214,32%,78%);" onclick="cancelBlockMode()">キャンセル</button>
                </div>
                <!-- 移動モード -->
                <div id="rl-gantt-move-controls" style="display:none;align-items:center;gap:8px;">
                  <button class="btn-slot-control btn-move-active" id="rl-btn-move-active">移動モード中</button>
                  <span id="rl-gantt-move-label" style="font-size:12px;font-weight:700;color:#f59e0b;">移動したい予約枠をドラッグしてください</span>
                  <button class="btn-slot-control" style="background:hsl(214,32%,96%);color:hsl(214,32%,44%);border-color:hsl(214,32%,78%);" onclick="cancelDragMoveMode()">閉じる</button>
                </div>
              </div>
            </div>
            <div class="gantt-legend">
              <span class="legend-item"><span class="legend-dot lv"></span>来院済</span>
              <span class="legend-item"><span class="legend-dot le"></span>予約可</span>
  
            </div>
            <div class="gantt-scroll">
              <div class="gantt-session-wrap">
                <div class="gantt-session-bar">── 午前診（09:00〜12:40）</div>
                <div class="gantt-session-inner" id="rl-gantt-morning"></div>
              </div>
              <div class="gantt-session-wrap">
                <div class="gantt-session-bar">── 午後診（16:00〜19:40）</div>
                <div class="gantt-session-inner" id="rl-gantt-afternoon"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="page-schedule" class="page" style="overflow-y:auto;">
      <!-- 院の基本設定 -->
      <div class="cal-section">
        <div class="cal-section-header">
          <div class="cal-section-title">院の基本設定</div>
          <button class="doc-btn-sm doc-btn-edit" id="cs-edit-btn" onclick="csEditing ? editClinicSettings() : requireAuthIfNeeded('editClinic', editClinicSettings)">編集</button>
        </div>
        <div class="cal-section-body" id="cs-body"></div>
      </div>
      <!-- 担当医一覧 -->
      <div class="cal-section">
        <div class="cal-section-header">
          <div class="cal-section-title">担当医一覧</div>
          <button class="cal-btn-add" onclick="requireAuthIfNeeded('editDoctor', addNewDoctor)">＋担当医を追加する</button>
        </div>
        <div id="doc-cards-container"></div>
      </div>
      <!-- ミニカレンダーポップアップ -->
      <div id="mini-cal-popup" style="display:none;" class="mini-cal-overlay" onclick="if(event.target===this)closeMiniCal()"></div>
      <div id="warn-modal" style="display:none;"></div>
    </div>
    <div id="page-analytics" class="page"><div class="placeholder"><div class="placeholder-icon">📊</div><div class="placeholder-title">統計・分析</div><div class="placeholder-sub">予約数・稼働率・患者動向などの統計データを分析します</div></div></div>

    <!-- 設定ページ -->
    <div id="page-settings" class="page">
      <div class="settings-layout">
        <div class="settings-sidebar">
          <div class="stg-cat">
            <div class="stg-cat-label">基本</div>
            <div class="stg-cat-item active" onclick="stgNav(this,'clinic-info')">院の基本情報</div>
          </div>
          <div class="stg-cat">
            <div class="stg-cat-label">予約</div>
            <div class="stg-cat-item" onclick="stgNav(this,'booking')">予約・予約取消設定</div>
            <div class="stg-cat-item" onclick="stgNav(this,'notify')">通知設定</div>
          </div>
          <div class="stg-cat">
            <div class="stg-cat-label">受付アプリ</div>
            <div class="stg-cat-item" onclick="stgNav(this,'reception')">受付画面設定</div>
          </div>
          <div class="stg-cat">
            <div class="stg-cat-label">患者情報</div>
            <div class="stg-cat-item" onclick="stgNav(this,'patient-num')">患者番号・カルテ設定</div>
          </div>
          <div class="stg-cat">
            <div class="stg-cat-label">アカウント</div>
            <div class="stg-cat-item" onclick="stgNav(this,'security')">セキュリティ</div>
          </div>
          <div class="stg-cat">
            <div class="stg-cat-label">データ</div>
            <div class="stg-cat-item" onclick="stgNav(this,'export')">統計・エクスポート</div>
          </div>
        </div>
        <div class="settings-content" id="settings-content"></div>
      </div>
    </div>

    <!-- ⑦-2 患者詳細ページ -->
    <div id="page-patient-detail" class="page">
      <div class="pd-back">
        <button class="pd-back-btn" id="pd-back-btn" onclick="navBack()">← ダッシュボードに戻る</button>
      </div>
      <div class="pd-content">
        <!-- 上段：左右2列 -->
        <div class="pd-top-row">
          <!-- 左：基本情報 -->
          <div class="pd-info-card" style="padding:16px 18px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div class="pd-section-title" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">基本情報</div>
              <button class="pd-notes-edit-btn" id="pd-edit-btn" onclick="editBasicInfo()">編集</button>
              <button class="pd-notes-save-btn" id="pd-save-btn" style="display:none;" onclick="saveBasicInfo()">保存</button>
            </div>
            <div class="pd-basic-grid">
              <div class="pd-basic-row pd-basic-half">
                <div class="pd-basic-item"><div class="pd-basic-label">氏名</div><div class="pd-basic-value" id="pd-name" style="font-weight:700;">—</div></div>
                <div class="pd-basic-item"><div class="pd-basic-label">ふりがな</div><div class="pd-basic-value" id="pd-kana">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">診察券番号</div><div class="pd-basic-value" id="pd-card" style="font-variant-numeric:tabular-nums;font-weight:700;">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-half">
                <div class="pd-basic-item"><div class="pd-basic-label">生年月日</div><div class="pd-basic-value" id="pd-dob">—</div></div>
                <div class="pd-basic-item"><div class="pd-basic-label">性別</div><div class="pd-basic-value" id="pd-gender">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">郵便番号</div><div class="pd-basic-value" id="pd-zip">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">住所</div><div class="pd-basic-value" id="pd-address">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">電話番号</div><div class="pd-basic-value" id="pd-phone" style="font-variant-numeric:tabular-nums;">—</div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">最終来院日</div><div class="pd-basic-value" id="pd-lastVisit">— <span style="font-size:10px;color:hsl(214,32%,52%);">※履歴から自動反映</span></div></div>
              </div>
              <div class="pd-basic-row pd-basic-full">
                <div class="pd-basic-item"><div class="pd-basic-label">備考</div><div class="pd-basic-value" id="pd-notes">—</div></div>
              </div>
            </div>
          </div>
          <!-- 右：カルテ（仮） -->
          <div class="pd-charts-card">
            <div class="pd-section-title">カルテ（仮）</div>
            <div class="charts-grid" id="pd-charts-grid"></div>
          </div>
        </div>
        <!-- 下段：過去来院履歴 -->
        <div class="pd-reservations-card">
          <div style="padding:12px 18px 6px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;" onclick="togglePastVisits()">
            <div class="pd-section-title" style="margin-bottom:0;padding-bottom:0;border-bottom:none;">過去来院履歴</div>
            <span id="pd-past-toggle" style="font-size:12px;font-weight:700;color:hsl(214,32%,52%);">▶ 開く</span>
          </div>
          <div id="pd-past-visits-wrap" style="display:none;">
            <table class="pd-res-table">
              <thead>
                <tr>
                  <th style="width:1%;white-space:nowrap;">日時</th>
                  <th style="width:15%;">担当医</th>
                  <th style="width:auto;">予約番号</th>
                </tr>
              </thead>
              <tbody id="pd-past-list"></tbody>
            </table>
          </div>
        </div>
        <!-- 下段：予約一覧 -->
        <div class="pd-reservations-card">
          <div style="padding:12px 18px 6px;"><div class="pd-section-title">予約一覧</div></div>
          <table class="pd-res-table">
            <thead>
              <tr>
                <th style="width:1%;white-space:nowrap;">日時</th>
                <th style="width:10%;">担当医</th>
                <th style="width:10%;">予約番号</th>
                <th style="width:10%;">ステータス</th>
                <th style="width:10%;">操作</th>
                <th style="width:40%;"></th>
              </tr>
            </thead>
            <tbody id="pd-res-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ⑨ 患者情報一覧ページ -->
    <div id="page-patient-list" class="page">
      <div class="patient-list-wrap">
        <div class="patient-search-bar" style="display:flex;align-items:center;gap:8px;justify-content:flex-start;">
          <input class="search-input" id="pl-search" type="text"
                 placeholder="診察券番号または名前（かな）で検索"
                 oninput="searchPatients()" style="flex:none;width:30%;" />
          <button class="btn btn-primary" style="flex:none;white-space:nowrap;font-size:13px;padding:10px 16px;border-radius:12px;" onclick="openNewPatient()">＋ 新しい患者を追加する</button>
        </div>
        <table class="patient-table">
          <thead>
            <tr><th style="width:15%;">患者名</th><th style="width:15%;">よみがな</th><th style="width:15%;">診察券番号</th><th style="width:20%;">最終来院日</th><th style="width:35%;"></th></tr>
          </thead>
          <tbody id="patient-card-list"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ════════ MODAL: 予約詳細 ════════ -->
<div class="modal-overlay" id="modal-detail" onclick="overlayClick(event,'modal-detail')">
  <div class="modal-card">
    <div class="modal-header">
      <div><div class="modal-title">予約詳細</div><div class="modal-subtitle">患者情報・予約内容を確認できます</div></div>
      <button class="modal-close" onclick="closeDetail()">×</button>
    </div>
    <table class="info-table">
      <tr><td>患者名</td><td id="d-name" style="font-size:16px;font-weight:800;">—</td></tr>
      <tr><td>診察券番号</td><td id="d-card" style="font-variant-numeric:tabular-nums;letter-spacing:0.06em;">—</td></tr>
      <tr><td>予約日時</td><td id="d-time">—</td></tr>
      <tr><td>担当医</td><td id="d-doctor">—</td></tr>
      <tr><td>ステータス</td><td id="d-status">—</td></tr>
    </table>
    <div class="confirm-view" id="cancel-confirm-view">
      <strong>⚠️ キャンセルの確認</strong>
      この予約をキャンセルします。操作は取り消せません。本当によろしいですか？
    </div>
    <div class="confirm-view" id="purge-confirm-view">
      <strong>⚠️ 全て取消の確認</strong>
      来院済みの記録と予約を完全に取り消します。この操作は元に戻せません。
    </div>
    <div class="modal-actions" id="detail-actions-normal">
      <button class="btn btn-success" id="btn-arrival" onclick="handleArrival()">来院</button>
      <button class="btn btn-danger" id="btn-cancel" onclick="handleCancel()">予約取消</button>
    </div>
    <div class="modal-actions" id="detail-actions-visited" style="display:none;">
      <button class="btn btn-danger" id="btn-purge" onclick="handlePurge()">全て取消</button>
    </div>
  </div>
</div>

<!-- ════════ MODAL: 予約追加 ════════ -->
<div class="modal-overlay" id="modal-booking" onclick="overlayClick(event,'modal-booking')">
  <div class="modal-card">
    <div class="modal-header">
      <div><div class="modal-title">予約を追加</div><div class="modal-subtitle">空き枠に新しい予約を登録します</div></div>
      <button class="modal-close" onclick="closeBooking()">×</button>
    </div>
    <div class="booking-info">
      <div class="booking-info-row"><span class="booking-info-label">日時</span><span id="b-time" style="font-weight:700;font-size:14px;">—</span></div>
      <div class="booking-info-row"><span class="booking-info-label">担当医</span><span id="b-doctor">—</span></div>
    </div>
    <label class="input-label" for="b-card">診察券番号</label>
    <input class="modal-input" id="b-card" type="tel" inputmode="numeric" placeholder="例：00001"
           maxlength="10" oninput="clearBookingError()" onkeydown="if(event.key==='Enter')confirmBooking()">
    <div class="input-error" id="b-error"></div>
    <div id="b-patient-name" style="display:none;margin-top:8px;padding:10px 14px;background:hsl(142,71%,96%);border:1px solid hsl(142,71%,78%);border-radius:10px;font-size:14px;font-weight:700;color:hsl(142,55%,28%);">
      <span style="font-size:11px;font-weight:600;color:hsl(142,55%,40%);display:block;margin-bottom:2px;">患者名</span>
      <span id="b-patient-name-text"></span>
    </div>
    <div class="confirm-view" id="booking-confirm-view">
      <strong>⚠️ 予約内容の確認</strong>
      上記の内容で予約を登録します。よろしいですか？
    </div>
    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn btn-ghost" onclick="closeBooking()">閉じる</button>
      <button class="btn btn-primary" id="btn-confirm-booking" onclick="confirmBooking()">確認</button>
    </div>
  </div>
</div>

<!-- ════════ MODAL: 空き枠アクション選択 ════════ -->
<div class="modal-overlay" id="modal-slot-action" onclick="overlayClick(event,'modal-slot-action')">
  <div class="modal-card">
    <div class="modal-header">
      <div><div class="modal-title">空き枠の操作</div><div class="modal-subtitle" id="sa-info">—</div></div>
      <button class="modal-close" onclick="closeSlotAction()">×</button>
    </div>
    <div class="confirm-view-warn" id="stop-confirm-view">
      <strong>⚠️ 枠停止の確認</strong>
      この枠を停止します。患者からの予約受付が不可になります。よろしいですか？
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="slotActionBook()">予約を入れる</button>
      <button class="btn btn-outline" id="btn-stop-slot" onclick="handleStopSlot()">枠を停止する</button>
    </div>
  </div>
</div>

<!-- ════════ MODAL: 時刻枠管理（停止/解除） ════════ -->
<div class="modal-overlay" id="modal-bulk-stop" onclick="overlayClick(event,'modal-bulk-stop')">
  <div class="modal-card">
    <div class="modal-header">
      <div><div class="modal-title">時間帯の枠管理</div><div class="modal-subtitle" id="bs-subtitle">—</div></div>
      <button class="modal-close" onclick="closeBulkStop()">×</button>
    </div>
    <!-- 停止セクション -->
    <div id="bs-stop-section">
      <div class="confirm-view-warn show" style="margin-top:0;">
        <strong>🚫 空き枠を一括停止</strong>
        <span id="bs-stop-msg">—</span>
      </div>
      <button class="btn btn-danger" style="width:100%;margin-top:10px;" onclick="executeBulkStop()">この時間帯の空き枠を停止する</button>
    </div>
    <!-- 解除セクション -->
    <div id="bs-unblock-section" style="margin-top:12px;">
      <div style="background:hsl(142,71%,96%);border:1px solid hsl(142,71%,80%);border-radius:14px;padding:16px 18px;font-size:13.5px;color:hsl(142,55%,25%);line-height:1.6;">
        <strong style="display:block;font-size:14px;margin-bottom:4px;">✅ 停止を解除</strong>
        <span id="bs-unblock-msg">—</span>
      </div>
      <button class="btn btn-success" style="width:100%;margin-top:10px;" onclick="executeBulkUnblock()">この時間帯の停止を解除する</button>
    </div>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-ghost" style="flex:none;padding:13px 24px;" onclick="closeBulkStop()">閉じる</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <div class="lightbox-inner" onclick="event.stopPropagation()">
    <button class="lightbox-close" onclick="closeLightbox()">×</button>
    <div class="lightbox-img">
      <span class="lightbox-icon" id="lb-icon">📄</span>
    </div>
    <div class="lightbox-caption" id="lb-caption">—</div>
  </div>
</div>

<!-- ════════ MODAL: 患者詳細キャンセル確認 ════════ -->
<div class="modal-overlay" id="modal-pd-cancel" onclick="overlayClick(event,'modal-pd-cancel')">
  <div style="background:#fff;border-radius:12px;padding:28px 24px;max-width:420px;width:90%;text-align:center;">
    <div style="font-size:36px;margin-bottom:8px;">&#9888;&#65039;</div>
    <div style="font-size:18px;font-weight:800;margin-bottom:6px;">予約をキャンセルしますか？</div>
    <div style="font-size:13px;color:#555;margin-bottom:16px;">以下の予約をキャンセルします。この操作は取り消せません。</div>
    <div id="pd-cancel-detail" style="background:#f7f8fa;border-radius:8px;padding:14px 16px;text-align:left;font-size:14px;margin-bottom:12px;line-height:1.8;">
    </div>
    <div style="font-size:11px;color:#ff0000;margin-bottom:18px;">※キャンセル後は元に戻せません</div>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button onclick="closePdCancel()" style="flex:1;padding:10px;border:1px solid #aaa;background:#fff;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">戻る</button>
      <button id="btn-pd-cancel-confirm" onclick="confirmPdCancel()" style="flex:1;padding:10px;border:none;background:#ff0000;color:#fff;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;">キャンセルする</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><span id="toast-icon">✅</span><span id="toast-msg"></span></div>

<!-- ════════ MODAL: 移動確認 ════════ -->
<div class="modal-overlay" id="modal-move-confirm" onclick="overlayClick(event,'modal-move-confirm')">
  <div class="modal-card">
    <div class="modal-header">
      <div><div class="modal-title">予約枠の移動</div></div>
      <button class="modal-close" onclick="closeMoveConfirm()">×</button>
    </div>
    <div style="padding:18px 22px;font-size:14px;line-height:1.8;" id="move-confirm-msg"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeMoveConfirm()">閉じる</button>
      <button class="btn btn-primary" onclick="executeDragMove()">移動する</button>
    </div>
  </div>
</div>

<!-- ドラッグゴースト -->
<div class="drag-ghost" id="drag-ghost" style="display:none;"></div>

<script>
  /* ════ Today ════ */
  const TODAY = new Date();
  const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];
  const todayYear = TODAY.getFullYear();
  const todayMonth = TODAY.getMonth() + 1;
  const todayDate = TODAY.getDate();
  const todayWeekday = WEEKDAYS[TODAY.getDay()];
  const todayStr = `${todayYear}年${todayMonth}月${todayDate}日（${todayWeekday}）`;

  /* ════ Data ════ */
  /* 今日の日付を YYYY-MM-DD 形式で保持 */
  const todayISO = TODAY.getFullYear() + '-' + String(TODAY.getMonth() + 1).padStart(2, '0') + '-' + String(TODAY.getDate()).padStart(2, '0');

  const DOCTORS = [
    { id: 'tanaka', name: '田中 誠',  role: '院長',    color: '#0d9488',
      docBg: '#ffffff',
      reservedBg: '#ffffff', reservedText: '#000000',
      listColor: '#4A90D9' },
    { id: 'suzuki', name: '鈴木 由美', role: '副院長',  color: '#7c3aed',
      docBg: '#ffffff',
      reservedBg: '#ffffff', reservedText: '#000000',
      listColor: '#7BC67E' },
    { id: 'sato',   name: '佐藤 健',  role: 'スタッフ', color: '#ea580c',
      docBg: '#ffffff',
      reservedBg: '#ffffff', reservedText: '#000000',
      listColor: '#E8956D' },
  ];

  const MORNING   = ['09:00','09:20','09:40','10:00','10:20','10:40','11:00','11:20','11:40','12:00','12:20','12:40'];
  const AFTERNOON = ['16:00','16:20','16:40','17:00','17:20','17:40','18:00','18:20','18:40','19:00','19:20','19:40'];
  const ALL_SLOTS = [...MORNING, ...AFTERNOON];

  /** スケジュールスロット定義 */
  const doctorSchedules = {
    tanaka: {
      workDays: [1, 2, 3, 4, 5, 6],
      saturday: { am: true, pm: false },
      amSlots: ['09:00','09:20','09:40','10:00','10:20','10:40','11:00','11:20','11:40','12:00','12:20','12:40'],
      pmSlots: ['16:00','16:20','16:40','17:00','17:20','17:40','18:00','18:20','18:40','19:00','19:20','19:40']
    },
    suzuki: {
      workDays: [1, 3, 5],
      amOnlyDays: [2, 4],
      saturday: { am: false, pm: false },
      amSlots: ['09:00','09:20','09:40','10:00','10:20','10:40','11:00','11:20','11:40','12:00','12:20','12:40'],
      pmSlots: ['16:00','16:20','16:40','17:00','17:20','17:40','18:00','18:20','18:40','19:00','19:20','19:40']
    },
    sato: {
      workDays: [1, 2, 3, 4, 5, 6],
      saturday: { am: true, pm: false },
      amSlots: ['10:40','11:00','11:20','11:40'],
      pmSlots: ['16:00','16:20','16:40','17:00','17:20','17:40'],
      saturdayAmSlots: ['09:00','09:20','09:40','10:00','10:20','10:40','11:00','11:20','11:40','12:00','12:20','12:40']
    }
  };

  /** スケジュール判定: 担当医がその曜日・時間に勤務しているか */
  function isScheduledSlot(doctorId, dayOfWeek, timeSlot) {
    // 日曜は全員休み
    if (dayOfWeek === 0) return false;

    if (doctorId === 'tanaka') {
      if (!doctorSchedules.tanaka.workDays.includes(dayOfWeek)) return false;
      if (dayOfWeek === 6) return doctorSchedules.tanaka.amSlots.includes(timeSlot);
      return doctorSchedules.tanaka.amSlots.includes(timeSlot) || doctorSchedules.tanaka.pmSlots.includes(timeSlot);
    }

    if (doctorId === 'suzuki') {
      // 土・日・火・木は休み（火木は午前のみ出勤）
      if (dayOfWeek === 6) return false; // 土曜休み
      if ([1, 3, 5].includes(dayOfWeek)) {
        // 月水金：フル
        return doctorSchedules.suzuki.amSlots.includes(timeSlot) || doctorSchedules.suzuki.pmSlots.includes(timeSlot);
      }
      if ([2, 4].includes(dayOfWeek)) {
        // 火木：午前のみ
        return doctorSchedules.suzuki.amSlots.includes(timeSlot);
      }
      return false;
    }

    if (doctorId === 'sato') {
      if (!doctorSchedules.sato.workDays.includes(dayOfWeek)) return false;
      if (dayOfWeek === 6) return doctorSchedules.sato.saturdayAmSlots.includes(timeSlot);
      return doctorSchedules.sato.amSlots.includes(timeSlot) || doctorSchedules.sato.pmSlots.includes(timeSlot);
    }

    return false;
  }

  const reservations = {
    'tanaka_09:00': { name: '山田 太郎',  card: '00001', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'tanaka_09:20': { name: '佐々木 健太', card: '11111', status: '予約済', doctorPreferred: false, doctorHistory: [] },
    'suzuki_09:20': { name: '鈴木 花子',  card: '00002', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'suzuki_10:00': { name: '橋本 涼子',  card: '22222', status: '予約済', doctorPreferred: false, doctorHistory: [] },
    'sato_09:40':   { name: '高橋 一郎',  card: '10234', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'tanaka_10:00': { name: '伊藤 美咲',  card: '20018', status: '来院済', doctorPreferred: false, doctorHistory: [] },
    'suzuki_10:20': { name: '渡辺 健二',  card: '30451', status: 'キャンセル', doctorPreferred: true, doctorHistory: [] },
    'tanaka_10:40': { name: '小林 恵子',  card: '10567', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'sato_11:00':   { name: '加藤 直樹',  card: '41207', status: '来院済', doctorPreferred: false, doctorHistory: [] },
    'suzuki_11:40': { name: '中村さやか', card: '20345', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'tanaka_12:20': { name: '松本 浩二',  card: '55023', status: '来院済', doctorPreferred: false, doctorHistory: [] },
    'suzuki_16:00': { name: '井上 大輔',  card: '62891', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'tanaka_16:20': { name: '木村 優子',  card: '30789', status: '来院済', doctorPreferred: false, doctorHistory: [] },
    'sato_16:40':   { name: '清水 哲也',  card: '71344', status: 'キャンセル', doctorPreferred: true, doctorHistory: [] },
    'tanaka_17:20': { name: '山口 洋子',  card: '83006', status: '来院済', doctorPreferred: true, doctorHistory: [] },
    'suzuki_18:00': { name: '藤田 義雄',  card: '94512', status: '来院済', doctorPreferred: false, doctorHistory: [] },
  };
  /* 現在時刻より後の予約は「予約済」に戻す */
  (function() {
    var nowH = TODAY.getHours(), nowM = TODAY.getMinutes();
    var nowStr = (nowH < 10 ? '0' + nowH : '' + nowH) + ':' + (nowM < 10 ? '0' + nowM : '' + nowM);
    Object.keys(reservations).forEach(function(k) {
      var time = k.split('_')[1];
      if (time > nowStr && reservations[k].status === '来院済') {
        reservations[k].status = '予約済';
      }
    });
  })();

  /* ════ Gantt Rendering ════ */
  let blockMode = false;
  let blockModeType = null;
  const selectedSlotKeys = new Set();
  var autoBlockedSlots = new Set();

  /** スケジュール外の空きスロットを autoBlockedSlots に登録 */
  function rebuildAutoBlockedSlots(dow, resData) {
    autoBlockedSlots.clear();
    DOCTORS.forEach(function(doc) {
      ALL_SLOTS.forEach(function(time) {
        if (!isScheduledSlot(doc.id, dow, time)) {
          var key = doc.id + '_' + time;
          if (!resData[key] || resData[key].status === 'キャンセル') {
            autoBlockedSlots.add(key);
          }
        }
      });
    });
  }

  /* 移動モード（ドラッグ方式） */
  var moveMode = false;
  var dragSourceKey = null;
  var dragTargetKey = null;
  var dragGhostEl = null;
  var isDragging = false;

  function enterDragMoveMode() {
    moveMode = true;
    dragSourceKey = null;
    dragTargetKey = null;
    document.getElementById('gantt-normal-controls').style.display = 'none';
    document.getElementById('gantt-select-controls').style.display = 'none';
    document.getElementById('gantt-move-controls').style.display = 'flex';
    var rlN = document.getElementById('rl-gantt-normal-controls');
    var rlS = document.getElementById('rl-gantt-select-controls');
    var rlM = document.getElementById('rl-gantt-move-controls');
    if (rlN) rlN.style.display = 'none';
    if (rlS) rlS.style.display = 'none';
    if (rlM) rlM.style.display = 'flex';
    activeRenderGantt();
  }

  function cancelDragMoveMode() {
    moveMode = false;
    dragSourceKey = null;
    dragTargetKey = null;
    isDragging = false;
    var ghost = document.getElementById('drag-ghost');
    if (ghost) ghost.style.display = 'none';
    document.getElementById('gantt-normal-controls').style.display = 'flex';
    document.getElementById('gantt-select-controls').style.display = 'none';
    document.getElementById('gantt-move-controls').style.display = 'none';
    var rlN = document.getElementById('rl-gantt-normal-controls');
    var rlS = document.getElementById('rl-gantt-select-controls');
    var rlM = document.getElementById('rl-gantt-move-controls');
    if (rlN) rlN.style.display = 'flex';
    if (rlS) rlS.style.display = 'none';
    if (rlM) rlM.style.display = 'none';
    activeRenderGantt();
  }

  function onDragMoveStart(e, key) {
    e.preventDefault();
    isDragging = true;
    dragSourceKey = key;
    var activeRes = getActiveReservations();
    var src = activeRes[key];
    var ghost = document.getElementById('drag-ghost');
    ghost.textContent = src ? src.name : '';
    ghost.style.display = 'block';
    ghost.style.left = (e.clientX + 12) + 'px';
    ghost.style.top = (e.clientY + 12) + 'px';

    function onMove(ev) {
      ghost.style.left = (ev.clientX + 12) + 'px';
      ghost.style.top = (ev.clientY + 12) + 'px';
      // hover highlight
      var el = document.elementFromPoint(ev.clientX, ev.clientY);
      document.querySelectorAll('.gantt-move-drop-hover').forEach(function(d) { d.classList.remove('gantt-move-drop-hover'); });
      if (el) {
        var td = el.closest ? el.closest('td[data-drop-key]') : null;
        if (td) td.classList.add('gantt-move-drop-hover');
      }
    }

    function onUp(ev) {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      ghost.style.display = 'none';
      isDragging = false;
      document.querySelectorAll('.gantt-move-drop-hover').forEach(function(d) { d.classList.remove('gantt-move-drop-hover'); });
      var el = document.elementFromPoint(ev.clientX, ev.clientY);
      if (el) {
        var td = el.closest ? el.closest('td[data-drop-key]') : null;
        if (td) {
          dragTargetKey = td.getAttribute('data-drop-key');
          showMoveConfirm();
          return;
        }
      }
      dragSourceKey = null;
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  }

  /* 担当医名をIDから取得するヘルパー */
  function getDocNameById(id) {
    var doc = DOCTORS.find(function(d) { return d.id === id; });
    return doc ? doc.name : id;
  }

  /* 詳細ポップアップ用：担当医履歴の表示
     ルール:
     (1) 希望なし → 常に「希望なし」
     (2) 希望あり＋移動なし → 「{name}希望」
     (3) 希望あり＋移動あり＋元≠最終 → 「{元}希望 → {最終}に変更」
     (4) 希望あり＋移動あり＋元=最終 → 「{name}希望」（戻った場合）
     ※複数移動は最初と最後のみ表示 */
  function buildDoctorDetailLabel(res, currentDocId) {
    if (!res.doctorPreferred) return '希望なし';
    var origDocId = res.originalDocId || currentDocId;
    var history = res.doctorHistory || [];
    if (history.length === 0) {
      return getDocNameById(origDocId) + ' 希望';
    }
    var lastDocId = history[history.length - 1];
    if (origDocId === lastDocId) {
      return getDocNameById(origDocId) + ' 希望';
    }
    return getDocNameById(origDocId) + ' 希望 → ' + getDocNameById(lastDocId) + ' に変更';
  }

  function showMoveConfirm() {
    if (!dragSourceKey || !dragTargetKey) return;
    var activeRes = getActiveReservations();
    var src = activeRes[dragSourceKey];
    if (!src) return;
    var srcParts = dragSourceKey.split('_');
    var srcTime = srcParts[1];
    var tgtParts = dragTargetKey.split('_');
    var tgtDoc = DOCTORS.find(function(d) { return d.id === tgtParts[0]; });
    var tgtTime = tgtParts[1];
    /* 担当医表記 */
    var srcDocLabel, tgtDocLabel;
    if (src.doctorPreferred) {
      var origDocId = src.originalDocId || srcParts[0];
      /* 移動元ラベル: 常に最初の希望担当医を基準に表示 */
      srcDocLabel = getDocNameById(origDocId) + ' 希望';
      /* 移動先ラベル: 元の希望医と同じなら「希望」、違えば「に変更」 */
      var tgtName = tgtDoc ? tgtDoc.name : tgtParts[0];
      if (tgtParts[0] === origDocId) {
        tgtDocLabel = tgtName + ' 希望';
      } else {
        tgtDocLabel = tgtName + ' に変更';
      }
    } else {
      srcDocLabel = '希望なし';
      tgtDocLabel = '希望なし';
    }
    var msg = '<strong>' + src.name + '</strong>さんの予約を<br>' +
      srcTime + '（' + srcDocLabel + '）→ ' + tgtTime + '（' + tgtDocLabel + '）<br>に移動しますか？';
    document.getElementById('move-confirm-msg').innerHTML = msg;
    document.getElementById('modal-move-confirm').classList.add('open');
  }

  function closeMoveConfirm() {
    document.getElementById('modal-move-confirm').classList.remove('open');
    dragSourceKey = null;
    dragTargetKey = null;
  }

  function executeDragMove() {
    if (!dragSourceKey || !dragTargetKey) return;
    var activeRes = getActiveReservations();
    var src = activeRes[dragSourceKey];
    if (!src) { closeMoveConfirm(); return; }
    var name = src.name;
    var srcDocId = dragSourceKey.split('_')[0];
    var srcTime = dragSourceKey.split('_')[1];
    var tgtDocId = dragTargetKey.split('_')[0];
    var tgtTime = dragTargetKey.split('_')[1];
    var newHistory = (src.doctorHistory || []).slice();
    var origDocId = src.originalDocId || srcDocId;
    if (src.doctorPreferred) {
      newHistory.push(tgtDocId);
    }
    /* 移動先の日付を取得 */
    var moveDate;
    if (ganttContext === 'list' && rlSelectedDate) {
      moveDate = rlSelectedDate.year + '-' + String(rlSelectedDate.month).padStart(2,'0') + '-' + String(rlSelectedDate.day).padStart(2,'0');
    } else {
      moveDate = todayYear + '-' + String(todayMonth).padStart(2,'0') + '-' + String(todayDate).padStart(2,'0');
    }
    /* 移動APIを呼び出し */
    if (src.resId) {
      fetch('/api/admin/reservations/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          reservationId: src.resId,
          fromDate: moveDate,
          fromTime: srcTime + ':00',
          fromStaffId: srcDocId,
          toDate: moveDate,
          toTime: tgtTime + ':00',
          toStaffId: tgtDocId
        })
      }).catch(function(e) { console.error('移動API呼び出しに失敗:', e); });
    }
    activeRes[dragTargetKey] = { name: src.name, card: src.card, status: src.status, resId: src.resId, doctorPreferred: src.doctorPreferred, doctorHistory: newHistory, originalDocId: origDocId, preferredStaffId: src.preferredStaffId };
    delete activeRes[dragSourceKey];
    closeMoveConfirm();
    activeRenderGantt();
    showToast(name + 'さんの予約を移動しました');
  }

  function enterBlockMode(type) {
    blockMode = true;
    blockModeType = type;
    selectedSlotKeys.clear();
    document.getElementById('gantt-normal-controls').style.display = 'none';
    document.getElementById('gantt-select-controls').style.display = 'flex';
    const label = document.getElementById('gantt-select-label');
    label.style.color = type === 'stop' ? 'hsl(0,72%,44%)' : 'hsl(142,55%,32%)';
    const bulkBtn = document.getElementById('btn-bulk-all');
    bulkBtn.textContent = type === 'stop' ? '一括停止' : '一括解除';
    bulkBtn.className = type === 'stop' ? 'btn-slot-control btn-slot-stop' : 'btn-slot-control btn-slot-unblock';
    updateSelectionCount();
    renderGantt();
  }

  function cancelBlockMode() {
    blockMode = false;
    blockModeType = null;
    selectedSlotKeys.clear();
    if (moveMode) cancelDragMoveMode();
    document.getElementById('gantt-normal-controls').style.display = 'flex';
    document.getElementById('gantt-select-controls').style.display = 'none';
    document.getElementById('gantt-move-controls').style.display = 'none';
    var rlM = document.getElementById('rl-gantt-move-controls');
    if (rlM) rlM.style.display = 'none';
    var rlN = document.getElementById('rl-gantt-normal-controls');
    if (rlN) rlN.style.display = 'flex';
    renderGantt();
  }

  function toggleSlotSelection(key) {
    if (selectedSlotKeys.has(key)) {
      selectedSlotKeys.delete(key);
    } else {
      selectedSlotKeys.add(key);
    }
    updateSelectionCount();
    activeRenderGantt();
  }

  function updateSelectionCount() {
    const count = selectedSlotKeys.size;
    const isStop = blockModeType === 'stop';
    document.getElementById('gantt-select-label').textContent =
      count > 0 ? `${count}枠選択中` : (isStop ? '停止モード：枠を選択' : '停止解除モード：枠を選択');
    const btn = document.getElementById('btn-execute-block');
    btn.disabled = count === 0;
    btn.textContent = isStop ? `${count}枠を停止` : `${count}枠を解除`;
    btn.className = isStop ? 'btn-slot-control btn-slot-stop' : 'btn-slot-control btn-slot-unblock';
  }

  function executeBlockMode() {
    if (selectedSlotKeys.size === 0) return;
    const count = selectedSlotKeys.size;
    if (blockModeType === 'stop') {
      selectedSlotKeys.forEach(key => { reservations[key] = { status: '停止' }; });
      showToast(count + '枠を停止しました', '🚫');
    } else {
      selectedSlotKeys.forEach(key => { if (reservations[key] && reservations[key].status === '停止') delete reservations[key]; });
      showToast(count + '枠の停止を解除しました', '✅');
    }
    cancelBlockMode();
  }

  function executeBulkAll() {
    let count = 0;
    if (blockModeType === 'stop') {
      /* 現在以降の全空き枠を停止 */
      DOCTORS.forEach(function(doc) {
        ALL_SLOTS.forEach(function(time) {
          if (!isPastSlot(time)) {
            var key = doc.id + '_' + time;
            var res = reservations[key];
            if (!res || res.status === 'キャンセル') {
              reservations[key] = { status: '停止' };
              count++;
            }
          }
        });
      });
      showToast(count + '枠をすべて停止しました', '🚫');
    } else {
      /* 停止中の全枠を解除 */
      DOCTORS.forEach(function(doc) {
        ALL_SLOTS.forEach(function(time) {
          var key = doc.id + '_' + time;
          if (reservations[key] && reservations[key].status === '停止') {
            delete reservations[key];
            count++;
          }
        });
      });
      showToast(count + '枠の停止をすべて解除しました', '✅');
    }
    cancelBlockMode();
  }

  function renderGantt() {
    var dow = TODAY.getDay();
    rebuildAutoBlockedSlots(dow, reservations);
    renderSection('gantt-morning',   MORNING,   null, null, null, dow);
    renderSection('gantt-afternoon', AFTERNOON, null, null, null, dow);
    updateCounters();
    autoFitCellNames();
  }

  /* 予約枠の患者名・担当医名・時刻ヘッダーをフォントサイズ自動調整 */
  function autoFitCellNames() {
    requestAnimationFrame(function() {

      /* ⓪ ダッシュボード縦方向フィット：行高さ40px固定＋サマリー自動調整 */
      var dashPage = document.getElementById('page-dashboard');
      if (dashPage && dashPage.classList.contains('active')) {
        var docCount = typeof DOCTORS !== 'undefined' ? DOCTORS.length : 3;
        var totalDataRows = docCount * 2; /* 午前 + 午後 */

        /* ビューポートから安定した利用可能高さを算出 */
        var topbarEl = document.querySelector('.topbar');
        var topbarH = topbarEl ? topbarEl.offsetHeight : 56;
        var totalH = window.innerHeight - topbarH - 20;

        /* 固定要素の高さを実測 */
        var fixedH = 0;

        var cardHeader = dashPage.querySelector('.card-header');
        if (cardHeader) fixedH += cardHeader.offsetHeight;

        var legendEl = dashPage.querySelector('.gantt-legend');
        if (legendEl) fixedH += legendEl.offsetHeight;

        dashPage.querySelectorAll('.gantt-session-bar').forEach(function(b) {
          fixedH += b.offsetHeight;
        });

        fixedH += 2; /* card border */

        dashPage.querySelectorAll('.gantt-table thead').forEach(function(t) {
          fixedH += t.offsetHeight;
        });

        fixedH += 2 * (6 + 2 * (docCount + 2)) + 20;

        /* サマリーを固定コンパクト高さにし、残りをガント行に配分 */
        var summaryH = 24; /* 文字1行分＋最小padding */
        var available = totalH - fixedH;
        var rowH = Math.min(Math.max(Math.floor((available - summaryH - 4) / totalDataRows), 12), 80);

        dashPage.querySelectorAll('.gantt-table tbody tr').forEach(function(tr) {
          tr.style.height = rowH + 'px';
        });

        /* サマリーバー：フォントサイズは日付行と同期（⑤の後で適用） */
        var dSummaryBar = dashPage.querySelector('#dash-summary-bar');
        if (dSummaryBar) {
          dSummaryBar.style.marginBottom = '2px';
        }
      }

      /* ① 予約枠の患者名：カード幅に比例して自動調整（上限なし、下限4px） */
      /* 最小フォントサイズを記録して②担当医名に適用 */
      var cellFontSize = null;
      document.querySelectorAll('.gcell-name').forEach(function(el) {
        var cell = el.closest('td');
        if (!cell) return;
        var maxW = cell.clientWidth - 4;
        if (maxW <= 0) return;
        var hi = maxW;
        var lo = 4;
        el.style.fontSize = hi + 'px';
        if (el.scrollWidth <= maxW) {
          var fs = Math.floor(hi);
          el.style.fontSize = fs + 'px';
          if (cellFontSize === null || fs < cellFontSize) cellFontSize = fs;
          return;
        }
        while (hi - lo > 0.4) {
          var mid = (lo + hi) / 2;
          el.style.fontSize = mid + 'px';
          if (el.scrollWidth <= maxW) { lo = mid; } else { hi = mid; }
        }
        var fs2 = Math.floor(lo);
        el.style.fontSize = fs2 + 'px';
        if (cellFontSize === null || fs2 < cellFontSize) cellFontSize = fs2;
      });

      /* ② 担当医名：予約者名と同じフォントサイズに統一 */
      if (cellFontSize !== null) {
        document.querySelectorAll('.gantt-doc-name').forEach(function(el) {
          el.style.fontSize = cellFontSize + 'px';
        });
        /* ②-b サマリーバーの文字サイズも予約者名と同じにする */
        document.querySelectorAll('#dash-summary-bar, #rl-summary-bar').forEach(function(bar) {
          var ttl = bar.querySelector('.summary-title-inline');
          if (ttl) ttl.style.fontSize = cellFontSize + 'px';
          bar.querySelectorAll('.summary-card-text').forEach(function(el) {
            el.style.fontSize = cellFontSize + 'px';
          });
        });
        /* ②-c 未処理アラートもサマリーと同じサイズに揃える */
        ['dash-unprocessed-alert', 'rl-unprocessed-alert'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.style.fontSize = cellFontSize + 'px';
        });
      }

      /* ③ 時刻ヘッダー：縦幅フィット（height固定済み、8〜28px）、改行なし */
      document.querySelectorAll('.time-th-text').forEach(function(el) {
        var th = el.closest('th');
        if (!th) return;
        var maxH = th.clientHeight - 8;
        var maxW = th.clientWidth - 4;
        if (maxH <= 0 || maxW <= 0) return;
        var lo = 8, hi = 28;
        while (hi - lo > 0.4) {
          var mid = (lo + hi) / 2;
          el.style.fontSize = mid + 'px';
          if (el.scrollHeight <= maxH && el.scrollWidth <= maxW) { lo = mid; } else { hi = mid; }
        }
        el.style.fontSize = Math.floor(lo) + 'px';
      });

      /* ④ （削除済み：サマリータイトルはsummary-itemとして統合） */

      /* ⑤ ガントの日付見出し：縦幅フィット（h2 28px固定、8〜30px） */
      var ganttDateFs = null;
      document.querySelectorAll('.gantt-date-text').forEach(function(el) {
        var h2 = el.closest('.gantt-date-h2');
        if (!h2) return;
        var maxH = h2.clientHeight;
        if (maxH <= 0) return;
        var lo = 8, hi = 30;
        while (hi - lo > 0.4) {
          var mid = (lo + hi) / 2;
          el.style.fontSize = mid + 'px';
          if (el.scrollHeight <= maxH) { lo = mid; } else { hi = mid; }
        }
        var fs = Math.floor(lo);
        el.style.fontSize = fs + 'px';
        if (ganttDateFs === null || fs < ganttDateFs) ganttDateFs = fs;
      });

      /* ⑤-b （削除済み：サマリーは②-bでcellFontSizeに連動） */

      /* ⑥ 削除済み（予約一覧サマリーはナビバーにインライン化） */
    });
  }

  /* 画面幅変更時に自動再調整 */
  var _afcTimer;
  window.addEventListener('resize', function() {
    clearTimeout(_afcTimer);
    _afcTimer = setTimeout(autoFitCellNames, 150);
  });

  /* ⑥ 過去のスロット判定（現在時刻の30分前を基準） */
  function isPastSlot(time) {
    const now = new Date();
    const nowMins = now.getHours() * 60 + now.getMinutes() - 30;
    const [h, m] = time.split(':').map(Number);
    return (h * 60 + m) < nowMins;
  }

  function renderSection(containerId, slots, resData, pastFn, dateMode, dayOfWeek) {
    if (!resData) resData = reservations;
    if (!pastFn) pastFn = isPastSlot;
    if (!dateMode) dateMode = 'today';
    if (dayOfWeek == null) dayOfWeek = TODAY.getDay();
    let html = `<table class="gantt-table">
      <colgroup><col style="width:72px">${slots.map(() => '<col>').join('')}</colgroup>
      <thead><tr style="background:transparent">
        <th class="gantt-corner">担当医</th>
        ${slots.map(t => `<th class="gantt-time-th"><span class="time-th-text">${t}</span></th>`).join('')}
      </tr></thead>
      <tbody>`;

    DOCTORS.forEach(doc => {
      html += `<tr>`;
      html += `<td class="gantt-doc-td" style="background:${doc.docBg}">
        <div class="gantt-doc-inner">
          <div>
            <div class="gantt-doc-name">${doc.name.split(' ')[0]}</div>
          </div>
        </div>
      </td>`;

      slots.forEach(time => {
        const key = `${doc.id}_${time}`;
        const res = resData[key];

        const past = pastFn(time);
        const isSelected = blockMode && selectedSlotKeys.has(key);
        const isEmpty = !res || res.status === 'キャンセル';
        const isBlocked = (res && res.status === '停止') || (autoBlockedSlots.has(key) && isEmpty);

        if (moveMode) {
          var isDraggable = res && res.status !== 'キャンセル' && res.status !== '来院済' && res.status !== '停止';
          var isDropTarget = isEmpty && !past && !isBlocked;
          if (isDraggable) {
            html += `<td class="gantt-cell gantt-reserved gantt-move-draggable" onmousedown="onDragMoveStart(event,'${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (isDropTarget) {
            html += `<td class="gantt-cell gantt-empty gantt-move-drop-target" data-drop-key="${key}"></td>`;
          } else {
            var dimContent = res && res.status !== 'キャンセル' ? '<span class="gcell-name">' + res.name + '</span>' : '';
            html += `<td class="gantt-cell gantt-move-dim">${dimContent}</td>`;
          }
        } else if (isBlocked) {
          if (blockMode && blockModeType === 'unblock') {
            html += `<td class="gantt-cell gantt-selectable ${isSelected ? 'gantt-slot-selected' : 'gantt-blocked'}" onclick="toggleSlotSelection('${key}')">
              <span class="gcell-blocked">${isSelected ? '✓' : '停止'}</span></td>`;
          } else if (blockMode) {
            html += `<td class="gantt-cell gantt-selection-dim"><span class="gcell-blocked">停止</span></td>`;
          } else {
            html += `<td class="gantt-cell gantt-blocked"><span class="gcell-blocked">停止</span></td>`;
          }
        } else if (res && res.status !== 'キャンセル') {
          if (blockMode) {
            html += `<td class="gantt-cell gantt-selection-dim">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (res.status === '来院済') {
            /* 来院済は時間帯・日付に関わらず来院済スタイル */
            html += `<td class="gantt-cell gantt-visited" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'past') {
            /* 過去日付：全て来院済スタイル */
            html += `<td class="gantt-cell gantt-visited" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'today' && past) {
            /* 当日の過去時間帯：未処理スタイル（赤字） */
            html += `<td class="gantt-cell gantt-unprocessed" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'today') {
            /* 当日の未来時間帯：通常の予約済スタイル（黒字） */
            html += `<td class="gantt-cell gantt-reserved" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else {
            /* 未来日付：通常の予約済スタイル */
            html += `<td class="gantt-cell gantt-reserved" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          }
        } else {
          /* 空き枠 */
          if (dateMode === 'past') {
            html += `<td class="gantt-cell gantt-past-empty"></td>`;
          } else if (dateMode === 'today' && past) {
            /* 当日の過去時間帯の空き枠はグレーアウト */
            html += `<td class="gantt-cell gantt-past-empty"></td>`;
          } else if (blockMode && blockModeType === 'stop') {
            html += `<td class="gantt-cell gantt-selectable ${isSelected ? 'gantt-slot-selected' : 'gantt-empty'}" onclick="toggleSlotSelection('${key}')">
              <span class="gcell-add">${isSelected ? '✓' : '＋'}</span></td>`;
          } else if (blockMode && blockModeType === 'unblock') {
            html += `<td class="gantt-cell gantt-selection-dim"></td>`;
          } else {
            html += `<td class="gantt-cell gantt-empty" onclick="openBookingGantt('${doc.id}','${time}')">
              <span class="gcell-add">＋</span></td>`;
          }
        }
      });

      html += `</tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById(containerId).innerHTML = html;
  }

  /* ════ Counters ════ */
  function updateCounters() {
    let reserved = 0, cancelled = 0, empty = 0;
    const perDoc = {};
    DOCTORS.forEach(d => { perDoc[d.id] = { r: 0, e: 0 }; });

    DOCTORS.forEach(doc => {
      ALL_SLOTS.forEach(time => {
        const res = reservations[`${doc.id}_${time}`];
        if (!res || res.status === 'キャンセル') {
          if (res?.status === 'キャンセル') cancelled++;
          else empty++;
          perDoc[doc.id].e++;
        } else {
          reserved++;
          perDoc[doc.id].r++;
        }
      });
    });

    document.getElementById('stat-reservations').textContent = reserved + '件';
    document.getElementById('stat-cancelled').textContent = cancelled + '件';
    const totalSlots = DOCTORS.length * ALL_SLOTS.length;
    const utilPct = totalSlots > 0 ? Math.round((reserved / totalSlots) * 100) : 0;
    document.getElementById('stat-utilization').textContent = utilPct + '%';

    DOCTORS.forEach(doc => {
      const total = ALL_SLOTS.length;
      const r = perDoc[doc.id].r;
      const e = perDoc[doc.id].e;
      const pct = Math.round((r / total) * 100);
      const s = doc.id;
      const el = id => document.getElementById(`occ-${s}-${id}`);
      if (el('r')) el('r').textContent = r + '件';
      if (el('e')) el('e').textContent = e;
      if (el('bar')) el('bar').style.width = pct + '%';
      if (el('pct')) el('pct').textContent = pct + '%';
    });
    updateUnprocessedAlert();
  }

  /* 未処理予約アラート（当日の過去時間帯で来院済以外の予約をカウント） */
  function countUnprocessed() {
    var count = 0;
    DOCTORS.forEach(function(doc) {
      ALL_SLOTS.forEach(function(time) {
        if (!isPastSlot(time)) return;
        var res = reservations[doc.id + '_' + time];
        if (res && res.status !== 'キャンセル' && res.status !== '停止' && res.status !== '来院済') count++;
      });
    });
    return count;
  }
  function updateUnprocessedAlert() {
    var count = countUnprocessed();
    var el = document.getElementById('dash-unprocessed-alert');
    var countEl = document.getElementById('dash-unprocessed-count');
    if (count > 0) {
      el.style.display = 'inline-flex';
      countEl.textContent = count;
      // 改行されない範囲で最大フォントサイズに自動調整
      var summaryBar = document.getElementById('dash-summary-bar');
      if (summaryBar) {
        el.style.fontSize = '16px';
        var fontSize = 16;
        while (fontSize > 10 && summaryBar.scrollWidth > summaryBar.clientWidth) {
          fontSize--;
          el.style.fontSize = fontSize + 'px';
        }
      }
    } else {
      el.style.display = 'none';
    }
  }

  /* ⑦-2 患者情報モックデータ（APIから上書きされる） */
  const PATIENT_DATA = {
    '00001': { name:'山田 太郎', kana:'やまだ たろう', dob:'1985年3月12日', gender:'男性', zip:'160-0023', phone:'090-1234-5678', address:'東京都新宿区西新宿1-1-1', lastVisit:'2026年2月10日', notes:'腰痛・定期施術' },
    '00002': { name:'鈴木 花子', kana:'すずき はなこ', dob:'1990年7月24日', gender:'女性', zip:'150-0043', phone:'080-9876-5432', address:'東京都渋谷区道玄坂2-3-4', lastVisit:'2026年2月8日', notes:'肩こり・週1回通院' },
    '00003': { name:'佐藤 次郎', kana:'さとう じろう', dob:'1978年11月3日', gender:'男性', zip:'171-0014', phone:'070-1111-2222', address:'東京都豊島区池袋3-5-7', lastVisit:'2026年2月15日', notes:'頸部痛' },
    '10234': { name:'高橋 一郎', kana:'たかはし いちろう', dob:'1965年5月20日', gender:'男性', zip:'133-0061', phone:'090-3333-4444', address:'東京都江戸川区篠崎4-2-1', lastVisit:'2026年2月12日', notes:'' },
    '12345': { name:'鈴木 一郎', kana:'すずき いちろう', dob:'1972年9月15日', gender:'男性', zip:'231-0005', phone:'080-5555-6666', address:'神奈川県横浜市中区1-2-3', lastVisit:'2026年2月1日', notes:'ぎっくり腰・急性期' },
    '20018': { name:'伊藤 美咲', kana:'いとう みさき', dob:'1995年2月14日', gender:'女性', zip:'330-0063', phone:'090-7777-8888', address:'埼玉県さいたま市浦和区2-4-6', lastVisit:'2026年1月25日', notes:'膝痛・スポーツ障害' },
    '30451': { name:'渡辺 健二', kana:'わたなべ けんじ', dob:'1982年8月30日', gender:'男性', zip:'260-0013', phone:'070-2222-3333', address:'千葉県千葉市中央区3-6-9', lastVisit:'2026年2月5日', notes:'' },
    '41207': { name:'加藤 直樹', kana:'かとう なおき', dob:'1988年4月7日', gender:'男性', zip:'155-0031', phone:'090-4444-5555', address:'東京都世田谷区下北沢5-8-2', lastVisit:'2026年2月18日', notes:'五十肩' },
    '55023': { name:'松本 浩二', kana:'まつもと こうじ', dob:'1975年12月25日', gender:'男性', zip:'166-0002', phone:'080-6666-7777', address:'東京都杉並区高円寺6-3-4', lastVisit:'2026年2月14日', notes:'' },
    '62891': { name:'井上 大輔', kana:'いのうえ だいすけ', dob:'1991年6月18日', gender:'男性', zip:'153-0061', phone:'070-8888-9999', address:'東京都目黒区中目黒7-1-5', lastVisit:'2026年2月17日', notes:'腰椎椎間板ヘルニア' },
    '71344': { name:'清水 哲也', kana:'しみず てつや', dob:'1980年10月11日', gender:'男性', zip:'141-0032', phone:'090-0000-1111', address:'東京都品川区大崎8-2-7', lastVisit:'2026年2月13日', notes:'' },
    '83006': { name:'山口 洋子', kana:'やまぐち ようこ', dob:'1968年3月28日', gender:'女性', zip:'212-0014', phone:'080-1111-2222', address:'神奈川県川崎市幸区山王1-1-1', lastVisit:'2026年2月16日', notes:'坐骨神経痛' },
    '94512': { name:'藤田 義雄', kana:'ふじた よしお', dob:'1958年7月4日', gender:'男性', zip:'175-0094', phone:'090-3456-7890', address:'東京都板橋区成増9-3-6', lastVisit:'2026年2月19日', notes:'変形性膝関節症' },
    '99999': { name:'高橋 美咲', kana:'たかはし みさき', dob:'1993年1月31日', gender:'女性', zip:'177-0045', phone:'070-9876-5432', address:'東京都練馬区石神井公園2-5-8', lastVisit:'2026年2月11日', notes:'産後の骨盤矯正' },
    '10567': { name:'小林 恵子', kana:'こばやし けいこ', dob:'1987年6月22日', gender:'女性', zip:'164-0011', phone:'090-2345-6789', address:'東京都中野区中央3-4-5', lastVisit:'2026年2月18日', notes:'肩関節周囲炎' },
    '20345': { name:'中村さやか', kana:'なかむら さやか', dob:'1994年10月8日', gender:'女性', zip:'113-0033', phone:'080-3456-7890', address:'東京都文京区本郷1-7-3', lastVisit:'2026年2月15日', notes:'ランニング後の膝痛' },
    '30789': { name:'木村 優子', kana:'きむら ゆうこ', dob:'1989年4月15日', gender:'女性', zip:'110-0005', phone:'070-4567-8901', address:'東京都台東区上野5-2-1', lastVisit:'2026年2月19日', notes:'慢性腰痛・デスクワーク' },
    '11111': { name:'佐々木 健太', kana:'ささき けんた', dob:'1992年8月5日', gender:'男性', zip:'169-0075', phone:'090-5678-1234', address:'東京都新宿区高田馬場2-3-1', lastVisit:'2026年2月20日', notes:'腰痛' },
    '22222': { name:'橋本 涼子', kana:'はしもと りょうこ', dob:'1986年11月17日', gender:'女性', zip:'158-0094', phone:'080-6789-2345', address:'東京都世田谷区玉川3-8-5', lastVisit:'2026年2月22日', notes:'肩こり・頭痛' },
  };

  /* ⑩ カルテ画像モックデータ */
  const PATIENT_CHARTS = {
    '00001': [
      { date:'2026-02-10', label:'カルテ #128', icon:'📋' },
      { date:'2026-01-27', label:'カルテ #125', icon:'📋' },
      { date:'2025-12-15', label:'X線 #118',   icon:'🩻' },
    ],
    '00002': [
      { date:'2026-02-08', label:'カルテ #127', icon:'📋' },
      { date:'2026-01-15', label:'カルテ #122', icon:'📋' },
    ],
    '12345': [
      { date:'2026-02-01', label:'カルテ #123', icon:'📋' },
      { date:'2025-11-20', label:'X線 #110',   icon:'🩻' },
      { date:'2025-09-05', label:'MRI #105',   icon:'🩻' },
    ],
    '41207': [
      { date:'2026-02-18', label:'カルテ #130', icon:'📋' },
    ],
    '62891': [
      { date:'2026-02-17', label:'カルテ #129', icon:'📋' },
      { date:'2025-10-11', label:'MRI #112',   icon:'🩻' },
      { date:'2025-08-22', label:'X線 #108',   icon:'🩻' },
    ],
    '94512': [
      { date:'2026-02-19', label:'カルテ #131', icon:'📋' },
      { date:'2026-01-06', label:'X線 #120',   icon:'🩻' },
    ],
    '99999': [
      { date:'2026-02-11', label:'カルテ #126', icon:'📋' },
      { date:'2026-01-08', label:'カルテ #119', icon:'📋' },
    ],
  };

  /* ⑩ 予約IDを生成（キーから一意なID） */
  function makeBookingId(key) {
    var n = 0;
    for (var i = 0; i < key.length; i++) n += key.charCodeAt(i);
    return 'R' + (10000 + (n % 90000));
  }

  /* ⑩ 患者の現在予約一覧を取得 */
  function getPatientReservations(card) {
    var results = [];
    var todayDateStr = todayYear + '年' + todayMonth + '月' + todayDate + '日（' + todayWeekday + '）';
    var todaySortKey = todayYear * 10000 + todayMonth * 100 + todayDate;

    // 本日の予約（reservations）から収集
    Object.entries(reservations).forEach(function(entry) {
      var k = entry[0]; var v = entry[1];
      if (v.card === card && v.status !== 'キャンセル') {
        var parts = k.split('_'); var docId = parts[0]; var time = parts[1];
        var doc = DOCTORS.find(function(d) { return d.id === docId; }) || { name:'不明', color:'#999' };
        results.push({ key: k, time: time, doc: doc, docId: docId, resData: v, status: v.status, bookingId: makeBookingId(k), dateStr: todayDateStr, source: 'today', sortDate: todaySortKey });
      }
    });

    // カレンダー選択日の予約（listDateReservations）から収集（本日と異なる場合のみ）
    if (rlSelectedDate && Object.keys(listDateReservations).length > 0) {
      var isSameDate = (rlSelectedDate.year === todayYear && rlSelectedDate.month === todayMonth && rlSelectedDate.day === todayDate);
      if (!isSameDate) {
        var dow = ['日','月','火','水','木','金','土'];
        var ld = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
        var listDateStr = rlSelectedDate.year + '年' + rlSelectedDate.month + '月' + rlSelectedDate.day + '日（' + dow[ld.getDay()] + '）';
        var listSortKey = rlSelectedDate.year * 10000 + rlSelectedDate.month * 100 + rlSelectedDate.day;
        Object.entries(listDateReservations).forEach(function(entry) {
          var k = entry[0]; var v = entry[1];
          if (v.card === card && v.status !== 'キャンセル') {
            var parts = k.split('_'); var docId = parts[0]; var time = parts[1];
            var doc = DOCTORS.find(function(d) { return d.id === docId; }) || { name:'不明', color:'#999' };
            results.push({ key: k, time: time, doc: doc, docId: docId, resData: v, status: v.status, bookingId: makeBookingId(k), dateStr: listDateStr, source: 'list', sortDate: listSortKey });
          }
        });
      }
    }

    results.sort(function(a, b) {
      if (a.sortDate !== b.sortDate) return a.sortDate - b.sortDate;
      return a.time < b.time ? -1 : 1;
    });
    return results;
  }

  /* ⑩ カルテ画像サムネイル描画 */
  function renderPatientCharts(card) {
    var charts = PATIENT_CHARTS[card] || [];
    var container = document.getElementById('pd-charts-grid');
    if (!container) return;
    if (charts.length === 0) {
      container.innerHTML = '<span style="font-size:13px;color:hsl(214,32%,55%);">カルテ画像はありません</span>';
      return;
    }
    var html = '';
    charts.forEach(function(c) {
      html += '<div class="chart-thumb" onclick="openLightbox(\'' + c.icon + '\',\'' + c.label + '  ' + c.date + '\')">'
            + '<span style="font-size:28px;">' + c.icon + '</span>'
            + '<span class="chart-thumb-label">' + c.label + '</span>'
            + '<span class="chart-thumb-date">' + c.date + '</span>'
            + '</div>';
    });
    container.innerHTML = html;
  }

  /* ⑩ 予約一覧＋過去来院履歴を描画（APIから全件取得→未来/過去に振り分け） */
  async function renderPatientReservations(card) {
    var resContainer = document.getElementById('pd-res-list');
    var pastContainer = document.getElementById('pd-past-list');
    var p = PATIENT_DATA[card];
    var uuid = p && p.uuid;

    if (uuid) {
      try {
        var res = await fetch('/api/admin/patients/' + uuid + '/reservations');
        var json = await res.json();
        if (res.ok && json.reservations) {
          var now = new Date();
          /* 今日の日付文字列（YYYY-MM-DD）: 今日以降 = 未来、昨日以前 = 過去 */
          var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
          var statusMap = { visited: '来院済', unprocessed: '未処理', confirmed: '予約済', cancelled: 'キャンセル' };
          var dow = ['日','月','火','水','木','金','土'];
          var futureList = [];
          var pastList = [];

          /* ガント上の予約データから resId→移動履歴のマップを構築 */
          var ganttMoveMap = {};
          [reservations, listDateReservations].forEach(function(resObj) {
            Object.keys(resObj).forEach(function(key) {
              var g = resObj[key];
              if (g && g.resId) {
                ganttMoveMap[g.resId] = {
                  doctorPreferred: g.doctorPreferred,
                  originalDocId: g.originalDocId,
                  doctorHistory: g.doctorHistory || [],
                  currentDocId: key.split('_')[0]
                };
              }
            });
          });

          json.reservations.forEach(function(r) {
            if (r.status === 'cancelled') return;
            // ガント上の移動履歴があればマージ
            var gm = ganttMoveMap[r.id];
            if (gm && gm.doctorHistory && gm.doctorHistory.length > 0) {
              r._ganttMove = gm;
            }
            // 日付ベースで未来/過去を判定（今日以降=未来、昨日以前=過去）
            if (r.date >= todayStr) {
              futureList.push(r);
            } else {
              pastList.push(r);
            }
          });

          // 予約一覧（未来）: 日付昇順 — 担当医は「{name}希望」/「希望なし」
          if (resContainer) {
            if (futureList.length === 0) {
              resContainer.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">現在の予約はありません</td></tr>';
            } else {
              var html = '';
              futureList.forEach(function(r) {
                var d = new Date(r.date + 'T00:00:00');
                var dateStr = d.getFullYear() + '年' + (d.getMonth()+1) + '月' + d.getDate() + '日（' + dow[d.getDay()] + '）';
                var statusJa = statusMap[r.status] || r.status;
                /* 担当医ラベル: ポップアップと同じロジック */
                var docLabel;
                if (r._ganttMove) {
                  /* ガント上の移動履歴を使用（buildDoctorDetailLabelと同じロジック） */
                  var gm = r._ganttMove;
                  if (!gm.doctorPreferred) {
                    docLabel = '希望なし';
                  } else {
                    var origId = gm.originalDocId || gm.currentDocId;
                    var hist = gm.doctorHistory || [];
                    if (hist.length === 0 || hist[hist.length - 1] === origId) {
                      docLabel = getDocNameById(origId) + ' 希望';
                    } else {
                      docLabel = getDocNameById(origId) + ' 希望 → ' + getDocNameById(hist[hist.length - 1]) + ' に変更';
                    }
                  }
                } else if (!r.staffId) {
                  docLabel = '希望なし';
                } else if (r.moveCount > 0 && r.movedToStaffId && r.movedToStaffId !== r.staffId) {
                  docLabel = (r.staffName || r.staffId) + ' 希望 → ' + (r.movedToStaffName || r.movedToStaffId) + ' に変更';
                } else {
                  docLabel = (r.staffName || r.staffId) + ' 希望';
                }
                html += '<tr>'
                      + '<td style="white-space:nowrap;font-weight:bold;">' + dateStr + ' ' + r.timeSlot + '</td>'
                      + '<td><span style="color:#000000;">' + docLabel + '</span></td>'
                      + '<td style="font-variant-numeric:tabular-nums;">' + r.reservationNumber + '</td>'
                      + '<td>' + makeStatusBadge(statusJa) + '</td>'
                      + '<td><button class="btn-cancel-sm" onclick="cancelPatientResAPI(this,\'' + r.id + '\',\'' + card + '\')">予約取消</button></td>'
                      + '<td></td>'
                      + '</tr>';
              });
              resContainer.innerHTML = html;
            }
          }

          // 過去来院履歴: 日付降順（新しい順） — 移動履歴を含む担当医表示
          if (pastContainer) {
            pastList.sort(function(a, b) {
              if (a.date !== b.date) return b.date.localeCompare(a.date);
              return (b.timeSlot || '').localeCompare(a.timeSlot || '');
            });
            if (pastList.length === 0) {
              pastContainer.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">過去の来院記録はありません</td></tr>';
            } else {
              var html2 = '';
              pastList.forEach(function(r) {
                var d = new Date(r.date + 'T00:00:00');
                var dateStr = d.getFullYear() + '年' + (d.getMonth()+1) + '月' + d.getDate() + '日（' + dow[d.getDay()] + '）';
                var statusJa = statusMap[r.status] || r.status;
                /* 過去来院の担当医ラベル:
                   移動履歴あり・担当医変更あり → 「{元名} → {actual名} に変更」
                   それ以外 → actual_staff_id の担当医名のみ */
                var docLabel;
                if (r.actualStaffId) {
                  if (r.staffId && r.actualStaffId !== r.staffId) {
                    docLabel = (r.staffName || r.staffId) + ' → ' + (r.actualStaffName || r.actualStaffId) + ' に変更';
                  } else {
                    docLabel = r.actualStaffName || r.actualStaffId;
                  }
                } else if (r._ganttMove) {
                  var gm = r._ganttMove;
                  var origId = gm.originalDocId || gm.currentDocId;
                  var hist = gm.doctorHistory || [];
                  if (origId && hist.length > 0 && hist[hist.length - 1] !== origId) {
                    docLabel = getDocNameById(origId) + ' → ' + getDocNameById(hist[hist.length - 1]) + ' に変更';
                  } else {
                    docLabel = getDocNameById(gm.currentDocId || origId) || '担当医未記録';
                  }
                } else if (r.moveCount > 0 && r.movedToStaffId && r.movedToStaffId !== r.staffId) {
                  docLabel = (r.staffName || r.staffId) + ' → ' + (r.movedToStaffName || r.movedToStaffId) + ' に変更';
                } else {
                  docLabel = '担当医未記録';
                }
                html2 += '<tr>'
                       + '<td style="white-space:nowrap;font-weight:bold;">' + dateStr + ' ' + r.timeSlot + '</td>'
                       + '<td><span style="color:#000000;">' + docLabel + '</span></td>'
                       + '<td style="font-variant-numeric:tabular-nums;">' + r.reservationNumber + '</td>'
                       + '</tr>';
              });
              pastContainer.innerHTML = html2;
            }
          }
          return;
        }
      } catch(e) {
        console.error('患者予約一覧の取得に失敗:', e);
      }
    }

    // フォールバック: 従来のメモリ内検索
    if (resContainer) {
      var resList = getPatientReservations(card).filter(function(r) { return r.status !== '来院済'; });
      if (resList.length === 0) {
        resContainer.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">現在の予約はありません</td></tr>';
      } else {
        var html = '';
        resList.forEach(function(r) {
          var docLabel = r.resData ? buildDoctorDetailLabel(r.resData, r.docId) : r.doc.name;
          html += '<tr>'
                + '<td style="white-space:nowrap;font-weight:bold;">' + r.dateStr + ' ' + r.time + '</td>'
                + '<td><span style="color:#000000;">' + docLabel + '</span></td>'
                + '<td style="font-variant-numeric:tabular-nums;">' + r.bookingId + '</td>'
                + '<td>' + makeStatusBadge(r.status) + '</td>'
                + '<td><button class="btn-cancel-sm" onclick="cancelPatientRes(this,\'' + r.key + '\',\'' + r.source + '\')">予約取消</button></td>'
                + '<td></td>'
                + '</tr>';
        });
        resContainer.innerHTML = html;
      }
    }
  }

  /* 過去来院履歴描画（renderPatientReservationsで一括処理するためスタブ化） */
  function renderPastVisits(card) {
    /* APIモードではrenderPatientReservationsが過去分も描画するため、ここでは何もしない */
    /* フォールバック時のためにコンテナが空なら初期メッセージを表示 */
    var container = document.getElementById('pd-past-list');
    if (!container) return;
    if (container.innerHTML.trim() === '') {
      container.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">過去の来院記録はありません</td></tr>';
    }
  }

  /* 過去来院記録アコーディオン開閉 */
  function togglePastVisits() {
    var wrap = document.getElementById('pd-past-visits-wrap');
    var toggle = document.getElementById('pd-past-toggle');
    if (wrap.style.display === 'none') {
      wrap.style.display = '';
      toggle.textContent = '▼ 閉じる';
    } else {
      wrap.style.display = 'none';
      toggle.textContent = '▶ 開く';
    }
  }

  /* 基本情報の編集 */
  function parseDob(str) {
    var m = String(str).match(/(\d+)年(\d+)月(\d+)日/);
    return m ? { y: m[1], m: m[2], d: m[3] } : { y: '', m: '', d: '' };
  }

  function editBasicInfo() {
    document.getElementById('pd-edit-btn').style.display = 'none';
    document.getElementById('pd-save-btn').style.display = '';
    var inp = 'pd-notes-input';
    /* 氏名 */
    var el = document.getElementById('pd-name');
    var v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';
    /* ふりがな */
    el = document.getElementById('pd-kana');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';
    /* 診察券番号 */
    el = document.getElementById('pd-card');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';
    /* 生年月日 */
    el = document.getElementById('pd-dob');
    var dob = parseDob(el.textContent);
    el.innerHTML = '<input class="' + inp + '" style="width:80px;text-align:center;" value="' + dob.y + '">年'
                 + '<input class="' + inp + '" style="width:50px;text-align:center;" value="' + dob.m + '">月'
                 + '<input class="' + inp + '" style="width:50px;text-align:center;" value="' + dob.d + '">日';
    /* 性別 */
    el = document.getElementById('pd-gender');
    v = el.textContent.trim();
    el.innerHTML = '<select class="' + inp + '" style="padding:6px 10px;">'
                 + '<option' + (v==='男性'?' selected':'') + '>男性</option>'
                 + '<option' + (v==='女性'?' selected':'') + '>女性</option>'
                 + '<option' + (v==='その他'?' selected':'') + '>その他</option>'
                 + '</select>';
    /* 郵便番号 */
    el = document.getElementById('pd-zip');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" style="width:100px;" value="' + v.replace(/"/g,'&quot;') + '" placeholder="000-0000">'
                 + ' <button class="pd-notes-edit-btn" onclick="searchZip()" style="margin-left:4px;">住所検索</button>';
    /* 住所 */
    el = document.getElementById('pd-address');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';
    /* 電話番号 */
    el = document.getElementById('pd-phone');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';
    /* 最終来院日 → 編集不可 */
    /* 備考 */
    el = document.getElementById('pd-notes');
    v = el.textContent === '—' ? '' : el.textContent;
    el.innerHTML = '<input class="' + inp + '" value="' + v.replace(/"/g,'&quot;') + '">';

    var first = document.querySelector('#pd-name input');
    if (first) first.focus();
  }

  function saveBasicInfo() {
    var isNew = !currentPatientCard;
    if (isNew) {
      /* 新規患者：診察券番号を取得してPATIENT_DATAに登録 */
      var cardInput = document.getElementById('pd-card').querySelector('input');
      var newCard = cardInput ? cardInput.value.trim() : '';
      if (!newCard) { alert('診察券番号を入力してください'); return; }
      if (PATIENT_DATA[newCard]) { alert('この診察券番号は既に使用されています'); return; }
      PATIENT_DATA[newCard] = { name:'', kana:'', dob:'', gender:'', zip:'', phone:'', address:'', lastVisit:'—', notes:'' };
      currentPatientCard = newCard;
    }
    var p = currentPatientCard && PATIENT_DATA[currentPatientCard] ? PATIENT_DATA[currentPatientCard] : null;
    /* 氏名 */
    var el = document.getElementById('pd-name');
    var input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.name = v; }
    /* ふりがな */
    el = document.getElementById('pd-kana');
    input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.kana = v; }
    /* 診察券番号 */
    el = document.getElementById('pd-card');
    input = el.querySelector('input');
    if (input) { el.textContent = input.value.trim() || '—'; }
    /* 生年月日 */
    el = document.getElementById('pd-dob');
    var inputs = el.querySelectorAll('input');
    if (inputs.length === 3) {
      var y = inputs[0].value.trim(), m = inputs[1].value.trim(), d = inputs[2].value.trim();
      var dobStr = (y && m && d) ? y + '年' + m + '月' + d + '日' : '—';
      el.textContent = dobStr;
      if (p) p.dob = dobStr;
    }
    /* 性別 */
    el = document.getElementById('pd-gender');
    var sel = el.querySelector('select');
    if (sel) { el.textContent = sel.value; if (p) p.gender = sel.value; }
    /* 郵便番号 */
    el = document.getElementById('pd-zip');
    input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.zip = v; }
    /* 住所 */
    el = document.getElementById('pd-address');
    input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.address = v; }
    /* 電話番号 */
    el = document.getElementById('pd-phone');
    input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.phone = v; }
    /* 最終来院日 → 変更なし */
    /* 備考 */
    el = document.getElementById('pd-notes');
    input = el.querySelector('input');
    if (input) { var v = input.value.trim(); el.textContent = v || '—'; if (p) p.notes = v; }

    document.getElementById('pd-edit-btn').style.display = '';
    document.getElementById('pd-save-btn').style.display = 'none';
    if (isNew) {
      showToast('新しい患者を登録しました', '✅');
    }
  }

  /* 郵便番号から住所検索 */
  function searchZip() {
    var zipInput = document.querySelector('#pd-zip input');
    if (!zipInput) return;
    var zip = zipInput.value.replace(/[^0-9]/g, '');
    if (zip.length !== 7) { alert('郵便番号は7桁で入力してください'); return; }
    fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + zip)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.results && data.results.length > 0) {
          var r = data.results[0];
          var addr = r.address1 + r.address2 + r.address3;
          var addrInput = document.querySelector('#pd-address input');
          if (addrInput) addrInput.value = addr;
        } else {
          alert('該当する住所が見つかりませんでした');
        }
      })
      .catch(function() { alert('住所検索に失敗しました'); });
  }

  /* ⑩ 患者詳細からキャンセル（モーダル確認） */
  var pdCancelKey = null;
  var pdCancelSource = null;

  function cancelPatientRes(btn, key, source) {
    pdCancelKey = key;
    pdCancelSource = source || 'today';
    var targetRes = (pdCancelSource === 'list') ? listDateReservations : reservations;
    var r = targetRes[key];
    if (!r) return;
    var parts = key.split('_');
    var docId = parts[0];
    var time = parts[1];
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    var docName = doc ? doc.name : docId;
    var bookingId = makeBookingId(key);
    // 日付を source から決定
    var dateStr;
    if (pdCancelSource === 'list' && rlSelectedDate) {
      var dow = ['日','月','火','水','木','金','土'];
      var ld = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
      dateStr = rlSelectedDate.year + '年' + rlSelectedDate.month + '月' + rlSelectedDate.day + '日（' + dow[ld.getDay()] + '）';
    } else {
      dateStr = todayYear + '年' + todayMonth + '月' + todayDate + '日（' + todayWeekday + '）';
    }
    document.getElementById('pd-cancel-detail').innerHTML =
      '<div><span style="color:#888;font-size:12px;">患者名：</span><strong>' + r.name + '</strong></div>'
      + '<div><span style="color:#888;font-size:12px;">日時：</span>' + dateStr + ' ' + time + '</div>'
      + '<div><span style="color:#888;font-size:12px;">担当医：</span>' + docName + '</div>'
      + '<div><span style="color:#888;font-size:12px;">予約番号：</span>' + bookingId + '</div>';
    document.getElementById('modal-pd-cancel').classList.add('open');
  }

  function closePdCancel() {
    document.getElementById('modal-pd-cancel').classList.remove('open');
    pdCancelKey = null;
    pdCancelSource = null;
  }

  function confirmPdCancel() {
    if (!pdCancelKey) return;
    var targetRes = (pdCancelSource === 'list') ? listDateReservations : reservations;
    if (!targetRes[pdCancelKey]) return;
    var name = targetRes[pdCancelKey].name;
    var card = targetRes[pdCancelKey].card;
    targetRes[pdCancelKey].status = 'キャンセル';
    var pdParts = pdCancelKey.split('_');
    var pdDocId = pdParts[0];
    var pdTimeStr = pdParts[1];
    autoStopIfNeeded(pdDocId, pdTimeStr);
    activeRenderGantt();
    renderPatientReservations(card);
    renderPastVisits(card);
    closePdCancel();
    showToast(name + 'さんの予約をキャンセルしました', '❌');
  }

  /* ⑩ 患者詳細からAPIキャンセル */
  var pdCancelAPIId = null;
  var pdCancelAPICard = null;
  function cancelPatientResAPI(btn, reservationId, card) {
    pdCancelAPIId = reservationId;
    pdCancelAPICard = card;
    document.getElementById('pd-cancel-detail').innerHTML =
      '<div><span style="color:#888;font-size:12px;">予約ID：</span>' + reservationId.substring(0,8) + '...</div>';
    document.getElementById('modal-pd-cancel').classList.add('open');
    // Override confirm to use API
    document.getElementById('btn-pd-cancel-confirm').onclick = confirmPdCancelAPI;
  }

  async function confirmPdCancelAPI() {
    if (!pdCancelAPIId) return;
    try {
      var res = await fetch('/api/patient/reservations', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reservationId: pdCancelAPIId })
      });
      if (res.ok) {
        showToast('予約をキャンセルしました', '❌');
        renderPatientReservations(pdCancelAPICard);
      }
    } catch(e) { console.error('キャンセル失敗:', e); }
    closePdCancel();
    pdCancelAPIId = null;
    pdCancelAPICard = null;
    // Restore original confirm handler
    document.getElementById('btn-pd-cancel-confirm').onclick = confirmPdCancel;
  }

  /* ⑨ 患者検索 */
  function searchPatients() {
    var q = document.getElementById('pl-search').value.trim().toLowerCase();
    var entries = Object.entries(PATIENT_DATA);
    var results = q
      ? entries.filter(function(e) {
          return e[0].includes(q) || e[1].kana.includes(q) || e[1].name.includes(q);
        })
      : entries;
    renderPatientCards(results);
  }

  /* ⑨ 患者テーブル一覧描画 */
  function renderPatientCards(entries) {
    var container = document.getElementById('patient-card-list');
    if (!container) return;
    if (entries.length === 0) {
      container.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;color:hsl(214,32%,52%);">該当する患者が見つかりませんでした</td></tr>';
      return;
    }
    var html = '';
    entries.forEach(function(entry) {
      var card = entry[0]; var p = entry[1];
      html += '<tr onclick="openPatientDetail(\'' + card + '\',\'patient-list\')">'
            + '<td class="pt-name">' + p.name + '</td>'
            + '<td>' + p.kana + '</td>'
            + '<td style="font-variant-numeric:tabular-nums;">' + card + '</td>'
            + '<td>' + p.lastVisit + '</td>'
            + '<td></td>'
            + '</tr>';
    });
    container.innerHTML = html;
  }

  /* Lightbox 開閉 */
  function openLightbox(icon, caption) {
    document.getElementById('lb-icon').textContent    = icon;
    document.getElementById('lb-caption').textContent = caption;
    document.getElementById('lightbox').classList.add('open');
  }
  function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
  }

  /* ⑦-2 患者詳細ページへ遷移（⑧⑩対応済み） */
  var pdReturnPage = 'dashboard';
  var currentPatientCard = null;

  function openPatientDetail(card, returnPage) {
    closeDetail();
    pdReturnPage = returnPage || 'dashboard';
    currentPatientCard = card;
    const p = PATIENT_DATA[card] || { name:'患者情報なし', kana:'—', dob:'—', gender:'—', phone:'—', address:'—', lastVisit:'—', notes:'—', zip:'—' };
    document.getElementById('pd-name').textContent      = p.name;
    document.getElementById('pd-kana').textContent      = p.kana || '—';
    document.getElementById('pd-card').textContent      = card;
    document.getElementById('pd-dob').textContent       = p.dob;
    document.getElementById('pd-gender').textContent    = p.gender;
    document.getElementById('pd-zip').textContent       = p.zip || '—';
    document.getElementById('pd-address').textContent   = p.address;
    document.getElementById('pd-phone').textContent     = p.phone;
    document.getElementById('pd-lastVisit').innerHTML   = p.lastVisit + ' <span style="font-size:10px;color:hsl(214,32%,52%);">※履歴から自動反映</span>';
    document.getElementById('pd-notes').textContent     = p.notes || '—';
    document.getElementById('pd-edit-btn').style.display = '';
    document.getElementById('pd-save-btn').style.display = 'none';
    document.getElementById('pd-back-btn').textContent  =
      pdReturnPage === 'patient-list' ? '← 患者情報一覧に戻る' : '← ダッシュボードに戻る';
    /* 過去来院記録を閉じた状態にリセット */
    document.getElementById('pd-past-visits-wrap').style.display = 'none';
    document.getElementById('pd-past-toggle').textContent = '▶ 開く';
    renderPatientCharts(card);
    renderPatientReservations(card);
    renderPastVisits(card);
    document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
    document.getElementById('page-patient-detail').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-title').textContent = '患者情報詳細';
  }

  function openNewPatient() {
    closeDetail();
    pdReturnPage = 'patient-list';
    currentPatientCard = null;
    document.getElementById('pd-name').textContent      = '—';
    document.getElementById('pd-kana').textContent      = '—';
    document.getElementById('pd-card').textContent      = '—';
    document.getElementById('pd-dob').textContent       = '—';
    document.getElementById('pd-gender').textContent    = '—';
    document.getElementById('pd-zip').textContent       = '—';
    document.getElementById('pd-address').textContent   = '—';
    document.getElementById('pd-phone').textContent     = '—';
    document.getElementById('pd-lastVisit').innerHTML   = '— <span style="font-size:10px;color:hsl(214,32%,52%);">※履歴から自動反映</span>';
    document.getElementById('pd-notes').textContent     = '—';
    document.getElementById('pd-edit-btn').style.display = 'none';
    document.getElementById('pd-save-btn').style.display = 'none';
    document.getElementById('pd-back-btn').textContent  = '← 患者情報一覧に戻る';
    document.getElementById('pd-past-visits-wrap').style.display = 'none';
    document.getElementById('pd-past-toggle').textContent = '▶ 開く';
    document.getElementById('pd-charts-grid').innerHTML = '';
    document.getElementById('pd-res-list').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">現在の予約はありません</td></tr>';
    document.getElementById('pd-past-list').innerHTML = '<tr><td colspan="3" style="text-align:center;padding:24px;color:hsl(214,32%,52%);font-size:13px;">過去の来院記録はありません</td></tr>';
    document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
    document.getElementById('page-patient-detail').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-title').textContent = '患者情報詳細';
    /* 自動で編集モードに入る */
    editBasicInfo();
  }

  function navBack() {
    if (pdReturnPage === 'patient-list') {
      const el = document.querySelector('[data-navid="patient-list"]');
      nav('patient-list', el);
    } else {
      nav('dashboard', document.querySelector('.nav-item'));
    }
  }

  function navBackToDashboard() { navBack(); }

  /* ════ Nav ════ */
  const titles = { dashboard:'ダッシュボード', list:'予約一覧', schedule:'診療カレンダー', analytics:'統計・分析', settings:'設定', 'patient-detail':'患者情報詳細', 'patient-list':'患者情報' };
  function nav(id, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('page-title').textContent = titles[id] || id;
    /* ⑨ 患者情報ページ表示時に検索を初期化 */
    if (id === 'patient-list') {
      document.getElementById('pl-search').value = '';
      searchPatients();
    }
    /* ダッシュボード表示時にフォントサイズを再計算（非表示中に壊れた値を修復） */
    if (id === 'dashboard') {
      autoFitCellNames();
    }
    /* 診療カレンダー表示時にレンダリング */
    if (id === 'schedule') {
      renderClinicSettings();
      renderDocCards();
    }
    /* 設定ページ表示時にレンダリング */
    if (id === 'settings') {
      renderStgPage();
    }
  }

  /* ════ Settings page ════ */
  var stgCurrentPage = 'clinic-info';
  var stgEditingCard = null;

  /* ダミーデータ */
  var stgData = {
    clinicName: '〇〇接骨院',
    clinicPhone: '06-1234-5678',
    clinicAddress: '大阪府大阪市中央区本町1-2-3',
    clinicEmail: 'info@example.jp',
    bookingDeadlineEnabled: true,
    bookingDeadlineDay: '当日',
    bookingDeadlineType: 'minutes',
    bookingDeadlineTime: '09:00',
    bookingDeadlineMin: '60',
    cancelDeadlineEnabled: true,
    cancelDeadlineDay: '前日',
    cancelDeadlineType: 'time',
    cancelDeadlineTime: '18:00',
    cancelDeadlineMin: '60',
    calendarWeekStart: 'monday',
    notifyEmail: true,
    remindDayBefore: '前日',
    remindTimeVal: '18:00',
    patientIdDigits: '6',
    numberRule: '自動採番',
    karteFormat: 'K-000001',
    secRequirePassword: { editClinic: false, editDoctor: false, deletePatient: false, exportData: false, accessSettings: false }
  };

  function stgNav(el, page) {
    document.querySelectorAll('.stg-cat-item').forEach(function(c) { c.classList.remove('active'); });
    el.classList.add('active');
    stgCurrentPage = page;
    stgEditingCard = null;
    renderStgPage();
  }

  function renderStgPage() {
    var c = document.getElementById('settings-content');
    var fn = stgRenderers[stgCurrentPage];
    c.innerHTML = fn ? fn() : stgPlaceholder('近日公開予定');
  }

  function stgPlaceholder(text) {
    return '<div class="stg-placeholder"><div class="stg-placeholder-icon">🚧</div><div class="stg-placeholder-text">' + text + '</div></div>';
  }

  /* ── Row helpers ── */
  function stgRow(label, value) {
    return '<div class="stg-row"><div class="stg-row-label">' + label + '</div><div class="stg-row-value">' + value + '</div></div>';
  }
  function stgRowInput(label, id, value, type) {
    type = type || 'text';
    return '<div class="stg-row"><div class="stg-row-label">' + label + '</div><div class="stg-row-input"><input type="' + type + '" id="' + id + '" value="' + value + '"></div></div>';
  }
  function stgRowToggle(label, key) {
    var on = stgData[key];
    return '<div class="stg-row"><div class="stg-row-label">' + label + '</div><div class="stg-row-value">' + (on ? 'ON' : 'OFF') + '</div></div>';
  }
  function stgRowToggleEdit(label, key) {
    var on = stgData[key];
    return '<div class="stg-row"><div class="stg-row-label">' + label + '</div><div class="stg-row-value">'
      + '<button class="stg-toggle' + (on ? ' on' : '') + '" onclick="stgData[\'' + key + '\']=!stgData[\'' + key + '\'];renderStgPage()"></button>'
      + '<span style="margin-left:8px;font-size:12px;color:#888;">' + (on ? 'ON' : 'OFF') + '</span>'
      + '</div></div>';
  }

  /* ── Card wrapper ── */
  function stgCard(id, title, bodyFn, opts) {
    opts = opts || {};
    var editing = stgEditingCard === id;
    var h = '<div class="stg-card">';
    h += '<div class="stg-card-header"><div style="display:flex;align-items:center;">';
    h += '<span class="stg-card-title">' + title + '</span>';
    if (opts.note) h += '<span class="stg-card-note">' + opts.note + '</span>';
    h += '</div>';
    if (opts.editable !== false) {
      if (!editing) {
        if (id === 'sec-ops' || id === 'sec-pw') {
          h += '<button class="stg-btn-edit" onclick="showAuthModal(function(){ stgEditingCard=\'' + id + '\';renderStgPage(); })">編集</button>';
        } else if (id === 'info') {
          h += '<button class="stg-btn-edit" onclick="requireAuthIfNeeded(\'editClinic\', function(){ stgEditingCard=\'' + id + '\';renderStgPage(); })">編集</button>';
        } else {
          h += '<button class="stg-btn-edit" onclick="stgEditingCard=\'' + id + '\';renderStgPage()">編集</button>';
        }
      }
    }
    h += '</div>';
    h += '<div class="stg-card-body">' + bodyFn(editing) + '</div>';
    if (editing) {
      h += '<div class="stg-actions">';
      h += '<button class="stg-btn-cancel" onclick="stgEditingCard=null;renderStgPage()">キャンセル</button>';
      h += '<button class="stg-btn-save" onclick="stgSaveCard(\'' + id + '\')">' + (id === 'sec-pw' ? '変更する' : '保存') + '</button>';
      h += '</div>';
    }
    h += '</div>';
    return h;
  }

  /* 締め切り設定：表示テキスト生成 */
  function stgDeadlineDisplayText(day, type, time, min) {
    if (type === 'time') return day + ' の ' + time + ' まで';
    return '診療開始の ' + min + ' 分前まで';
  }

  /* 締め切り設定：編集行HTML生成 */
  function stgDeadlineEditRow(label, prefix, enabled, day, type, time, min) {
    var inputStyle = 'padding:5px 8px;border:1.5px solid #d1d5db;border-radius:6px;font-size:13px;font-family:inherit;outline:none;';
    var radioStyle = 'cursor:pointer;';
    var r = '<div class="stg-row"><div class="stg-row-label">' + label + '</div>';
    r += '<div class="stg-row-value" style="font-size:13px;">';
    /* あり/なし トグル */
    r += '<div style="display:flex;gap:12px;margin-bottom:8px;">';
    r += '<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-weight:600;">';
    r += '<input type="radio" name="stg-' + prefix + '-enabled" value="1"' + (enabled ? ' checked' : '') + ' style="' + radioStyle + '" onchange="stgToggleDeadline(\'' + prefix + '\',true)"> あり</label>';
    r += '<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-weight:600;">';
    r += '<input type="radio" name="stg-' + prefix + '-enabled" value="0"' + (!enabled ? ' checked' : '') + ' style="' + radioStyle + '" onchange="stgToggleDeadline(\'' + prefix + '\',false)"> なし</label>';
    r += '</div>';
    /* 詳細設定（あり選択時のみ表示） */
    r += '<div id="stg-' + prefix + '-detail" style="' + (enabled ? '' : 'display:none;') + 'padding-left:4px;">';
    /* 当日/前日 プルダウン */
    r += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">';
    r += '<select id="stg-' + prefix + '-day" style="' + inputStyle + '">';
    r += '<option value="当日"' + (day === '当日' ? ' selected' : '') + '>当日</option>';
    r += '<option value="前日"' + (day === '前日' ? ' selected' : '') + '>前日</option>';
    r += '</select>';
    r += '<span>の</span>';
    r += '</div>';
    /* 時刻指定 / 時間前指定 ラジオ */
    r += '<div style="display:flex;flex-direction:column;gap:8px;">';
    r += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;">';
    r += '<input type="radio" name="stg-' + prefix + '-type" value="time"' + (type === 'time' ? ' checked' : '') + ' style="' + radioStyle + '" onchange="stgToggleDeadlineType(\'' + prefix + '\',\'time\')">';
    r += '<span>時刻指定</span>';
    r += '<span id="stg-' + prefix + '-time-wrap" style="display:' + (type === 'time' ? 'flex' : 'none') + ';align-items:center;gap:4px;">';
    r += '<input type="text" id="stg-' + prefix + '-time" value="' + time + '" placeholder="18:00" style="width:64px;text-align:center;' + inputStyle + '">';
    r += '<span>まで</span></span></label>';
    r += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;">';
    r += '<input type="radio" name="stg-' + prefix + '-type" value="minutes"' + (type === 'minutes' ? ' checked' : '') + ' style="' + radioStyle + '" onchange="stgToggleDeadlineType(\'' + prefix + '\',\'minutes\')">';
    r += '<span>時間前指定</span>';
    r += '<span id="stg-' + prefix + '-min-wrap" style="display:' + (type === 'minutes' ? 'flex' : 'none') + ';align-items:center;gap:4px;">';
    r += '<input type="number" id="stg-' + prefix + '-min" value="' + min + '" style="width:60px;text-align:center;' + inputStyle + '">';
    r += '<span>分前まで</span></span></label>';
    r += '</div></div></div></div>';
    return r;
  }

  /* あり/なし トグル */
  function stgToggleDeadline(prefix, enabled) {
    var detail = document.getElementById('stg-' + prefix + '-detail');
    if (detail) detail.style.display = enabled ? '' : 'none';
  }

  /* 時刻指定/時間前指定 切り替え */
  function stgToggleDeadlineType(prefix, type) {
    var tw = document.getElementById('stg-' + prefix + '-time-wrap');
    var mw = document.getElementById('stg-' + prefix + '-min-wrap');
    if (tw) tw.style.display = (type === 'time') ? 'flex' : 'none';
    if (mw) mw.style.display = (type === 'minutes') ? 'flex' : 'none';
  }

  function stgSaveCard(id) {
    if (id === 'booking') {
      /* 予約受付の締め切り */
      var bEnabled = document.querySelector('input[name="stg-booking-enabled"][value="1"]');
      stgData.bookingDeadlineEnabled = bEnabled ? bEnabled.checked : false;
      var bDay = document.getElementById('stg-booking-day');
      if (bDay) stgData.bookingDeadlineDay = bDay.value;
      var bType = document.querySelector('input[name="stg-booking-type"]:checked');
      if (bType) stgData.bookingDeadlineType = bType.value;
      var bTime = document.getElementById('stg-booking-time');
      if (bTime) stgData.bookingDeadlineTime = bTime.value;
      var bMin = document.getElementById('stg-booking-min');
      if (bMin) stgData.bookingDeadlineMin = bMin.value;
      /* オンラインでの取消期限 */
      var cEnabled = document.querySelector('input[name="stg-cancel-enabled"][value="1"]');
      stgData.cancelDeadlineEnabled = cEnabled ? cEnabled.checked : false;
      var cDay = document.getElementById('stg-cancel-day');
      if (cDay) stgData.cancelDeadlineDay = cDay.value;
      var cType = document.querySelector('input[name="stg-cancel-type"]:checked');
      if (cType) stgData.cancelDeadlineType = cType.value;
      var cTime = document.getElementById('stg-cancel-time');
      if (cTime) stgData.cancelDeadlineTime = cTime.value;
      var cMin = document.getElementById('stg-cancel-min');
      if (cMin) stgData.cancelDeadlineMin = cMin.value;
    } else if (id === 'sec-ops') {
      var items = ['editClinic','editDoctor','deletePatient','exportData','accessSettings'];
      items.forEach(function(key) {
        var cb = document.getElementById('stg-sec-' + key);
        if (cb) stgData.secRequirePassword[key] = cb.checked;
      });
    } else if (id === 'sec-pw') {
      var cur = document.getElementById('stg-pw-current');
      var nw = document.getElementById('stg-pw-new');
      var conf = document.getElementById('stg-pw-confirm');
      if (!cur.value || !nw.value || !conf.value) {
        showToast('全ての項目を入力してください', '⚠️');
        return;
      }
      if (nw.value !== conf.value) {
        showToast('新しいパスワードが一致しません', '⚠️');
        return;
      }
      stgEditingCard = null;
      renderStgPage();
      showToast('パスワードを変更しました');
      return;
    } else {
      /* Generic: read all inputs/selects with stg- prefix */
      var inputs = document.querySelectorAll('#settings-content input[id^="stg-"], #settings-content select[id^="stg-"]');
      inputs.forEach(function(el) {
        var key = el.id.replace('stg-', '');
        if (el.type === 'checkbox') { stgData[key] = el.checked; }
        else { stgData[key] = el.value; }
      });
    }
    var nameEl = document.getElementById('sidebar-clinic-name');
    if (nameEl && stgData.clinicName) nameEl.textContent = stgData.clinicName;
    stgEditingCard = null;
    renderStgPage();
    showToast('設定を保存しました');
  }

  /* ── Page renderers ── */
  var stgRenderers = {
    'clinic-info': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">院の基本情報</div>';
      h += stgCard('info', '院の情報', function(editing) {
        if (editing) {
          return stgRowInput('院名', 'stg-clinicName', stgData.clinicName)
            + stgRowInput('電話番号', 'stg-clinicPhone', stgData.clinicPhone, 'tel')
            + stgRowInput('住所', 'stg-clinicAddress', stgData.clinicAddress)
            + stgRowInput('メールアドレス', 'stg-clinicEmail', stgData.clinicEmail, 'email');
        }
        return stgRow('院名', stgData.clinicName)
          + stgRow('電話番号', stgData.clinicPhone)
          + stgRow('住所', stgData.clinicAddress)
          + stgRow('メールアドレス', stgData.clinicEmail);
      });
      /* 診療日・時間カード（表示のみ・診療カレンダー連動） */
      var dayLabels = ['日','月','火','水','木','金','土'];
      var dayStr = clinicSettings.workDays.map(function(d) { return dayLabels[d]; }).join('・');
      if (clinicSettings.holidayWork) dayStr += '・祝';
      h += stgCard('hours', '診療日・時間', function() {
        return stgRow('診療日', dayStr)
          + stgRow('午前診療時間', csTimeStr(clinicSettings.amStart) + ' 〜 ' + csTimeStr(clinicSettings.amEnd))
          + stgRow('午後診療時間', csTimeStr(clinicSettings.pmStart) + ' 〜 ' + csTimeStr(clinicSettings.pmEnd))
          + stgRow('施術時間', clinicSettings.treatmentMin + ' 分');
      }, { editable: false, note: '※ 診療カレンダーで変更' });
      /* カレンダー設定 */
      h += stgCard('calsetting', 'カレンダー設定', function(editing) {
        if (editing) {
          return '<div class="stg-row"><div class="stg-row-label">カレンダーの週始まり</div><div class="stg-row-input">'
            + '<select id="stg-calendarWeekStart">'
            + '<option value="monday"' + (stgData.calendarWeekStart==='monday'?' selected':'') + '>月曜始まり</option>'
            + '<option value="sunday"' + (stgData.calendarWeekStart==='sunday'?' selected':'') + '>日曜始まり</option>'
            + '</select></div></div>';
        }
        return stgRow('カレンダーの週始まり', stgData.calendarWeekStart === 'monday' ? '月曜始まり' : '日曜始まり');
      });
      h += '</div>';
      return h;
    },
    'booking': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">予約・予約取消設定</div>';
      h += stgCard('booking', '予約受付', function(editing) {
        if (editing) {
          return stgDeadlineEditRow('予約受付の締め切り', 'booking', stgData.bookingDeadlineEnabled, stgData.bookingDeadlineDay, stgData.bookingDeadlineType, stgData.bookingDeadlineTime, stgData.bookingDeadlineMin)
               + stgDeadlineEditRow('オンラインでの取消期限', 'cancel', stgData.cancelDeadlineEnabled, stgData.cancelDeadlineDay, stgData.cancelDeadlineType, stgData.cancelDeadlineTime, stgData.cancelDeadlineMin);
        }
        var bookingDisplay = stgData.bookingDeadlineEnabled ? stgDeadlineDisplayText(stgData.bookingDeadlineDay, stgData.bookingDeadlineType, stgData.bookingDeadlineTime, stgData.bookingDeadlineMin) : 'なし（制限なく予約可能）';
        var cancelDisplay = stgData.cancelDeadlineEnabled ? stgDeadlineDisplayText(stgData.cancelDeadlineDay, stgData.cancelDeadlineType, stgData.cancelDeadlineTime, stgData.cancelDeadlineMin) + '（以降は電話での取消）' : 'なし（制限なく取消可能）';
        return stgRow('予約受付の締め切り', bookingDisplay)
             + stgRow('オンラインでの取消期限', cancelDisplay);
      });
      h += '</div>';
      return h;
    },
    'notify': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">通知設定</div>';
      h += stgCard('notify', '通知設定', function(editing) {
        if (editing) {
          var r = stgRowToggleEdit('予約確認メール', 'notifyEmail');
          r += '<div class="stg-row"><div class="stg-row-label">リマインド通知のタイミング</div>';
          r += '<div class="stg-row-value" style="display:flex;align-items:center;gap:6px;font-size:13px;">';
          var remindOpts = ['当日','前日','2日前','3日前'];
          r += '<select id="stg-remindDayBefore" style="padding:5px 8px;border:1.5px solid #d1d5db;border-radius:6px;font-size:13px;font-family:inherit;outline:none;" onfocus="this.style.borderColor=\'#3b82f6\'" onblur="this.style.borderColor=\'#d1d5db\'">';
          remindOpts.forEach(function(opt) {
            r += '<option value="' + opt + '"' + (stgData.remindDayBefore === opt ? ' selected' : '') + '>' + opt + '</option>';
          });
          r += '</select>';
          r += 'の';
          r += '<input type="text" id="stg-remindTimeVal" value="' + stgData.remindTimeVal + '" placeholder="18:00" style="width:64px;padding:5px 8px;border:1.5px solid #d1d5db;border-radius:6px;font-size:13px;font-family:inherit;text-align:center;outline:none;" onfocus="this.style.borderColor=\'#3b82f6\'" onblur="this.style.borderColor=\'#d1d5db\'">';
          r += '</div></div>';
          return r;
        }
        return stgRowToggle('予約確認メール', 'notifyEmail')
          + stgRow('リマインド通知のタイミング', stgData.remindDayBefore + ' の ' + stgData.remindTimeVal);
      });
      h += '</div>';
      return h;
    },
    'reception': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">受付画面設定</div>';
      h += stgCard('reception', '患者受付', function(editing) {
        if (editing) {
          return '<div class="stg-row"><div class="stg-row-label">患者IDの桁数</div><div class="stg-row-input">'
            + '<select id="stg-patientIdDigits"><option value="4"' + (stgData.patientIdDigits==='4'?' selected':'') + '>4桁</option>'
            + '<option value="5"' + (stgData.patientIdDigits==='5'?' selected':'') + '>5桁</option>'
            + '<option value="6"' + (stgData.patientIdDigits==='6'?' selected':'') + '>6桁</option>'
            + '<option value="8"' + (stgData.patientIdDigits==='8'?' selected':'') + '>8桁</option></select></div></div>';
        }
        return stgRow('患者IDの桁数', stgData.patientIdDigits + '桁');
      });
      h += '</div>';
      return h;
    },
    'patient-num': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">患者番号・カルテ設定</div>';
      h += stgCard('patnum', '番号設定', function(editing) {
        if (editing) {
          return '<div class="stg-row"><div class="stg-row-label">患者番号の採番ルール</div><div class="stg-row-input">'
            + '<select id="stg-numberRule"><option value="自動採番"' + (stgData.numberRule==='自動採番'?' selected':'') + '>自動採番</option>'
            + '<option value="手動入力"' + (stgData.numberRule==='手動入力'?' selected':'') + '>手動入力</option></select></div></div>'
            + stgRowInput('カルテ番号の形式', 'stg-karteFormat', stgData.karteFormat);
        }
        return stgRow('患者番号の採番ルール', stgData.numberRule)
          + stgRow('カルテ番号の形式', stgData.karteFormat);
      });
      h += '</div>';
      return h;
    },
    'security': function() {
      var h = '<div style="padding:16px;">';
      h += '<div class="stg-page-title">セキュリティ</div>';
      var secItems = [
        { key: 'editClinic', label: '院の基本情報の編集' },
        { key: 'editDoctor', label: '担当医の追加・編集・削除' },
        { key: 'deletePatient', label: '患者情報の削除' },
        { key: 'exportData', label: 'データのエクスポート' },
        { key: 'accessSettings', label: '設定画面全体へのアクセス' }
      ];
      h += stgCard('sec-ops', '管理者パスワードが必要な操作', function(editing) {
        var r = '';
        var pe = editing ? '' : 'pointer-events:none;';
        var cur = editing ? 'cursor:pointer;' : 'cursor:default;';
        secItems.forEach(function(item) {
          var checked = stgData.secRequirePassword[item.key] ? ' checked' : '';
          r += '<div class="stg-row">';
          r += '<label style="display:flex;align-items:center;gap:10px;' + cur + 'font-size:13px;font-weight:500;color:#1a1a1a;' + pe + '">';
          r += '<input type="checkbox" id="stg-sec-' + item.key + '"' + checked + ' style="width:16px;height:16px;' + cur + '">';
          r += item.label;
          r += '</label></div>';
        });
        return r;
      });
      h += stgCard('sec-pw', '管理者パスワード', function(editing) {
        if (editing) {
          return '<div class="stg-row"><div class="stg-row-label">現在のパスワード</div><div class="stg-row-input"><input type="password" id="stg-pw-current" placeholder="現在のパスワード"></div></div>'
            + '<div class="stg-row"><div class="stg-row-label">新しいパスワード</div><div class="stg-row-input"><input type="password" id="stg-pw-new" placeholder="新しいパスワード"></div></div>'
            + '<div class="stg-row"><div class="stg-row-label">確認用パスワード</div><div class="stg-row-input"><input type="password" id="stg-pw-confirm" placeholder="新しいパスワード（確認）"></div></div>';
        }
        return stgRow('パスワード', '●●●●●●●●');
      });
      h += '</div>';
      return h;
    },
    'export': stgComingSoon
  };

  function stgComingSoon() {
    return stgPlaceholder('近日公開予定');
  }


  /* Keep pastVisitOrder synced for patient-detail page */
  var pastVisitOrder = 'desc';

  /* ════ Toast ════ */
  let toastTimer;
  function showToast(msg, icon = '✅') {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').textContent = msg;
    document.getElementById('toast-icon').textContent = icon;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 3200);
  }

  function overlayClick(e, id) {
    if (e.target !== document.getElementById(id)) return;
    if (id === 'modal-detail') closeDetail();
    else if (id === 'modal-booking') closeBooking();
    else if (id === 'modal-slot-action') closeSlotAction();
    else if (id === 'modal-bulk-stop') closeBulkStop();
    else if (id === 'modal-pd-cancel') closePdCancel();
    else if (id === 'modal-move-confirm') closeMoveConfirm();
  }

  /* ════ Detail modal ════ */
  let currentGanttKey = null, cancelStep = 0;

  function openDetailGantt(key) {
    currentGanttKey = key;
    const res = reservations[key];
    const [docId, time] = key.split('_');
    const doc = DOCTORS.find(d => d.id === docId);

    document.getElementById('d-name').textContent = res.name;
    /* ⑦-2 診察券番号をクリッカブルリンクに */
    document.getElementById('d-card').innerHTML =
      `<button class="card-link" onclick="openPatientDetail('${res.card}')">${res.card}</button>`;
    document.getElementById('d-time').textContent = todayStr + ' ' + time;
    var docLabel = buildDoctorDetailLabel(res, docId);
    document.getElementById('d-doctor').innerHTML = `<span style="font-weight:700;color:#000000;">${docLabel}</span>`;
    document.getElementById('d-status').innerHTML = makeStatusBadge(res.status);

    /* ⑦-1 ステータスに応じてボタン切替 */
    cancelStep = 0;
    purgeStep = 0;
    document.getElementById('cancel-confirm-view').classList.remove('show');
    document.getElementById('purge-confirm-view').classList.remove('show');

    if (res.status === '来院済') {
      document.getElementById('detail-actions-normal').style.display = 'none';
      document.getElementById('detail-actions-visited').style.display = '';
      const btnPurge = document.getElementById('btn-purge');
      btnPurge.textContent = '全て取消';
      btnPurge.style.background = '';
    } else {
      document.getElementById('detail-actions-normal').style.display = '';
      document.getElementById('detail-actions-visited').style.display = 'none';
      const btnArrival = document.getElementById('btn-arrival');
      btnArrival.disabled = false;
      btnArrival.textContent = '来院';
      btnArrival.className = 'btn btn-success';
      const btnCancel = document.getElementById('btn-cancel');
      btnCancel.textContent = '予約取消';
      btnCancel.style.background = '';
      console.log('ボタンテキスト設定:', btnCancel.textContent);
    }

    document.getElementById('modal-detail').classList.add('open');
  }

  /* ⑦-1 来院ボタン処理（来院記録 ↔ 来院取消） */
  function handleArrival() {
    if (!currentGanttKey) return;
    const res = reservations[currentGanttKey];
    const name = res.name;
    if (res.status === '来院済') {
      /* 来院取消 → 予約済に戻す */
      reservations[currentGanttKey].status = '予約済';
      closeDetail();
      renderGantt();
      showToast(name + 'さんの来院記録を取り消しました', '↩️');
    } else {
      /* 来院記録 */
      reservations[currentGanttKey].status = '来院済';
      closeDetail();
      renderGantt();
      showToast(name + 'さんの来院を記録しました', '✅');
    }
  }

  function closeDetail() {
    document.getElementById('modal-detail').classList.remove('open');
    currentGanttKey = null; cancelStep = 0; purgeStep = 0;
  }

  function handleCancel() {
    if (cancelStep === 0) {
      document.getElementById('cancel-confirm-view').classList.add('show');
      const btn = document.getElementById('btn-cancel');
      btn.textContent = '本当に取り消す';
      btn.style.background = 'hsl(0,72%,38%)';
      cancelStep = 1;
    } else {
      if (!currentGanttKey) return;
      const name = reservations[currentGanttKey].name;
      reservations[currentGanttKey].status = 'キャンセル'; /* ④ → appears as empty */
      var parts = currentGanttKey.split('_');
      var docId = parts[0];
      var timeStr = parts[1];
      listDateReservations[currentGanttKey] = { status: 'キャンセル' };
      autoStopIfNeeded(docId, timeStr);
      closeDetail();
      activeRenderGantt();
      showToast(`${name}さんの予約をキャンセルしました`, '❌');
    }
  }

  let purgeStep = 0;

  function handlePurge() {
    if (purgeStep === 0) {
      document.getElementById('purge-confirm-view').classList.add('show');
      const btn = document.getElementById('btn-purge');
      btn.textContent = '全て取消';
      btn.style.background = 'hsl(0,72%,38%)';
      purgeStep = 1;
    } else {
      if (!currentGanttKey) return;
      const res = getActiveReservations()[currentGanttKey];
      if (!res) return;
      const name = res.name;
      const card = res.card;
      var parts = currentGanttKey.split('_');
      var docId = parts[0];
      var timeStr = parts[1];
      /* ガントチャート・予約データから完全削除 */
      delete reservations[currentGanttKey];
      delete listDateReservations[currentGanttKey];
      autoStopIfNeeded(docId, timeStr);
      closeDetail();
      activeRenderGantt();
      /* 患者情報画面が開いていれば再描画 */
      if (card && document.getElementById('modal-patient-detail') &&
          document.getElementById('modal-patient-detail').classList.contains('open')) {
        renderPatientReservations(card);
        renderPastVisits(card);
      }
      showToast(`${name}さんの来院記録と予約を取り消しました`, '❌');
    }
  }

  function makeStatusBadge(status) {
    const map = { '来院済': ['s-done','来院済'], '予約済': ['s-confirmed','予約済'], 'キャンセル': ['s-cancelled','キャンセル'] };
    const [cls, label] = map[status] || ['s-confirmed', status];
    return `<span class="status-badge ${cls}">${label}</span>`;
  }

  /* ════ Booking modal ════ */
  let currentBookingKey = null;
  const dummyNames = ['青木 翔太', '浜田 幸子', '三浦 康平', '福田 寛子', '岡田 誠司', '村田 理恵', '橋本 拓也'];

  /* ④ 空き枠タップ → 選択モーダル */
  let currentSlotActionKey = null, stopSlotStep = 0;

  /* 空き枠タップ → 直接予約入力モーダルへ */
  function openBookingGantt(docId, time) {
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    currentBookingKey = docId + '_' + time;
    document.getElementById('b-time').textContent = todayStr + ' ' + time;
    document.getElementById('b-doctor').innerHTML =
      '<span style="font-weight:700;color:#000000;">' + doc.name + '</span>';
    document.getElementById('b-card').value = '';
    document.getElementById('b-error').textContent = '';
    document.getElementById('modal-booking').classList.add('open');
    setTimeout(function() { document.getElementById('b-card').focus(); }, 220);
  }

  function closeSlotAction() {
    document.getElementById('modal-slot-action').classList.remove('open');
    /* 閉じた後に状態リセット（次回open時に再設定するため遅延） */
    setTimeout(function() { currentSlotActionKey = null; stopSlotStep = 0; }, 200);
  }

  /* 「予約を入れる」押下 — 選択モーダルを閉じてから予約入力モーダルを開く */
  function slotActionBook() {
    var key = currentSlotActionKey;      /* 先に取得してから閉じる */
    if (!key) return;
    document.getElementById('modal-slot-action').classList.remove('open');
    currentSlotActionKey = null;
    stopSlotStep = 0;

    var parts = key.split('_');
    var docId = parts[0];
    var time  = parts[1];
    var doc   = DOCTORS.find(function(d) { return d.id === docId; });

    currentBookingKey = key;
    document.getElementById('b-time').textContent = todayStr + ' ' + time;
    document.getElementById('b-doctor').innerHTML =
      '<span style="font-weight:700;color:#000000;">' + doc.name + '</span>';
    document.getElementById('b-card').value = '';
    document.getElementById('b-error').textContent = '';
    document.getElementById('modal-booking').classList.add('open');
    setTimeout(function() { document.getElementById('b-card').focus(); }, 220);
  }

  /* 「枠を停止する」— 2ステップ確認 */
  function handleStopSlot() {
    if (stopSlotStep === 0) {
      document.getElementById('stop-confirm-view').classList.add('show');
      var btn = document.getElementById('btn-stop-slot');
      btn.textContent = '本当に停止する';
      btn.className = 'btn btn-danger';
      stopSlotStep = 1;
    } else {
      var key = currentSlotActionKey;
      if (!key) return;
      var time = key.split('_')[1];
      reservations[key] = { status: '停止' };
      document.getElementById('modal-slot-action').classList.remove('open');
      currentSlotActionKey = null; stopSlotStep = 0;
      renderGantt();
      showToast(time + ' の枠を停止しました', '🚫');
    }
  }

  function closeBooking() {
    document.getElementById('modal-booking').classList.remove('open');
    document.getElementById('booking-confirm-view').classList.remove('show');
    document.getElementById('b-patient-name').style.display = 'none';
    const btn = document.getElementById('btn-confirm-booking');
    btn.textContent = '確認';
    btn.style.background = '';
    currentBookingKey = null;
    bookingStep = 0;
  }

  let stopBookingStep = 0;

  function stopCurrentSlot() {
    if (!currentBookingKey) return;
    const stopBtn = document.getElementById('btn-stop-booking');
    if (stopBookingStep === 0) {
      /* ステップ1：ボタンを「確認 →」に変えて確認を促す */
      stopBtn.textContent = '停止を確認 →';
      stopBtn.className = 'btn btn-danger';
      stopBookingStep = 1;
    } else {
      /* ステップ2：枠を停止して閉じる */
      const time = currentBookingKey.split('_')[1];
      reservations[currentBookingKey] = { status: '停止' };
      stopBookingStep = 0;
      closeBooking();
      renderGantt();
      showToast(time + ' の枠を停止しました', '🚫');
    }
  }

  /* ⑤ 時刻ヘッダークリック — 停止 / 解除両対応 */
  let currentBulkStopTime = null;

  function openTimeBulkStop(time) {
    var emptyDocs = DOCTORS.filter(function(doc) {
      var res = reservations[doc.id + '_' + time];
      return !res || res.status === 'キャンセル';
    });
    var stoppedDocs = DOCTORS.filter(function(doc) {
      var res = reservations[doc.id + '_' + time];
      return res && res.status === '停止';
    });

    if (emptyDocs.length === 0 && stoppedDocs.length === 0) {
      showToast(time + ' に操作できる枠がありません', 'ℹ️'); return;
    }

    currentBulkStopTime = time;
    document.getElementById('bs-subtitle').textContent = '対象時間帯：' + time;

    var stopSec     = document.getElementById('bs-stop-section');
    var unblockSec  = document.getElementById('bs-unblock-section');

    if (emptyDocs.length > 0) {
      stopSec.style.display = '';
      document.getElementById('bs-stop-msg').textContent =
        emptyDocs.map(function(d) { return d.name; }).join('・') +
        '（計 ' + emptyDocs.length + ' 枠）を予約停止します';
    } else {
      stopSec.style.display = 'none';
    }

    if (stoppedDocs.length > 0) {
      unblockSec.style.display = '';
      document.getElementById('bs-unblock-msg').textContent =
        stoppedDocs.map(function(d) { return d.name; }).join('・') +
        '（計 ' + stoppedDocs.length + ' 枠）の停止を解除します';
    } else {
      unblockSec.style.display = 'none';
    }

    document.getElementById('modal-bulk-stop').classList.add('open');
  }

  function closeBulkStop() {
    document.getElementById('modal-bulk-stop').classList.remove('open');
    currentBulkStopTime = null;
  }

  /* 空き枠を一括停止 */
  function executeBulkStop() {
    if (!currentBulkStopTime) return;
    var count = 0;
    DOCTORS.forEach(function(doc) {
      var key = doc.id + '_' + currentBulkStopTime;
      var res = reservations[key];
      if (!res || res.status === 'キャンセル') { reservations[key] = { status: '停止' }; count++; }
    });
    var t = currentBulkStopTime;
    closeBulkStop();
    renderGantt();
    showToast(t + ' の ' + count + ' 枠を停止しました', '🚫');
  }

  /* 停止枠を一括解除 */
  function executeBulkUnblock() {
    if (!currentBulkStopTime) return;
    var count = 0;
    DOCTORS.forEach(function(doc) {
      var key = doc.id + '_' + currentBulkStopTime;
      var res = reservations[key];
      if (res && res.status === '停止') { delete reservations[key]; count++; }
      if (autoBlockedSlots.has(key)) { autoBlockedSlots.delete(key); count++; }
    });
    var t = currentBulkStopTime;
    closeBulkStop();
    renderGantt();
    showToast(t + ' の ' + count + ' 枠の停止を解除しました', '✅');
  }

  /* 旧互換エイリアス */
  function confirmBulkStop() { executeBulkStop(); }

  let bookingStep = 0;

  function clearBookingError() {
    document.getElementById('b-error').textContent = '';
    /* 入力変更時はステップをリセット */
    if (bookingStep !== 0) {
      bookingStep = 0;
      document.getElementById('booking-confirm-view').classList.remove('show');
      document.getElementById('b-patient-name').style.display = 'none';
      const btn = document.getElementById('btn-confirm-booking');
      btn.textContent = '確認';
      btn.style.background = '';
    }
  }

  function confirmBooking() {
    const card = document.getElementById('b-card').value.trim();
    if (!card || !/^\d{4,}$/.test(card)) {
      document.getElementById('b-error').textContent = '診察券番号を4桁以上の数字で入力してください';
      return;
    }
    if (!currentBookingKey) return;

    if (bookingStep === 0) {
      /* ステップ1：患者名・確認ビューを表示してボタンを「確定」に変える */
      const previewName = PATIENT_DATA[card] ? PATIENT_DATA[card].name : dummyNames[parseInt(card.slice(-1)) % dummyNames.length];
      document.getElementById('b-patient-name-text').textContent = previewName;
      document.getElementById('b-patient-name').style.display = 'block';
      document.getElementById('booking-confirm-view').classList.add('show');
      const btn = document.getElementById('btn-confirm-booking');
      btn.textContent = '確定';
      btn.style.background = 'hsl(142,71%,32%)';
      bookingStep = 1;
    } else {
      /* ステップ2：予約を実行 */
      const name = PATIENT_DATA[card] ? PATIENT_DATA[card].name : dummyNames[parseInt(card.slice(-1)) % dummyNames.length];
      const time = currentBookingKey.split('_')[1];
      reservations[currentBookingKey] = { name, card, status: '予約済' };
      closeBooking();
      renderGantt();
      showToast(`${time} に ${name}さんの予約を追加しました`);
      /* ⑧ 予約確定後、患者情報詳細へ自動遷移 */
      openPatientDetail(card, 'dashboard');
    }
  }

  /* ════════════════════════════════════════
     予約一覧ページ — カレンダー + ガントチャート
     ════════════════════════════════════════ */

  /* Context */
  let ganttContext = 'dashboard';
  let listDateReservations = {};
  let rlSelectedDate = null;
  let rlCurrentYear = todayYear;
  let rlCurrentMonth = todayMonth;
  const RL_MIN_YEAR = 2026, RL_MIN_MONTH = 1;
  const RL_MAX_YEAR = 2026, RL_MAX_MONTH = 8;

  /* 2026年 祝日データ */
  var HOLIDAYS_2026 = {
    '2026-01-01': '元日',
    '2026-01-12': '成人の日',
    '2026-02-11': '建国記念の日',
    '2026-02-23': '天皇誕生日',
    '2026-03-20': '春分の日',
    '2026-04-29': '昭和の日',
    '2026-05-03': '憲法記念日',
    '2026-05-04': 'みどりの日',
    '2026-05-05': 'こどもの日',
    '2026-05-06': '振替休日',
    '2026-07-20': '海の日',
    '2026-08-11': '山の日'
  };
  function isHoliday(year, month, day) {
    var key = year + '-' + (month < 10 ? '0' + month : month) + '-' + (day < 10 ? '0' + day : day);
    return HOLIDAYS_2026[key] || null;
  }

  function getActiveReservations() {
    return ganttContext === 'list' ? listDateReservations : reservations;
  }
  function activeRenderGantt() {
    if (ganttContext === 'list') renderListGantt();
    else renderGantt();
  }

  /* Date helpers */
  function getDaysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
  function getDayOfWeek(y, m, d) { return new Date(y, m - 1, d).getDay(); }
  function formatDateJP(y, m, d) {
    var dow = ['日','月','火','水','木','金','土'];
    return y + '年' + m + '月' + d + '日（' + dow[new Date(y, m - 1, d).getDay()] + '）';
  }

  /* Mock data generation */
  function seededRandom(seed) {
    var x = Math.sin(seed + 1) * 10000;
    return x - Math.floor(x);
  }

  function generateDayReservations(year, month, day) {
    var dayOfWeek = new Date(year, month - 1, day).getDay();
    if (dayOfWeek === 0) return null;
    if (year === todayYear && month === todayMonth && day === todayDate) {
      var clone = {};
      Object.keys(reservations).forEach(function(k) { clone[k] = Object.assign({}, reservations[k]); });
      return clone;
    }
    /* 翌々月以降は全て空き枠（予約なし） */
    var nextMonthEnd = new Date(todayYear, TODAY.getMonth() + 2, 0); /* 翌月末 */
    var selDate = new Date(year, month - 1, day);
    if (selDate > nextMonthEnd) return {};
    var dateNum = year * 10000 + month * 100 + day;
    var res = {};
    var patientKeys = Object.keys(PATIENT_DATA);
    DOCTORS.forEach(function(doc, di) {
      ALL_SLOTS.forEach(function(time, ti) {
        var seed = dateNum * 100 + di * 30 + ti;
        var r = seededRandom(seed);
        var lowDays = { 5:1, 12:1, 17:1, 21:1, 26:1 };
        var threshold = lowDays[day] ? 0.20 : 0.55;
        if (r < threshold) {
          var pIdx = Math.floor(seededRandom(seed + 500) * patientKeys.length);
          var card = patientKeys[pIdx];
          var patient = PATIENT_DATA[card];
          var docPref = seededRandom(seed + 700) < 0.5;
          res[doc.id + '_' + time] = { name: patient.name, card: card, status: '予約済', doctorPreferred: docPref, doctorHistory: [] };
        } else if (r < threshold + 0.05) {
          res[doc.id + '_' + time] = { status: '停止' };
        }
      });
    });
    /* 過去日付: 全て来院済にしてからランダムに0〜2件だけ未処理（予約済）に戻す */
    var todayRef = new Date(todayYear, TODAY.getMonth(), todayDate);
    var selDate = new Date(year, month - 1, day);
    if (selDate < todayRef) {
      var bookedKeys = Object.keys(res).filter(function(k) { return res[k].status === '予約済'; });
      bookedKeys.forEach(function(k) { res[k].status = '来院済'; });
      var unprocessedCount = Math.floor(seededRandom(dateNum + 9999) * 3); /* 0〜2 */
      for (var ui = 0; ui < unprocessedCount && ui < bookedKeys.length; ui++) {
        res[bookedKeys[ui]].status = '予約済';
      }
    }
    return res;
  }

  function countDayReservations(year, month, day) {
    var data = generateDayReservations(year, month, day);
    if (data === null) return null;
    var booked = 0, stopped = 0;
    var totalAll = DOCTORS.length * ALL_SLOTS.length;
    Object.values(data).forEach(function(v) {
      if (v.status === '予約済' || v.status === '来院済') booked++;
      if (v.status === '停止') stopped++;
    });
    return { booked: booked, total: totalAll - stopped };
  }

  function rlIsPastSlot(time) {
    if (!rlSelectedDate) return false;
    var sel = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
    var todayRef = new Date(todayYear, TODAY.getMonth(), todayDate);
    todayRef.setHours(0,0,0,0);
    if (sel < todayRef) return true;
    if (sel > todayRef) return false;
    return isPastSlot(time);
  }

  /* ═══ Calendar rendering ═══ */
  var calendarCache = {}; /* { "YYYY-MM": { days: {...}, kpi: {...} } } */
  var SLOTS_PER_STAFF = 25; /* 午前13枠 + 午後12枠 */

  function aggregateMonthData(reservations, year, month, staffCount, newPatients) {
    var daysInMonth = getDaysInMonth(year, month);
    /* 日付ごとに集計 */
    var dayMap = {};
    var monthBooked = 0, monthCancelled = 0, monthTotal = 0;
    var monthPatients = {};

    (reservations || []).forEach(function(r) {
      if (!dayMap[r.date]) dayMap[r.date] = { booked: 0, cancelled: 0, patients: {} };
      var entry = dayMap[r.date];
      if (r.status === 'cancelled') {
        entry.cancelled++;
      } else {
        entry.booked++;
        if (r.patientId) entry.patients[r.patientId] = true;
      }
    });

    var totalPerDay = staffCount * SLOTS_PER_STAFF;
    var days = {};
    for (var d = 1; d <= daysInMonth; d++) {
      var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(d).padStart(2, '0');
      var dow = new Date(year, month - 1, d).getDay();
      if (dow === 0) {
        days[d] = { closed: true, booked: 0, total: 0 };
        continue;
      }
      var entry = dayMap[dateStr];
      var booked = entry ? entry.booked : 0;
      var cancelled = entry ? entry.cancelled : 0;
      days[d] = { closed: false, booked: booked, total: totalPerDay };
      monthBooked += booked;
      monthCancelled += cancelled;
      monthTotal += totalPerDay;
      if (entry) Object.keys(entry.patients).forEach(function(p) { monthPatients[p] = true; });
    }

    var uniquePatients = Object.keys(monthPatients).length;
    var utilRate = monthTotal > 0 ? Math.round((monthBooked / monthTotal) * 100) : 0;
    var cancelRate = (monthBooked + monthCancelled) > 0
      ? Math.round((monthCancelled / (monthBooked + monthCancelled)) * 100) : 0;
    var newCount = newPatients || 0;
    var repeatRate = uniquePatients > 0
      ? Math.round(((uniquePatients - newCount) / uniquePatients) * 100) : 0;

    return {
      days: days,
      kpi: {
        reservations: monthBooked,
        utilization: utilRate,
        cancelRate: cancelRate,
        repeatRate: repeatRate,
        newPatients: newCount,
        uniquePatients: uniquePatients
      }
    };
  }

  function renderCalendar() {
    var year = rlCurrentYear, month = rlCurrentMonth;
    var daysInMonth = getDaysInMonth(year, month);
    var firstDow = getDayOfWeek(year, month, 1);
    var sel = document.getElementById('rl-month-select');
    sel.value = year + '-' + (month < 10 ? '0' + month : month);
    document.getElementById('rl-prev-btn').disabled = (year === RL_MIN_YEAR && month <= RL_MIN_MONTH);
    document.getElementById('rl-next-btn').disabled = (year === RL_MAX_YEAR && month >= RL_MAX_MONTH);
    document.getElementById('rl-month-title').textContent = year + '年' + month + '月';

    var monthKey = year + '-' + (month < 10 ? '0' + month : month);
    var cached = calendarCache[monthKey];

    /* キャッシュがあればそのまま描画 */
    if (cached) {
      renderCalendarGrid(year, month, daysInMonth, firstDow, cached.days);
      applyMonthlyKPI(cached.kpi);
      return;
    }

    /* プレースホルダー描画 */
    renderCalendarGrid(year, month, daysInMonth, firstDow, null);
    applyMonthlyKPI(null);

    /* 既存の /api/admin/reservations?month= を1回だけ呼び出し */
    fetch('/api/admin/reservations?month=' + monthKey)
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function(data) {
        var result = aggregateMonthData(data.reservations, year, month, data.staffCount || 3, data.newPatients || 0);
        calendarCache[monthKey] = result;
        if (rlCurrentYear === year && rlCurrentMonth === month) {
          renderCalendarGrid(year, month, daysInMonth, firstDow, result.days);
          applyMonthlyKPI(result.kpi);
        }
      })
      .catch(function(e) { console.error('月間データ取得エラー:', e); });
  }

  function renderCalendarGrid(year, month, daysInMonth, firstDow, daysData) {
    var html = '<div class="rl-dow-row">';
    ['月','火','水','木','金','土','日'].forEach(function(d, i) {
      var cls = 'rl-dow-cell';
      if (i === 5) cls += ' rl-dow-sat';
      if (i === 6) cls += ' rl-dow-sun';
      html += '<div class="' + cls + '">' + d + '</div>';
    });
    html += '</div><div class="rl-days-grid">';
    var firstDowMon = (firstDow + 6) % 7;
    for (var i = 0; i < firstDowMon; i++) html += '<div class="rl-day-cell rl-day-empty"></div>';

    var todayRef = new Date(todayYear, TODAY.getMonth(), todayDate);
    for (var d = 1; d <= daysInMonth; d++) {
      var dow = getDayOfWeek(year, month, d);
      var dayInfo = daysData ? daysData[d] : null;
      var isClosed = dow === 0 || (dayInfo && dayInfo.closed);
      var loading = !daysData && dow !== 0;
      var booked = dayInfo ? dayInfo.booked : 0;
      var total = dayInfo ? dayInfo.total : 0;
      var isToday = (year === todayYear && month === todayMonth && d === todayDate);
      var isPast = new Date(year, month - 1, d) < todayRef;
      var cellClass = 'rl-day-cell';
      var holidayName = isHoliday(year, month, d);
      cellClass += isClosed ? ' rl-day-closed' : ' rl-day-active';
      if (holidayName && dow !== 0) cellClass += ' rl-day-holiday';
      if (isToday) cellClass += ' rl-day-today';
      if (dow === 0) cellClass += ' rl-day-sun';
      if (dow === 6) cellClass += ' rl-day-sat';
      if (isPast) cellClass += ' rl-day-past';
      if (!isClosed && !loading) {
        var utilPct = total > 0 ? (booked / total) * 100 : 0;
        if (utilPct < 50) cellClass += ' rl-day-util-low';
      }

      if (!isClosed) {
        var countDisplay = loading
          ? '<div class="rl-day-count" style="color:#aaa;">読込中...</div>'
          : '<div class="rl-day-count"><span class="rl-count-label">予約数</span><span class="rl-count-val">' + booked + '</span><span class="rl-count-total">/' + total + '</span></div>';
        html += '<div class="' + cellClass + '" onclick="rlOpenDay(' + year + ',' + month + ',' + d + ')">'
              + '<div class="rl-day-num">' + d + '</div>'
              + countDisplay + '</div>';
      } else {
        html += '<div class="' + cellClass + '"><div class="rl-day-num">' + d + '</div>'
              + '<div class="rl-day-label-closed">休診日</div></div>';
      }
    }
    var lastDow = getDayOfWeek(year, month, daysInMonth);
    var lastDowMon = (lastDow + 6) % 7;
    for (var i = lastDowMon + 1; i < 7; i++) html += '<div class="rl-day-cell rl-day-empty"></div>';
    html += '</div>';
    document.getElementById('rl-calendar-grid').innerHTML = html;
  }

  /* ═══ Monthly KPI ═══ */
  function applyMonthlyKPI(kpi) {
    if (!kpi) {
      document.getElementById('rl-kpi-reservations').innerHTML = '—';
      document.getElementById('rl-kpi-utilization').innerHTML = '—';
      document.getElementById('rl-kpi-cancel').innerHTML = '—';
      document.getElementById('rl-kpi-repeat').innerHTML = '—';
      document.getElementById('rl-kpi-new').innerHTML = '—';
      document.getElementById('rl-kpi-sameday').innerHTML = '—';
      return;
    }
    document.getElementById('rl-kpi-reservations').innerHTML = kpi.reservations + '<span style="font-size:16px;font-weight:700;">件</span>';
    document.getElementById('rl-kpi-utilization').innerHTML = kpi.utilization + '<span style="font-size:16px;font-weight:700;">%</span>';
    document.getElementById('rl-kpi-cancel').innerHTML = kpi.cancelRate + '<span style="font-size:16px;font-weight:700;">%</span>';
    document.getElementById('rl-kpi-repeat').innerHTML = kpi.repeatRate + '<span style="font-size:16px;font-weight:700;">%</span>';
    document.getElementById('rl-kpi-new').innerHTML = kpi.newPatients + '<span style="font-size:16px;font-weight:700;">人</span>';
    document.getElementById('rl-kpi-sameday').innerHTML = kpi.uniquePatients + '<span style="font-size:16px;font-weight:700;">人</span>';
  }

  /* Calendar navigation */
  function rlPrevMonth() {
    if (rlCurrentYear === RL_MIN_YEAR && rlCurrentMonth <= RL_MIN_MONTH) return;
    rlCurrentMonth--;
    if (rlCurrentMonth < 1) { rlCurrentMonth = 12; rlCurrentYear--; }
    renderCalendar();
  }
  function rlNextMonth() {
    if (rlCurrentYear === RL_MAX_YEAR && rlCurrentMonth >= RL_MAX_MONTH) return;
    rlCurrentMonth++;
    if (rlCurrentMonth > 12) { rlCurrentMonth = 1; rlCurrentYear++; }
    renderCalendar();
  }
  function rlGoToMonth() {
    var parts = document.getElementById('rl-month-select').value.split('-');
    rlCurrentYear = parseInt(parts[0]);
    rlCurrentMonth = parseInt(parts[1]);
    renderCalendar();
  }

  /* ═══ Open day gantt ═══ */
  function rlOpenDay(year, month, day) {
    rlSelectedDate = { year: year, month: month, day: day };
    ganttContext = 'list';
    listDateReservations = generateDayReservations(year, month, day);
    if (listDateReservations === null) listDateReservations = {};

    // APIから該当日の予約データを読み込んで listDateReservations を上書き
    var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
    loadReservationDataForDate(dateStr).then(function(apiRes) {
      listDateReservations = apiRes;
      renderListGantt();
    }).catch(function() {});

    // 担当医の勤務時間外・休診をガントチャートに反映
    (function() {
      var dowNumMap = { 'sun':0, 'mon':1, 'tue':2, 'wed':3, 'thu':4, 'fri':5, 'sat':6 };
      var dowNameMap = { 0:'sun', 1:'mon', 2:'tue', 3:'wed', 4:'thu', 5:'fri', 6:'sat' };
      var viewDate = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
      var viewDow = viewDate.getDay(); // 0=日,1=月...
      var viewDateStr = viewDate.toISOString().split('T')[0];

      // 全時間枠リスト
      var morningSlots = ['09:00','09:20','09:40','10:00','10:20','10:40','11:00','11:20','11:40','12:00','12:20','12:40'];
      var afternoonSlots = ['16:00','16:20','16:40','17:00','17:20','17:40','18:00','18:20','18:40','19:00','19:20','19:40'];

      // 時刻文字列を分に変換（例: "09:00" → 540）
      function toMin(str) {
        if (!str) return 0;
        var parts = str.split(':');
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      }

      // 枠を停止にする（既存予約は上書きしない）
      function stopSlot(docId, time) {
        var key = docId + '_' + time;
        if (!listDateReservations[key] || listDateReservations[key].status === '空き') {
          listDateReservations[key] = { status: '停止' };
        }
      }

      // 停止を解除する（手動停止でないもののみ）
      function clearAutoStop(docId, time) {
        var key = docId + '_' + time;
        if (listDateReservations[key] &&
            listDateReservations[key].status === '停止' &&
            !listDateReservations[key].name) {
          delete listDateReservations[key];
        }
      }

      DOCTORS.forEach(function(doc) {
        var map = docKyushinMap[doc.id];
        var effectiveDate = map ? map.effectiveDate : null;

        // 反映日前は処理しない
        if (effectiveDate && viewDateStr < effectiveDate) return;

        var scheduleNum = String(viewDow); // scheduleのキーは数字文字列
        var daySchedule = staffScheduleStore[doc.id] &&
                          staffScheduleStore[doc.id].schedule &&
                          staffScheduleStore[doc.id].schedule[scheduleNum];

        // 休診日（scheduleにキーなし）→ 全枠停止
        if (!daySchedule) {
          morningSlots.forEach(function(t) { stopSlot(doc.id, t); });
          afternoonSlots.forEach(function(t) { stopSlot(doc.id, t); });
          return;
        }

        // 午前の処理
        if (!daySchedule.am) {
          morningSlots.forEach(function(t) { stopSlot(doc.id, t); });
        } else {
          var amParts = daySchedule.am.split('〜');
          var amStart = toMin(amParts[0]);
          var amEnd = toMin(amParts[1]);
          morningSlots.forEach(function(t) {
            var tMin = toMin(t);
            if (tMin < amStart || tMin >= amEnd) {
              stopSlot(doc.id, t);
            } else {
              clearAutoStop(doc.id, t);
            }
          });
        }

        // 午後の処理
        if (!daySchedule.pm) {
          afternoonSlots.forEach(function(t) { stopSlot(doc.id, t); });
        } else {
          var pmParts = daySchedule.pm.split('〜');
          var pmStart = toMin(pmParts[0]);
          var pmEnd = toMin(pmParts[1]);
          afternoonSlots.forEach(function(t) {
            var tMin = toMin(t);
            if (tMin < pmStart || tMin >= pmEnd) {
              stopSlot(doc.id, t);
            } else {
              clearAutoStop(doc.id, t);
            }
          });
        }
      });
    })();

    document.getElementById('list-calendar-view').style.display = 'none';
    document.getElementById('list-gantt-view').style.display = 'flex';
    document.getElementById('rl-gantt-date').textContent = formatDateJP(year, month, day);
    updateRlDayNav();
    renderListGantt();
  }

  function updateRlDayNav() {
    var y = rlSelectedDate.year, m = rlSelectedDate.month, d = rlSelectedDate.day;
    var prevDate = new Date(y, m - 1, d - 1);
    var minDate = new Date(RL_MIN_YEAR, RL_MIN_MONTH - 1, 1);
    document.getElementById('rl-prev-day').disabled = (prevDate < minDate);
    var nextDate = new Date(y, m - 1, d + 1);
    var maxDate = new Date(RL_MAX_YEAR, RL_MAX_MONTH, 0);
    document.getElementById('rl-next-day').disabled = (nextDate > maxDate);
  }

  function rlIsClosedDay(dt) {
    return dt.getDay() === 0;
  }
  function rlPrevDay() {
    var y = rlSelectedDate.year, m = rlSelectedDate.month, d = rlSelectedDate.day;
    var prev = new Date(y, m - 1, d - 1);
    /* 日曜・祝日を飛ばす */
    while (rlIsClosedDay(prev)) prev.setDate(prev.getDate() - 1);
    cancelBlockMode();
    rlOpenDay(prev.getFullYear(), prev.getMonth() + 1, prev.getDate());
  }
  function rlNextDay() {
    var y = rlSelectedDate.year, m = rlSelectedDate.month, d = rlSelectedDate.day;
    var next = new Date(y, m - 1, d + 1);
    /* 日曜・祝日を飛ばす */
    while (rlIsClosedDay(next)) next.setDate(next.getDate() + 1);
    cancelBlockMode();
    rlOpenDay(next.getFullYear(), next.getMonth() + 1, next.getDate());
  }
  function rlBackToCalendar() {
    cancelBlockMode();
    ganttContext = 'dashboard';
    rlSelectedDate = null;
    document.getElementById('list-gantt-view').style.display = 'none';
    document.getElementById('list-calendar-view').style.display = 'flex';
    renderCalendar();
  }

  /* ═══ List gantt rendering ═══ */
  function getListDateMode() {
    if (!rlSelectedDate) return 'today';
    var sel = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
    var todayRef = new Date(todayYear, TODAY.getMonth(), todayDate);
    todayRef.setHours(0,0,0,0);
    sel.setHours(0,0,0,0);
    if (sel < todayRef) return 'past';
    if (sel > todayRef) return 'future';
    return 'today';
  }

  function renderListGantt() {
    var mode = getListDateMode();
    var dow = rlSelectedDate
      ? new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day).getDay()
      : TODAY.getDay();
    rebuildAutoBlockedSlots(dow, listDateReservations);
    renderSection('rl-gantt-morning', MORNING, listDateReservations, rlIsPastSlot, mode, dow);
    renderSection('rl-gantt-afternoon', AFTERNOON, listDateReservations, rlIsPastSlot, mode, dow);
    updateListCounters();
    updateListUnprocessedAlert();
    autoFitCellNames();
  }

  function updateListUnprocessedAlert() {
    var el = document.getElementById('rl-unprocessed-alert');
    var countEl = document.getElementById('rl-unprocessed-count');
    var mode = getListDateMode();

    /* 当日のみアラート表示、過去・未来は非表示 */
    if (mode !== 'today') {
      el.style.display = 'none';
      return;
    }

    var count = 0;
    DOCTORS.forEach(function(doc) {
      ALL_SLOTS.forEach(function(time) {
        if (!isPastSlot(time)) return;
        var res = listDateReservations[doc.id + '_' + time];
        if (res && res.status !== 'キャンセル' && res.status !== '停止' && res.status !== '来院済') count++;
      });
    });

    if (count > 0) {
      el.style.display = 'inline-flex';
      countEl.textContent = count;
      // 改行されない範囲で最大フォントサイズに自動調整
      var nav = document.querySelector('.rl-gantt-nav');
      var summaryBar = document.getElementById('rl-summary-bar');
      if (nav) {
        el.style.fontSize = '16px';
        var fontSize = 16;
        while (fontSize > 10 && (nav.scrollWidth > nav.clientWidth || (summaryBar && summaryBar.scrollWidth > summaryBar.clientWidth))) {
          fontSize--;
          el.style.fontSize = fontSize + 'px';
        }
      }
    } else {
      el.style.display = 'none';
    }
  }

  function updateListCounters() {
    var reserved = 0;
    var total = DOCTORS.length * ALL_SLOTS.length;
    var perDoc = {};
    DOCTORS.forEach(function(d) { perDoc[d.id] = { r: 0 }; });
    DOCTORS.forEach(function(doc) {
      ALL_SLOTS.forEach(function(time) {
        var res = listDateReservations[doc.id + '_' + time];
        if (res && (res.status === '予約済' || res.status === '来院済' || res.status === '未処理')) {
          reserved++; perDoc[doc.id].r++;
        }
      });
    });
    var el = document.getElementById('rl-stat-reservations');
    if (el) el.textContent = reserved + '件';
    var utilEl = document.getElementById('rl-stat-utilization');
    if (utilEl) {
      var utilPct = total > 0 ? Math.round((reserved / total) * 100) : 0;
      utilEl.textContent = utilPct + '%';
    }
    DOCTORS.forEach(function(doc) {
      var docEl = document.getElementById('rl-occ-' + doc.id);
      if (docEl) docEl.textContent = perDoc[doc.id].r + '件';
    });
  }

  /* ═══ Override renderSection for parameterization ═══ */
  renderSection = function(containerId, slots, resData, pastFn, dateMode, dayOfWeek) {
    if (!resData) resData = reservations;
    if (!pastFn) pastFn = isPastSlot;
    if (!dateMode) dateMode = 'today';
    if (dayOfWeek == null) dayOfWeek = TODAY.getDay();
    let html = `<table class="gantt-table">
      <colgroup><col style="width:72px">${slots.map(() => '<col>').join('')}</colgroup>
      <thead><tr style="background:transparent">
        <th class="gantt-corner">担当医</th>
        ${slots.map(t => `<th class="gantt-time-th"><span class="time-th-text">${t}</span></th>`).join('')}
      </tr></thead><tbody>`;
    DOCTORS.forEach(doc => {
      html += `<tr><td class="gantt-doc-td" style="background:${doc.docBg}">
        <div class="gantt-doc-inner">
          <div><div class="gantt-doc-name">${doc.name.split(' ')[0]}</div></div>
        </div></td>`;
      slots.forEach(time => {
        const key = `${doc.id}_${time}`;
        const res = resData[key];
        const past = pastFn(time);
        const isSelected = blockMode && selectedSlotKeys.has(key);
        const isEmpty = !res || res.status === 'キャンセル';
        const isBlocked = (res && res.status === '停止') || (autoBlockedSlots.has(key) && isEmpty);

        if (moveMode) {
          var isDraggable = res && res.status !== 'キャンセル' && res.status !== '来院済' && res.status !== '停止';
          var isDropTarget = isEmpty && !past && !isBlocked;
          if (isDraggable) {
            html += `<td class="gantt-cell gantt-reserved gantt-move-draggable" onmousedown="onDragMoveStart(event,'${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (isDropTarget) {
            html += `<td class="gantt-cell gantt-empty gantt-move-drop-target" data-drop-key="${key}"></td>`;
          } else {
            var dimContent = res && res.status !== 'キャンセル' ? '<span class="gcell-name">' + res.name + '</span>' : '';
            html += `<td class="gantt-cell gantt-move-dim">${dimContent}</td>`;
          }
        } else if (isBlocked) {
          if (blockMode && blockModeType === 'unblock') {
            html += `<td class="gantt-cell gantt-selectable ${isSelected ? 'gantt-slot-selected' : 'gantt-blocked'}" onclick="toggleSlotSelection('${key}')">
              <span class="gcell-blocked">${isSelected ? '✓' : '停止'}</span></td>`;
          } else if (blockMode) {
            html += `<td class="gantt-cell gantt-selection-dim"><span class="gcell-blocked">停止</span></td>`;
          } else {
            html += `<td class="gantt-cell gantt-blocked"><span class="gcell-blocked">停止</span></td>`;
          }
        } else if (res && res.status !== 'キャンセル') {
          if (blockMode) {
            html += `<td class="gantt-cell gantt-selection-dim"><span class="gcell-name">${res.name}</span></td>`;
          } else if (res.status === '来院済') {
            html += `<td class="gantt-cell gantt-visited" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'past') {
            html += `<td class="gantt-cell gantt-visited" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'today' && past) {
            html += `<td class="gantt-cell gantt-unprocessed" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else if (dateMode === 'today') {
            html += `<td class="gantt-cell gantt-reserved" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          } else {
            html += `<td class="gantt-cell gantt-reserved" onclick="openDetailGantt('${key}')">
              <span class="gcell-name">${res.name}</span></td>`;
          }
        } else {
          if (dateMode === 'past') {
            html += `<td class="gantt-cell gantt-past-empty"></td>`;
          } else if (dateMode === 'today' && past) {
            html += `<td class="gantt-cell gantt-past-empty"></td>`;
          } else if (blockMode && blockModeType === 'stop') {
            html += `<td class="gantt-cell gantt-selectable ${isSelected ? 'gantt-slot-selected' : 'gantt-empty'}" onclick="toggleSlotSelection('${key}')">
              <span class="gcell-add">${isSelected ? '✓' : '＋'}</span></td>`;
          } else if (blockMode && blockModeType === 'unblock') {
            html += `<td class="gantt-cell gantt-selection-dim"></td>`;
          } else {
            html += `<td class="gantt-cell gantt-empty" onclick="openBookingGantt('${doc.id}','${time}')">
              <span class="gcell-add">＋</span></td>`;
          }
        }
      });
      html += `</tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById(containerId).innerHTML = html;
  };

  /* ═══ Override modal functions for context support ═══ */
  function getContextDateStr() {
    return ganttContext === 'list' && rlSelectedDate
      ? formatDateJP(rlSelectedDate.year, rlSelectedDate.month, rlSelectedDate.day)
      : todayStr;
  }

  openDetailGantt = function(key) {
    var res = getActiveReservations()[key];
    if (!res) return;
    currentGanttKey = key;
    var parts = key.split('_'); var docId = parts[0]; var time = parts[1];
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    document.getElementById('d-name').textContent = res.name;
    document.getElementById('d-card').innerHTML =
      '<button class="card-link" onclick="openPatientDetail(\'' + res.card + '\')">' + res.card + '</button>';
    document.getElementById('d-time').textContent = getContextDateStr() + ' ' + time;
    var docLabel = buildDoctorDetailLabel(res, docId);
    document.getElementById('d-doctor').innerHTML = '<span style="font-weight:700;color:#000000;">' + docLabel + '</span>';
    document.getElementById('d-status').innerHTML = makeStatusBadge(res.status);

    cancelStep = 0;
    purgeStep = 0;
    document.getElementById('cancel-confirm-view').classList.remove('show');
    document.getElementById('purge-confirm-view').classList.remove('show');

    if (res.status === '来院済') {
      document.getElementById('detail-actions-normal').style.display = 'none';
      document.getElementById('detail-actions-visited').style.display = '';
      var btnPurge = document.getElementById('btn-purge');
      btnPurge.textContent = '全て取消';
      btnPurge.style.background = '';
    } else {
      document.getElementById('detail-actions-normal').style.display = '';
      document.getElementById('detail-actions-visited').style.display = 'none';
      var btnArrival = document.getElementById('btn-arrival');
      btnArrival.disabled = false;
      btnArrival.textContent = '来院';
      btnArrival.className = 'btn btn-success';
      var btnCancel = document.getElementById('btn-cancel');
      btnCancel.textContent = '予約取消';
      btnCancel.style.background = '';
      console.log('ボタンテキスト設定:', btnCancel.textContent);
    }

    document.getElementById('modal-detail').classList.add('open');
  };

  handleArrival = function() {
    if (!currentGanttKey) return;
    var activeRes = getActiveReservations();
    var res = activeRes[currentGanttKey]; var name = res.name;
    var docId = currentGanttKey.split('_')[0]; /* ガント列の担当医slug */
    if (res.status === '来院済') {
      activeRes[currentGanttKey].status = '予約済';
      /* DB更新: status を confirmed に戻し、actual_staff_id をクリア */
      if (res.resId) {
        fetch('/api/admin/reservations/' + res.resId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'confirmed', actual_staff_id: null })
        }).catch(function(e) { console.error('来院取消API失敗:', e); });
      }
      closeDetail(); activeRenderGantt();
      showToast(name + 'さんの来院記録を取り消しました', '↩️');
    } else {
      activeRes[currentGanttKey].status = '来院済';
      /* DB更新: status を visited に、actual_staff_id にガント列の担当医slugを保存 */
      if (res.resId) {
        fetch('/api/admin/reservations/' + res.resId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'visited', actual_staff_id: docId })
        }).catch(function(e) { console.error('来院API失敗:', e); });
      }
      closeDetail(); activeRenderGantt();
      showToast(name + 'さんの来院を記録しました', '✅');
    }
  };

  handleCancel = function() {
    if (cancelStep === 0) {
      document.getElementById('cancel-confirm-view').classList.add('show');
      var btn = document.getElementById('btn-cancel');
      btn.textContent = '本当に取り消す'; btn.style.background = 'hsl(0,72%,38%)';
      cancelStep = 1;
    } else {
      if (!currentGanttKey) return;
      var activeRes = getActiveReservations();
      var name = activeRes[currentGanttKey].name;
      var card = activeRes[currentGanttKey].card;
      activeRes[currentGanttKey].status = 'キャンセル';
      var _parts = currentGanttKey.split('_');
      autoStopIfNeeded(_parts[0], _parts[1]);
      closeDetail(); activeRenderGantt();
      if (card && document.getElementById('modal-patient-detail') &&
          document.getElementById('modal-patient-detail').classList.contains('open')) {
        renderPatientReservations(card);
        renderPastVisits(card);
      }
      showToast(name + 'さんの予約をキャンセルしました', '❌');
    }
  };

  handlePurge = function() {
    if (purgeStep === 0) {
      document.getElementById('purge-confirm-view').classList.add('show');
      var btn = document.getElementById('btn-purge');
      btn.textContent = '全て取消';
      btn.style.background = 'hsl(0,72%,38%)';
      purgeStep = 1;
    } else {
      if (!currentGanttKey) return;
      var activeRes = getActiveReservations();
      var res = activeRes[currentGanttKey];
      if (!res) return;
      var name = res.name;
      var card = res.card;
      var _parts = currentGanttKey.split('_');
      delete reservations[currentGanttKey];
      delete listDateReservations[currentGanttKey];
      autoStopIfNeeded(_parts[0], _parts[1]);
      closeDetail(); activeRenderGantt();
      if (card && document.getElementById('modal-patient-detail') &&
          document.getElementById('modal-patient-detail').classList.contains('open')) {
        renderPatientReservations(card);
        renderPastVisits(card);
      }
      showToast(name + 'さんの来院記録と予約を取り消しました', '❌');
    }
  };

  enterBlockMode = function(type) {
    blockMode = true; blockModeType = type; selectedSlotKeys.clear();
    moveMode = false; dragSourceKey = null; dragTargetKey = null;
    document.getElementById('gantt-normal-controls').style.display = 'none';
    document.getElementById('gantt-select-controls').style.display = 'flex';
    document.getElementById('gantt-move-controls').style.display = 'none';
    var rlN = document.getElementById('rl-gantt-normal-controls');
    var rlS = document.getElementById('rl-gantt-select-controls');
    var rlM = document.getElementById('rl-gantt-move-controls');
    if (rlN) rlN.style.display = 'none';
    if (rlS) rlS.style.display = 'flex';
    if (rlM) rlM.style.display = 'none';
    var label = document.getElementById('gantt-select-label');
    label.style.color = type === 'stop' ? 'hsl(0,72%,44%)' : 'hsl(142,55%,32%)';
    var bulkBtn = document.getElementById('btn-bulk-all');
    bulkBtn.textContent = type === 'stop' ? '一括停止' : '一括解除';
    bulkBtn.className = type === 'stop' ? 'btn-slot-control btn-slot-stop' : 'btn-slot-control btn-slot-unblock';
    var rlLabel = document.getElementById('rl-gantt-select-label');
    if (rlLabel) rlLabel.style.color = type === 'stop' ? 'hsl(0,72%,44%)' : 'hsl(142,55%,32%)';
    var rlBulk = document.getElementById('rl-btn-bulk-all');
    if (rlBulk) { rlBulk.textContent = type === 'stop' ? '一括停止' : '一括解除'; rlBulk.className = type === 'stop' ? 'btn-slot-control btn-slot-stop' : 'btn-slot-control btn-slot-unblock'; }
    updateSelectionCount(); activeRenderGantt();
  };

  cancelBlockMode = function() {
    blockMode = false; blockModeType = null; selectedSlotKeys.clear();
    document.getElementById('gantt-normal-controls').style.display = 'flex';
    document.getElementById('gantt-select-controls').style.display = 'none';
    document.getElementById('gantt-move-controls').style.display = 'none';
    var rlN = document.getElementById('rl-gantt-normal-controls');
    var rlS = document.getElementById('rl-gantt-select-controls');
    var rlM = document.getElementById('rl-gantt-move-controls');
    if (rlN) rlN.style.display = 'flex';
    if (rlS) rlS.style.display = 'none';
    if (rlM) rlM.style.display = 'none';
    activeRenderGantt();
  };

  executeBlockMode = function() {
    if (selectedSlotKeys.size === 0) return;
    var count = selectedSlotKeys.size;
    var activeRes = getActiveReservations();
    if (blockModeType === 'stop') {
      selectedSlotKeys.forEach(function(key) { activeRes[key] = { status: '停止' }; });
      showToast(count + '枠を停止しました', '🚫');
    } else {
      selectedSlotKeys.forEach(function(key) {
        if (activeRes[key] && activeRes[key].status === '停止') delete activeRes[key];
        autoBlockedSlots.delete(key);
      });
      showToast(count + '枠の停止を解除しました', '✅');
    }
    cancelBlockMode();
  };

  executeBulkAll = function() {
    var count = 0;
    var activeRes = getActiveReservations();
    var pastFn = ganttContext === 'list' ? rlIsPastSlot : isPastSlot;
    if (blockModeType === 'stop') {
      DOCTORS.forEach(function(doc) {
        ALL_SLOTS.forEach(function(time) {
          if (!pastFn(time)) {
            var key = doc.id + '_' + time; var res = activeRes[key];
            if (!res || res.status === 'キャンセル') { activeRes[key] = { status: '停止' }; count++; }
          }
        });
      });
      showToast(count + '枠をすべて停止しました', '🚫');
    } else {
      DOCTORS.forEach(function(doc) {
        ALL_SLOTS.forEach(function(time) {
          var key = doc.id + '_' + time;
          if (activeRes[key] && activeRes[key].status === '停止') { delete activeRes[key]; count++; }
          if (autoBlockedSlots.has(key)) { autoBlockedSlots.delete(key); count++; }
        });
      });
      showToast(count + '枠の停止をすべて解除しました', '✅');
    }
    cancelBlockMode();
  };

  updateSelectionCount = function() {
    var count = selectedSlotKeys.size;
    var isStop = blockModeType === 'stop';
    var labelText = count > 0 ? count + '枠選択中' : (isStop ? '停止モード：枠を選択' : '停止解除モード：枠を選択');
    var btnText = isStop ? count + '枠を停止' : count + '枠を解除';
    var btnClass = isStop ? 'btn-slot-control btn-slot-stop' : 'btn-slot-control btn-slot-unblock';
    document.getElementById('gantt-select-label').textContent = labelText;
    var btn = document.getElementById('btn-execute-block');
    btn.disabled = count === 0; btn.textContent = btnText; btn.className = btnClass;
    var rlLabel = document.getElementById('rl-gantt-select-label');
    if (rlLabel) rlLabel.textContent = labelText;
    var rlBtn = document.getElementById('rl-btn-execute-block');
    if (rlBtn) { rlBtn.disabled = count === 0; rlBtn.textContent = btnText; rlBtn.className = btnClass; }
  };

  openBookingGantt = function(docId, time) {
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    currentBookingKey = docId + '_' + time;
    document.getElementById('b-time').textContent = getContextDateStr() + ' ' + time;
    document.getElementById('b-doctor').innerHTML =
      '<span style="font-weight:700;color:#000000;">' + doc.name + '</span>';
    document.getElementById('b-card').value = '';
    document.getElementById('b-error').textContent = '';
    document.getElementById('b-patient-name').style.display = 'none';
    document.getElementById('booking-confirm-view').classList.remove('show');
    var btn = document.getElementById('btn-confirm-booking');
    btn.textContent = '確認'; btn.style.background = '';
    bookingStep = 0;
    document.getElementById('modal-booking').classList.add('open');
    setTimeout(function() { document.getElementById('b-card').focus(); }, 220);
  };

  confirmBooking = function() {
    var card = document.getElementById('b-card').value.trim();
    if (!card || !/^\d{4,}$/.test(card)) {
      document.getElementById('b-error').textContent = '診察券番号を4桁以上の数字で入力してください'; return;
    }
    if (!currentBookingKey) return;
    if (bookingStep === 0) {
      var previewName = PATIENT_DATA[card] ? PATIENT_DATA[card].name : dummyNames[parseInt(card.slice(-1)) % dummyNames.length];
      document.getElementById('b-patient-name-text').textContent = previewName;
      document.getElementById('b-patient-name').style.display = 'block';
      document.getElementById('booking-confirm-view').classList.add('show');
      var btn = document.getElementById('btn-confirm-booking');
      btn.textContent = '確定'; btn.style.background = 'hsl(142,71%,32%)';
      bookingStep = 1;
    } else {
      var name = PATIENT_DATA[card] ? PATIENT_DATA[card].name : dummyNames[parseInt(card.slice(-1)) % dummyNames.length];
      var time = currentBookingKey.split('_')[1];
      getActiveReservations()[currentBookingKey] = { name: name, card: card, status: '予約済', doctorPreferred: false, doctorHistory: [] };
      closeBooking(); activeRenderGantt();
      showToast(time + ' に ' + name + 'さんの予約を追加しました');
      openPatientDetail(card, ganttContext === 'list' ? 'list' : 'dashboard');
    }
  };

  handleStopSlot = function() {
    if (stopSlotStep === 0) {
      document.getElementById('stop-confirm-view').classList.add('show');
      var btn = document.getElementById('btn-stop-slot');
      btn.textContent = '本当に停止する'; btn.className = 'btn btn-danger';
      stopSlotStep = 1;
    } else {
      var key = currentSlotActionKey; if (!key) return;
      var time = key.split('_')[1];
      getActiveReservations()[key] = { status: '停止' };
      document.getElementById('modal-slot-action').classList.remove('open');
      currentSlotActionKey = null; stopSlotStep = 0;
      activeRenderGantt(); showToast(time + ' の枠を停止しました', '🚫');
    }
  };

  slotActionBook = function() {
    var key = currentSlotActionKey; if (!key) return;
    document.getElementById('modal-slot-action').classList.remove('open');
    currentSlotActionKey = null; stopSlotStep = 0;
    var parts = key.split('_'); var docId = parts[0]; var time = parts[1];
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    currentBookingKey = key;
    document.getElementById('b-time').textContent = getContextDateStr() + ' ' + time;
    document.getElementById('b-doctor').innerHTML =
      '<span style="font-weight:700;color:#000000;">' + doc.name + '</span>';
    document.getElementById('b-card').value = '';
    document.getElementById('b-error').textContent = '';
    document.getElementById('modal-booking').classList.add('open');
    setTimeout(function() { document.getElementById('b-card').focus(); }, 220);
  };

  stopCurrentSlot = function() {
    if (!currentBookingKey) return;
    var stopBtn = document.getElementById('btn-stop-booking');
    if (stopBookingStep === 0) {
      stopBtn.textContent = '停止を確認 →'; stopBtn.className = 'btn btn-danger';
      stopBookingStep = 1;
    } else {
      var time = currentBookingKey.split('_')[1];
      getActiveReservations()[currentBookingKey] = { status: '停止' };
      stopBookingStep = 0; closeBooking(); activeRenderGantt();
      showToast(time + ' の枠を停止しました', '🚫');
    }
  };

  executeBulkStop = function() {
    if (!currentBulkStopTime) return;
    var count = 0; var activeRes = getActiveReservations();
    DOCTORS.forEach(function(doc) {
      var key = doc.id + '_' + currentBulkStopTime; var res = activeRes[key];
      if (!res || res.status === 'キャンセル') { activeRes[key] = { status: '停止' }; count++; }
    });
    var t = currentBulkStopTime; closeBulkStop(); activeRenderGantt();
    showToast(t + ' の ' + count + ' 枠を停止しました', '🚫');
  };

  executeBulkUnblock = function() {
    if (!currentBulkStopTime) return;
    var count = 0; var activeRes = getActiveReservations();
    DOCTORS.forEach(function(doc) {
      var key = doc.id + '_' + currentBulkStopTime; var res = activeRes[key];
      if (res && res.status === '停止') { delete activeRes[key]; count++; }
    });
    var t = currentBulkStopTime; closeBulkStop(); activeRenderGantt();
    showToast(t + ' の ' + count + ' 枠の停止を解除しました', '✅');
  };

  openTimeBulkStop = function(time) {
    var activeRes = getActiveReservations();
    var emptyDocs = DOCTORS.filter(function(doc) { var r = activeRes[doc.id + '_' + time]; return !r || r.status === 'キャンセル'; });
    var stoppedDocs = DOCTORS.filter(function(doc) { var r = activeRes[doc.id + '_' + time]; return r && r.status === '停止'; });
    if (emptyDocs.length === 0 && stoppedDocs.length === 0) { showToast(time + ' に操作できる枠がありません', 'ℹ️'); return; }
    currentBulkStopTime = time;
    document.getElementById('bs-subtitle').textContent = '対象時間帯：' + time;
    var stopSec = document.getElementById('bs-stop-section');
    var unblockSec = document.getElementById('bs-unblock-section');
    if (emptyDocs.length > 0) {
      stopSec.style.display = '';
      document.getElementById('bs-stop-msg').textContent = emptyDocs.map(function(d) { return d.name; }).join('・') + '（計 ' + emptyDocs.length + ' 枠）を予約停止します';
    } else { stopSec.style.display = 'none'; }
    if (stoppedDocs.length > 0) {
      unblockSec.style.display = '';
      document.getElementById('bs-unblock-msg').textContent = stoppedDocs.map(function(d) { return d.name; }).join('・') + '（計 ' + stoppedDocs.length + ' 枠）の停止を解除します';
    } else { unblockSec.style.display = 'none'; }
    document.getElementById('modal-bulk-stop').classList.add('open');
  };

  /* Override nav for list page */
  var _origNav = nav;
  nav = function(id, el) {
    if (id !== 'list') ganttContext = 'dashboard';
    _origNav(id, el);
    if (id === 'list') {
      document.getElementById('list-calendar-view').style.display = 'flex';
      document.getElementById('list-gantt-view').style.display = 'none';
      renderCalendar();
    }
  };

  /* Override navBack for list context */
  var _origNavBack = navBack;
  navBack = function() {
    if (pdReturnPage === 'list') {
      ganttContext = 'list';
      var el = document.querySelector('[data-navid="list"]');
      document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('page-list').classList.add('active');
      document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
      if (el) el.classList.add('active');
      document.getElementById('page-title').textContent = '予約一覧';
      if (rlSelectedDate) {
        document.getElementById('list-calendar-view').style.display = 'none';
        document.getElementById('list-gantt-view').style.display = 'flex';
        renderListGantt();
      }
    } else { _origNavBack(); }
  };

  /* Override openPatientDetail for list context */
  var _origOpenPatientDetail = openPatientDetail;
  openPatientDetail = function(card, returnPage) {
    if (!returnPage && ganttContext === 'list') returnPage = 'list';
    _origOpenPatientDetail(card, returnPage);
    if (pdReturnPage === 'list') {
      document.getElementById('pd-back-btn').textContent = '← 予約一覧に戻る';
    }
  };

  /* Build month select options */
  function buildMonthOptions() {
    var sel = document.getElementById('rl-month-select');
    var html = '';
    var y = RL_MIN_YEAR, m = RL_MIN_MONTH;
    while (y < RL_MAX_YEAR || (y === RL_MAX_YEAR && m <= RL_MAX_MONTH)) {
      var val = y + '-' + (m < 10 ? '0' + m : m);
      html += '<option value="' + val + '">' + y + '年' + m + '月</option>';
      m++; if (m > 12) { m = 1; y++; }
    }
    sel.innerHTML = html;
    sel.value = rlCurrentYear + '-' + (rlCurrentMonth < 10 ? '0' + rlCurrentMonth : rlCurrentMonth);
  }

  /* ═══════════════════════════════════════════
     診療カレンダー
  ═══════════════════════════════════════════ */
  var DAY_LABELS = ['日','月','火','水','木','金','土','祝'];

  var clinicSettings = {
    workDays: [1,2,3,4,5,6],
    holidayWork: false,
    treatmentMin: 20,
    amStart: { h: 9, m: 0 }, amEnd: { h: 13, m: 0 },
    pmStart: { h: 16, m: 0 }, pmEnd: { h: 20, m: 0 },
    holidays: [],
    extraWorkDays: []
  };

  /* ─── ダミー予約データ（警告モーダル用） ─── */
  var dummyReservationsByDate = {
    '2026/03/02': 5,
    '2026/03/05': 3,
    '2026/03/10': 8,
    '2026/03/15': 2,
    '2026/03/20': 6,
    '2026/03/25': 4
  };

  function cspad(n) { return n < 10 ? '0' + n : '' + n; }
  function csTimeStr(t) { return cspad(t.h) + ':' + cspad(t.m); }

  /* 担当医テーブル用：院の基本設定の診療日ボタン並び順（月火水木金土日祝）でフィルタ */
  var DAY_DISPLAY_ORDER = [1,2,3,4,5,6,0,7];
  function getScheduleDays() {
    return DAY_DISPLAY_ORDER.filter(function(d) {
      if (d === 7) return clinicSettings.holidayWork;
      return clinicSettings.workDays.indexOf(d) >= 0;
    });
  }

  /* 担当医スケジュールデータ（ガントチャートの予約データに基づく） */
  // 担当医ごとの休診曜日と反映日を管理するマップ
  // 例: docKyushinMap['tanaka'] = { days: ['thu','sat'], effectiveDate: '2026-02-25' }
  var docKyushinMap = {};

  // キャンセル後に勤務時間外・休診なら自動停止する
  function autoStopIfNeeded(docId, timeStr) {
    console.log('autoStopIfNeeded called:', docId, timeStr, rlSelectedDate);
    var key = docId + '_' + timeStr;
    if (!rlSelectedDate) return;

    var viewDate = new Date(rlSelectedDate.year, rlSelectedDate.month - 1, rlSelectedDate.day);
    var viewDateStr = viewDate.toISOString().split('T')[0];
    var scheduleNum = String(viewDate.getDay());
    var daySchedule = staffScheduleStore[docId] &&
                      staffScheduleStore[docId].schedule &&
                      staffScheduleStore[docId].schedule[scheduleNum];

    // 反映日チェック
    var map = docKyushinMap[docId];
    if (map && viewDateStr < map.effectiveDate) return;

    // 休診日
    if (!daySchedule) {
      listDateReservations[key] = { status: '停止' };
      return;
    }

    function toMin(str) {
      if (!str) return 0;
      var parts = str.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    var slotMin = toMin(timeStr);
    var hour = parseInt(timeStr.split(':')[0]);

    // 午前枠（9〜12時台）
    if (hour < 14) {
      if (!daySchedule.am) {
        listDateReservations[key] = { status: '停止' };
        return;
      }
      var amParts = daySchedule.am.split('〜');
      var amStart = toMin(amParts[0]);
      var amEnd = toMin(amParts[1]);
      if (slotMin < amStart || slotMin >= amEnd) {
        listDateReservations[key] = { status: '停止' };
        return;
      }
    }

    // 午後枠（14時以降）
    if (hour >= 14) {
      if (!daySchedule.pm) {
        listDateReservations[key] = { status: '停止' };
        return;
      }
      var pmParts = daySchedule.pm.split('〜');
      var pmStart = toMin(pmParts[0]);
      var pmEnd = toMin(pmParts[1]);
      if (slotMin < pmStart || slotMin >= pmEnd) {
        listDateReservations[key] = { status: '停止' };
        return;
      }
    }
  }

  var staffScheduleStore = {};
  function buildDoctorSchedules() {
    DOCTORS.forEach(function(doc) {
      if (staffScheduleStore[doc.id]) return; // 既に構築済みならスキップ
      var sched = {};
      if (doc.id === 'tanaka') {
        // 田中 誠（院長）: 月〜金 午前+午後、土 午前のみ
        [1,2,3,4,5].forEach(function(d) { sched[d] = { am: '09:00〜13:00', pm: '16:00〜20:00' }; });
        sched[6] = { am: '09:00〜13:00' };
      } else if (doc.id === 'suzuki') {
        // 鈴木 由美（副院長）: 月水金 午前+午後、火木 午前のみ、土 休み
        [1,3,5].forEach(function(d) { sched[d] = { am: '09:00〜13:00', pm: '16:00〜20:00' }; });
        [2,4].forEach(function(d) { sched[d] = { am: '09:00〜13:00' }; });
      } else if (doc.id === 'sato') {
        // 佐藤 健: 月〜金 午前10:30〜12:00+午後16:00〜18:00、土 午前のみ
        [1,2,3,4,5].forEach(function(d) { sched[d] = { am: '10:30〜12:00', pm: '16:00〜18:00' }; });
        sched[6] = { am: '09:00〜13:00' };
      } else {
        (clinicSettings.workDays || [1,2,3,4,5,6]).forEach(function(d) {
          sched[d] = {
            am: csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd),
            pm: csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd)
          };
        });
      }
      staffScheduleStore[doc.id] = { schedule: sched, holidays: [], extraWorkDays: [] };
    });
  }
  buildDoctorSchedules();

  var csEditing = false;

  function renderClinicSettings() {
    var html = '';
    /* 診療日 + 祝ボタン */
    html += '<div class="cal-row"><div class="cal-row-label">診療日</div><div class="cal-row-content">';
    [1,2,3,4,5,6,0].forEach(function(d) {
      var sel = clinicSettings.workDays.indexOf(d) >= 0;
      var cls = 'cal-day-btn' + (sel ? ' active' : '') + (csEditing ? ' editing' : '');
      var oc = csEditing ? ' onclick="toggleWorkDay(' + d + ')"' : '';
      html += '<span class="' + cls + '"' + oc + '>' + DAY_LABELS[d] + '</span>';
    });
    /* 祝 button */
    var holActive = clinicSettings.holidayWork;
    var holStyle = holActive
      ? 'background:#3b82f6;color:#fff;border-color:#3b82f6;'
      : 'background:#e5e7eb;color:#999;border-color:#e5e7eb;';
    var holCls = 'cal-day-btn' + (holActive ? ' active' : '') + (csEditing ? ' editing' : '');
    var holOc = csEditing ? ' onclick="toggleHolidayWork()"' : '';
    html += '<span class="' + holCls + '" style="' + holStyle + '"' + holOc + '>祝</span>';
    html += '</div></div>';

    /* 施術時間 */
    html += '<div class="cal-row"><div class="cal-row-label">施術時間</div><div class="cal-row-content">';
    html += '<input type="text" class="cal-time-input" style="width:60px;" id="cs-treat-min" value="' + clinicSettings.treatmentMin + '"' + (csEditing ? '' : ' readonly') + '>';
    html += '<span class="cal-time-unit">分</span>';
    html += '</div></div>';

    /* 診療時間 */
    html += '<div class="cal-row"><div class="cal-row-label">診療時間</div><div class="cal-row-content" style="flex-direction:column;align-items:flex-start;gap:8px;">';
    html += csTimeRow('午前', 'cs-am', clinicSettings.amStart, clinicSettings.amEnd);
    html += csTimeRow('午後', 'cs-pm', clinicSettings.pmStart, clinicSettings.pmEnd);
    html += '</div></div>';

    /* 臨時休診日 */
    html += '<div class="cal-row"><div class="cal-row-label">臨時休診日</div><div class="cal-row-content cal-holiday-wrap">';
    clinicSettings.holidays.forEach(function(h, i) {
      var xBtn = csEditing ? '<span class="cal-holiday-x" onclick="removeClinicHoliday(' + i + ')">×</span>' : '';
      html += '<span class="cal-holiday-badge">' + h + xBtn + '</span>';
    });
    if (csEditing) {
      html += '<button class="cal-btn-add" onclick="openMiniCal(\'clinic\')">＋追加</button>';
    }
    if (clinicSettings.holidays.length === 0 && !csEditing) {
      html += '<span style="color:#ccc;font-size:12px;">なし</span>';
    }
    html += '</div></div>';

    /* 臨時診療日 */
    html += '<div class="cal-row"><div class="cal-row-label">臨時診療日</div><div class="cal-row-content cal-holiday-wrap">';
    clinicSettings.extraWorkDays.forEach(function(h, i) {
      var xBtn = csEditing ? '<span class="cal-holiday-x" onclick="removeClinicExtraWork(' + i + ')">×</span>' : '';
      html += '<span class="cal-extra-badge">' + h + xBtn + '</span>';
    });
    if (csEditing) {
      html += '<button class="cal-btn-add" onclick="openMiniCal(\'clinic_extra\')">＋追加</button>';
    }
    if (clinicSettings.extraWorkDays.length === 0 && !csEditing) {
      html += '<span style="color:#ccc;font-size:12px;">なし</span>';
    }
    html += '</div></div>';

    document.getElementById('cs-body').innerHTML = html;
  }

  function csTimeRow(label, prefix, start, end) {
    var ro = csEditing ? '' : ' readonly';
    var h = '<div style="display:flex;align-items:center;gap:4px;">';
    h += '<span class="cal-time-label">' + label + '</span>';
    h += '<input type="text" class="cal-time-input" id="' + prefix + '-sh" value="' + start.h + '"' + ro + '>';
    h += '<span class="cal-time-unit">時</span>';
    h += '<input type="text" class="cal-time-input" id="' + prefix + '-sm" value="' + cspad(start.m) + '"' + ro + '>';
    h += '<span class="cal-time-unit">分</span>';
    h += '<span class="cal-time-sep">〜</span>';
    h += '<input type="text" class="cal-time-input" id="' + prefix + '-eh" value="' + end.h + '"' + ro + '>';
    h += '<span class="cal-time-unit">時</span>';
    h += '<input type="text" class="cal-time-input" id="' + prefix + '-em" value="' + cspad(end.m) + '"' + ro + '>';
    h += '<span class="cal-time-unit">分</span>';
    h += '</div>';
    return h;
  }

  function editClinicSettings() {
    var btn = document.getElementById('cs-edit-btn');
    if (csEditing) {
      showEffectiveModal(function(dateStr) {
        clinicSettings.treatmentMin = parseInt(document.getElementById('cs-treat-min').value) || 20;
        clinicSettings.amStart = { h: parseInt(document.getElementById('cs-am-sh').value) || 9, m: parseInt(document.getElementById('cs-am-sm').value) || 0 };
        clinicSettings.amEnd   = { h: parseInt(document.getElementById('cs-am-eh').value) || 13, m: parseInt(document.getElementById('cs-am-em').value) || 0 };
        clinicSettings.pmStart = { h: parseInt(document.getElementById('cs-pm-sh').value) || 16, m: parseInt(document.getElementById('cs-pm-sm').value) || 0 };
        clinicSettings.pmEnd   = { h: parseInt(document.getElementById('cs-pm-eh').value) || 20, m: parseInt(document.getElementById('cs-pm-em').value) || 0 };
        csEditing = false;
        btn.textContent = '編集';
        btn.className = 'doc-btn-sm doc-btn-edit';
        renderClinicSettings();
        renderDocCards();
        showToast('診療カレンダーの変更を保存しました');
      }, '診療カレンダーの変更の<br>反映開始日を選択してください');
    } else {
      csEditing = true;
      btn.textContent = '保存';
      btn.className = 'doc-btn-sm doc-btn-save';
      renderClinicSettings();
      renderDocCards();
    }
  }

  function toggleWorkDay(d) {
    var idx = clinicSettings.workDays.indexOf(d);
    if (idx >= 0) {
      clinicSettings.workDays.splice(idx, 1);
    } else {
      clinicSettings.workDays.push(d);
      clinicSettings.workDays.sort();
      /* 新たにONにした曜日の初期値を全担当医に追加 */
      fillDefaultScheduleForDay(d);
    }
    renderClinicSettings();
    renderDocCards();
  }

  function removeClinicHoliday(idx) {
    if (!csEditing) return;
    clinicSettings.holidays.splice(idx, 1);
    renderClinicSettings();
  }

  function toggleHolidayWork() {
    clinicSettings.holidayWork = !clinicSettings.holidayWork;
    if (clinicSettings.holidayWork) {
      fillDefaultScheduleForDay(7);
    }
    renderClinicSettings();
    renderDocCards();
  }

  /* 全担当医のスケジュールに指定曜日の初期値（院の診療時間）をセット */
  function fillDefaultScheduleForDay(d) {
    var amDefault = csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd);
    var pmDefault = csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd);
    DOCTORS.forEach(function(doc) {
      var ds = staffScheduleStore[doc.id];
      if (!ds) return;
      if (!ds.schedule[d]) {
        ds.schedule[d] = { am: amDefault, pm: pmDefault };
      }
    });
  }

  function removeClinicExtraWork(idx) {
    if (!csEditing) return;
    clinicSettings.extraWorkDays.splice(idx, 1);
    renderClinicSettings();
  }

  /* ─── 担当医カード ─── */
  var docEditingId = null;

  function renderDocCards() {
    var html = '';
    DOCTORS.forEach(function(doc) {
      var ds = staffScheduleStore[doc.id];
      var isEditing = docEditingId === doc.id;
      html += '<div class="doc-card">';
      html += '<div class="doc-card-header"><div class="doc-card-info">';
      html += '<span class="doc-card-name">' + doc.name + '</span>';
      html += '<span class="doc-card-role">' + doc.role + '</span>';
      html += '</div><div class="doc-card-actions">';
      if (isEditing) {
        html += '<button class="doc-btn-sm doc-btn-save" onclick="showEffectiveModal(function(dateStr){ window._lastEffectiveDate = dateStr; saveDocSchedule(\'' + doc.id + '\'); })">保存</button>';
        html += '<button class="doc-btn-sm" style="background:#f0f0f0;color:#666;border-color:#ddd;" onclick="cancelDocEdit()">キャンセル</button>';
      } else {
        html += '<button class="doc-btn-sm doc-btn-edit" onclick="requireAuthIfNeeded(\'editDoctor\', function(){ editDocSchedule(\'' + doc.id + '\'); })">編集</button>';
        html += '<button class="doc-btn-sm doc-btn-del" onclick="requireAuthIfNeeded(\'editDoctor\', function(){ deleteDoctor(\'' + doc.id + '\'); })">削除</button>';
      }
      html += '</div></div>';

      /* 出勤テーブル */
      var schedDays = getScheduleDays();
      html += '<div class="doc-sched-wrap">';
      html += '<table class="doc-sched-table"><thead><tr><th></th>';
      schedDays.forEach(function(d) {
        html += '<th>' + DAY_LABELS[d] + '</th>';
      });
      html += '</tr></thead><tbody>';

      ['am','pm'].forEach(function(period) {
        var periodLabel = period === 'am' ? '午前' : '午後';
        html += '<tr><th>' + periodLabel + '</th>';
        schedDays.forEach(function(d) {
          var s = ds.schedule[d];
          var val = s ? s[period] : null;
          if (isEditing) {
            if (val) {
              var parts = val.split('〜');
              var tStart = parts[0] || '09:00';
              var tEnd = parts[1] || '13:00';
              html += '<td><div style="display:flex;flex-direction:column;align-items:center;gap:3px;">';
              html += '<div style="display:flex;align-items:center;gap:3px;">';
              html += '<input type="time" class="ds-time-input" style="width:80px;min-width:80px;" id="ds-' + doc.id + '-' + d + '-' + period + '-start" value="' + tStart + '">';
              html += '<span style="font-size:11px;color:#888;">〜</span>';
              html += '<input type="time" class="ds-time-input" style="width:80px;min-width:80px;" id="ds-' + doc.id + '-' + d + '-' + period + '-end" value="' + tEnd + '">';
              html += '</div>';
              html += '<button class="ds-kyushin-btn" onclick="setDocCellKyushin(\'' + doc.id + '\',' + d + ',\'' + period + '\')">休診</button>';
              html += '</div></td>';
            } else {
              html += '<td><div style="display:flex;flex-direction:column;align-items:center;gap:3px;">';
              html += '<span style="color:#dc2626;font-weight:700;font-size:12px;">休診</span>';
              html += '<button class="ds-kaijo-btn" onclick="setDocCellKaijo(\'' + doc.id + '\',' + d + ',\'' + period + '\')">解除</button>';
              html += '</div></td>';
            }
          } else {
            if (val) {
              html += '<td>' + val + '</td>';
            } else {
              html += '<td style="color:#dc2626;font-weight:700;">休診</td>';
            }
          }
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      html += '</div>'; /* end doc-sched-wrap */

      /* 臨時休診日 */
      html += '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;">';
      html += '<span style="font-size:13px;font-weight:600;color:#888;">臨時休診日</span>';
      ds.holidays.forEach(function(h, i) {
        var xBtn = isEditing ? '<span class="cal-holiday-x" onclick="removeDocHoliday(\'' + doc.id + '\',' + i + ')">×</span>' : '';
        html += '<span class="cal-holiday-badge">' + h + xBtn + '</span>';
      });
      if (isEditing) {
        html += '<button class="cal-btn-add" onclick="openMiniCal(\'doc_' + doc.id + '\')">＋追加</button>';
      }
      if (ds.holidays.length === 0 && !isEditing) {
        html += '<span style="color:#ccc;font-size:12px;">なし</span>';
      }
      html += '</div>';

      /* 臨時診療日 */
      if (!ds.extraWorkDays) ds.extraWorkDays = [];
      html += '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">';
      html += '<span style="font-size:13px;font-weight:600;color:#888;">臨時診療日</span>';
      ds.extraWorkDays.forEach(function(h, i) {
        var xBtn = isEditing ? '<span class="cal-holiday-x" onclick="removeDocExtraWork(\'' + doc.id + '\',' + i + ')">×</span>' : '';
        html += '<span class="cal-extra-badge">' + h + xBtn + '</span>';
      });
      if (isEditing) {
        html += '<button class="cal-btn-add" onclick="openMiniCal(\'docextra_' + doc.id + '\')">＋追加</button>';
      }
      if (ds.extraWorkDays.length === 0 && !isEditing) {
        html += '<span style="color:#ccc;font-size:12px;">なし</span>';
      }
      html += '</div>';
      html += '</div>';
    });
    /* Inline add doctor form */
    if (addingNewDoctor) {
      html += renderAddDoctorForm();
    }
    document.getElementById('doc-cards-container').innerHTML = html;
  }

  /* ─── Doctor schedule cell toggle helpers ─── */
  function setDocCellKyushin(docId, day, period) {
    var ds = staffScheduleStore[docId];
    if (ds.schedule[day]) {
      delete ds.schedule[day][period];
      if (!ds.schedule[day].am && !ds.schedule[day].pm) delete ds.schedule[day];
    }
    renderDocCards();
  }

  function setDocCellKaijo(docId, day, period) {
    var ds = staffScheduleStore[docId];
    if (!ds.schedule[day]) ds.schedule[day] = {};
    var times = period === 'am'
      ? csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd)
      : csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd);
    ds.schedule[day][period] = times;
    renderDocCards();
  }

  function editDocSchedule(docId) {
    docEditingId = docId;
    renderDocCards();
  }

  function cancelDocEdit() {
    docEditingId = null;
    renderDocCards();
  }

  function saveDocSchedule(docId) {
    var ds = staffScheduleStore[docId];
    getScheduleDays().forEach(function(d) {
      ['am','pm'].forEach(function(period) {
        var startEl = document.getElementById('ds-' + docId + '-' + d + '-' + period + '-start');
        var endEl = document.getElementById('ds-' + docId + '-' + d + '-' + period + '-end');
        if (startEl && endEl) {
          /* Time inputs exist means it's not 休診 */
          if (!ds.schedule[d]) ds.schedule[d] = {};
          ds.schedule[d][period] = startEl.value + '〜' + endEl.value;
        } else {
          /* No time inputs means 休診 - already handled by setDocCellKyushin */
          /* Keep current state (already null/deleted) */
        }
      });
    });
    // scheduleのキーが数字の場合に対応したマッピング
    var dowNameMap = { 0:'sun', 1:'mon', 2:'tue', 3:'wed', 4:'thu', 5:'fri', 6:'sat' };
    var dowNumMap  = { 'mon':1, 'tue':2, 'wed':3, 'thu':4, 'fri':5, 'sat':6, 'sun':0 };

    var kyushinDays = [];
    var schedule = ds.schedule;
    getScheduleDays().forEach(function(d) {
      // scheduleのキーが数字文字列の場合は数字に変換して参照
      var numKey = typeof d === 'number' ? d : dowNumMap[d];
      var nameKey = typeof d === 'number' ? dowNameMap[d] : d;
      var cell = schedule[numKey] || schedule[nameKey];
      if (!cell || (!cell.am && !cell.pm)) {
        kyushinDays.push(nameKey); // 常に文字列キーで保存
      }
    });
    docKyushinMap[docId] = {
      days: kyushinDays,
      effectiveDate: window._lastEffectiveDate || new Date().toISOString().split('T')[0]
    };

    docEditingId = null;
    renderDocCards();
    showToast('スケジュールを保存しました');
  }

  function deleteDoctor(docId) {
    var doc = DOCTORS.find(function(d) { return d.id === docId; });
    if (!doc) return;
    if (!confirm(doc.name + ' を担当医一覧から削除しますか？')) return;
    DOCTORS.splice(DOCTORS.indexOf(doc), 1);
    delete staffScheduleStore[docId];
    renderDocCards();
    showToast(doc.name + ' を削除しました');
  }

  var addingNewDoctor = false;
  var addDocTempSchedule = {};

  function addNewDoctor() {
    addingNewDoctor = true;
    /* Pre-fill schedule with clinic defaults */
    addDocTempSchedule = {};
    getScheduleDays().forEach(function(d) {
      addDocTempSchedule[d] = {
        am: csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd),
        pm: csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd)
      };
    });
    renderDocCards();
    /* Scroll to the bottom to show the form */
    var container = document.getElementById('doc-cards-container');
    setTimeout(function() { container.scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 50);
  }

  function renderAddDoctorForm() {
    var h = '<div class="doc-card doc-add-form">';
    h += '<div style="font-size:15px;font-weight:800;margin-bottom:14px;color:#3b82f6;">新しい担当医を追加</div>';
    /* 氏名 */
    h += '<div class="doc-add-field">';
    h += '<span class="doc-add-label">氏名</span>';
    h += '<input type="text" class="doc-add-input" id="add-doc-name" placeholder="例：山田 花子">';
    h += '</div>';
    /* 肩書 */
    h += '<div class="doc-add-field">';
    h += '<span class="doc-add-label">肩書</span>';
    h += '<select class="doc-add-select" id="add-doc-role">';
    h += '<option value="院長">院長</option>';
    h += '<option value="副院長">副院長</option>';
    h += '<option value="スタッフ" selected>スタッフ</option>';
    h += '</select>';
    h += '</div>';
    /* 出勤スケジュール */
    h += '<div style="margin-bottom:14px;">';
    h += '<span class="doc-add-label" style="display:block;margin-bottom:8px;">出勤スケジュール</span>';
    var addSchedDays = getScheduleDays();
    h += '<div class="doc-sched-wrap">';
    h += '<table class="doc-sched-table"><thead><tr><th></th>';
    addSchedDays.forEach(function(d) {
      h += '<th>' + DAY_LABELS[d] + '</th>';
    });
    h += '</tr></thead><tbody>';
    ['am','pm'].forEach(function(period) {
      var periodLabel = period === 'am' ? '午前' : '午後';
      h += '<tr><th>' + periodLabel + '</th>';
      addSchedDays.forEach(function(d) {
        var s = addDocTempSchedule[d];
        var val = s ? s[period] : null;
        if (val) {
          var parts = val.split('〜');
          var tStart = parts[0] || '09:00';
          var tEnd = parts[1] || '13:00';
          h += '<td><div style="display:flex;flex-direction:column;align-items:center;gap:3px;">';
          h += '<div style="display:flex;align-items:center;gap:2px;">';
          h += '<input type="time" class="ds-time-input" style="width:80px;min-width:80px;" id="add-ds-' + d + '-' + period + '-start" value="' + tStart + '">';
          h += '<span style="font-size:11px;color:#888;">〜</span>';
          h += '<input type="time" class="ds-time-input" style="width:80px;min-width:80px;" id="add-ds-' + d + '-' + period + '-end" value="' + tEnd + '">';
          h += '</div>';
          h += '<button class="ds-kyushin-btn" onclick="addDocSetKyushin(' + d + ',\'' + period + '\')">休診</button>';
          h += '</div></td>';
        } else {
          h += '<td><div style="display:flex;flex-direction:column;align-items:center;gap:3px;">';
          h += '<span style="color:#dc2626;font-weight:700;font-size:12px;">休診</span>';
          h += '<button class="ds-kaijo-btn" onclick="addDocSetKaijo(' + d + ',\'' + period + '\')">解除</button>';
          h += '</div></td>';
        }
      });
      h += '</tr>';
    });
    h += '</tbody></table>';
    h += '</div>'; /* end doc-sched-wrap */
    h += '</div>';
    /* Buttons */
    h += '<div style="display:flex;gap:10px;justify-content:flex-end;">';
    h += '<button class="doc-btn-sm" style="background:#f0f0f0;color:#666;border-color:#ddd;" onclick="cancelAddDoctor()">キャンセル</button>';
    h += '<button class="doc-btn-sm doc-btn-save" onclick="showEffectiveModal(function(dateStr){ confirmAddDoctor(); })">保存して追加</button>';
    h += '</div>';
    h += '</div>';
    return h;
  }

  function addDocSetKyushin(day, period) {
    if (addDocTempSchedule[day]) {
      delete addDocTempSchedule[day][period];
      if (!addDocTempSchedule[day].am && !addDocTempSchedule[day].pm) delete addDocTempSchedule[day];
    }
    renderDocCards();
  }

  function addDocSetKaijo(day, period) {
    if (!addDocTempSchedule[day]) addDocTempSchedule[day] = {};
    var times = period === 'am'
      ? csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd)
      : csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd);
    addDocTempSchedule[day][period] = times;
    renderDocCards();
  }

  function cancelAddDoctor() {
    addingNewDoctor = false;
    addDocTempSchedule = {};
    renderDocCards();
  }

  function confirmAddDoctor() {
    var nameEl = document.getElementById('add-doc-name');
    var roleEl = document.getElementById('add-doc-role');
    var name = nameEl ? nameEl.value.trim() : '';
    if (!name) {
      nameEl.style.borderColor = '#dc2626';
      nameEl.focus();
      return;
    }
    var role = roleEl ? roleEl.value : 'スタッフ';
    var id = 'doc_' + Date.now();
    /* Read time inputs from the add form */
    var sched = {};
    getScheduleDays().forEach(function(d) {
      ['am','pm'].forEach(function(period) {
        var startEl = document.getElementById('add-ds-' + d + '-' + period + '-start');
        var endEl = document.getElementById('add-ds-' + d + '-' + period + '-end');
        if (startEl && endEl) {
          if (!sched[d]) sched[d] = {};
          sched[d][period] = startEl.value + '〜' + endEl.value;
        }
      });
    });
    DOCTORS.push({
      id: id, name: name, role: role, color: '#6b7280',
      docBg: '#ffffff', reservedBg: '#ffffff', reservedText: '#000000', listColor: '#999'
    });
    staffScheduleStore[id] = { schedule: sched, holidays: [], extraWorkDays: [] };
    addingNewDoctor = false;
    addDocTempSchedule = {};
    renderDocCards();
    showToast(name + ' を追加しました');
  }

  function removeDocHoliday(docId, idx) {
    if (docEditingId !== docId) return;
    staffScheduleStore[docId].holidays.splice(idx, 1);
    renderDocCards();
  }

  function removeDocExtraWork(docId, idx) {
    if (docEditingId !== docId) return;
    if (!staffScheduleStore[docId].extraWorkDays) return;
    staffScheduleStore[docId].extraWorkDays.splice(idx, 1);
    renderDocCards();
  }

  /* ─── ミニカレンダー ─── */
  var miniCalTarget = null;
  var miniCalYear, miniCalMonth;

  function openMiniCal(target) {
    miniCalTarget = target;
    miniCalYear = todayYear;
    miniCalMonth = todayMonth;
    renderMiniCal();
    document.getElementById('mini-cal-popup').style.display = 'flex';
  }

  function closeMiniCal() {
    document.getElementById('mini-cal-popup').style.display = 'none';
  }

  function miniCalPrev() {
    miniCalMonth--;
    if (miniCalMonth < 1) { miniCalMonth = 12; miniCalYear--; }
    renderMiniCal();
  }

  function miniCalNext() {
    miniCalMonth++;
    if (miniCalMonth > 12) { miniCalMonth = 1; miniCalYear++; }
    renderMiniCal();
  }

  function renderMiniCal() {
    var existing;
    var isExtraMode = (miniCalTarget === 'clinic_extra') || (miniCalTarget.indexOf('docextra_') === 0);
    if (miniCalTarget === 'clinic') {
      existing = clinicSettings.holidays;
    } else if (miniCalTarget === 'clinic_extra') {
      existing = clinicSettings.extraWorkDays;
    } else if (miniCalTarget.indexOf('docextra_') === 0) {
      var deId = miniCalTarget.replace('docextra_', '');
      var deDs = staffScheduleStore[deId];
      if (!deDs.extraWorkDays) deDs.extraWorkDays = [];
      existing = deDs.extraWorkDays;
    } else {
      var docId = miniCalTarget.replace('doc_', '');
      existing = staffScheduleStore[docId] ? staffScheduleStore[docId].holidays : [];
    }

    var html = '<div class="mini-cal-box">';
    html += '<div class="mini-cal-header">';
    html += '<button class="mini-cal-nav" onclick="miniCalPrev()">&#9664;</button>';
    html += '<span class="mini-cal-title">' + miniCalYear + '年' + miniCalMonth + '月</span>';
    html += '<button class="mini-cal-nav" onclick="miniCalNext()">&#9654;</button>';
    html += '</div>';
    if (isExtraMode) {
      html += '<div style="font-size:11px;color:#16a34a;font-weight:600;margin-bottom:8px;text-align:center;">臨時診療日を選択</div>';
    }
    html += '<div class="mini-cal-grid">';
    ['日','月','火','水','木','金','土'].forEach(function(d, i) {
      var cls = 'mini-cal-dow';
      if (i === 0) cls += ' sunday';
      if (i === 6) cls += ' saturday';
      html += '<div class="' + cls + '">' + d + '</div>';
    });

    var firstDay = new Date(miniCalYear, miniCalMonth - 1, 1).getDay();
    var daysInMonth = new Date(miniCalYear, miniCalMonth, 0).getDate();
    for (var i = 0; i < firstDay; i++) {
      html += '<div class="mini-cal-day empty"></div>';
    }
    for (var d = 1; d <= daysInMonth; d++) {
      var dateStr = miniCalYear + '/' + cspad(miniCalMonth) + '/' + cspad(d);
      var isSel = existing.indexOf(dateStr) >= 0;
      var isToday = (miniCalYear === todayYear && miniCalMonth === todayMonth && d === todayDate);
      var dow = new Date(miniCalYear, miniCalMonth - 1, d).getDay();
      var cls = 'mini-cal-day';
      if (isToday) cls += ' today';
      if (isSel) cls += (isExtraMode ? ' selected-green' : ' selected');
      if (dow === 0) cls += ' sunday';
      if (dow === 6) cls += ' saturday';
      html += '<button class="' + cls + '" onclick="selectMiniCalDay(' + d + ')">' + d + '</button>';
    }
    html += '</div>';
    html += '<div style="text-align:right;margin-top:14px;">';
    html += '<button class="doc-btn-sm" style="background:#f0f0f0;color:#666;border-color:#ddd;" onclick="closeMiniCal()">閉じる</button>';
    html += '</div></div>';

    document.getElementById('mini-cal-popup').innerHTML = html;
  }

  function selectMiniCalDay(day) {
    var dateStr = miniCalYear + '/' + cspad(miniCalMonth) + '/' + cspad(day);

    /* 臨時診療日（院） */
    if (miniCalTarget === 'clinic_extra') {
      var idx = clinicSettings.extraWorkDays.indexOf(dateStr);
      if (idx >= 0) { clinicSettings.extraWorkDays.splice(idx, 1); }
      else { clinicSettings.extraWorkDays.push(dateStr); clinicSettings.extraWorkDays.sort(); }
      renderClinicSettings();
      renderMiniCal();
      return;
    }

    /* 臨時診療日（担当医） */
    if (miniCalTarget.indexOf('docextra_') === 0) {
      var deId = miniCalTarget.replace('docextra_', '');
      if (!staffScheduleStore[deId]) return;
      if (!staffScheduleStore[deId].extraWorkDays) staffScheduleStore[deId].extraWorkDays = [];
      var arr = staffScheduleStore[deId].extraWorkDays;
      var idx2 = arr.indexOf(dateStr);
      if (idx2 >= 0) { arr.splice(idx2, 1); }
      else { arr.push(dateStr); arr.sort(); }
      renderDocCards();
      renderMiniCal();
      return;
    }

    if (miniCalTarget === 'clinic') {
      var idx = clinicSettings.holidays.indexOf(dateStr);
      if (idx >= 0) {
        /* Removing — no warning */
        clinicSettings.holidays.splice(idx, 1);
        renderClinicSettings();
        renderMiniCal();
      } else {
        /* Adding — check for reservations */
        checkAndAddHoliday(dateStr, function() {
          clinicSettings.holidays.push(dateStr);
          clinicSettings.holidays.sort();
          renderClinicSettings();
          renderMiniCal();
        });
      }
    } else {
      var docId = miniCalTarget.replace('doc_', '');
      if (!staffScheduleStore[docId]) return;
      var arr = staffScheduleStore[docId].holidays;
      var idx2 = arr.indexOf(dateStr);
      if (idx2 >= 0) {
        /* Removing — no warning */
        arr.splice(idx2, 1);
        renderDocCards();
        renderMiniCal();
      } else {
        /* Adding — check for reservations */
        checkAndAddHoliday(dateStr, function() {
          arr.push(dateStr);
          arr.sort();
          renderDocCards();
          renderMiniCal();
        });
      }
    }
  }

  /* ─── Warning modal for holidays with existing reservations ─── */
  function checkAndAddHoliday(dateStr, onConfirm) {
    var count = dummyReservationsByDate[dateStr];
    if (count && count > 0) {
      /* Parse date for display */
      var parts = dateStr.split('/');
      var dispMonth = parseInt(parts[1], 10);
      var dispDay = parseInt(parts[2], 10);
      showWarnModal(dispMonth + '月' + dispDay + '日は予約が' + count + '件あります。休診にしますか？', onConfirm);
    } else {
      onConfirm();
    }
  }

  function showWarnModal(message, onConfirm) {
    var el = document.getElementById('warn-modal');
    var html = '<div class="warn-modal-overlay" onclick="if(event.target===this)closeWarnModal()">';
    html += '<div class="warn-modal-box">';
    html += '<div class="warn-modal-text">' + message + '</div>';
    html += '<div class="warn-modal-actions">';
    html += '<button class="warn-modal-cancel" onclick="closeWarnModal()">閉じる</button>';
    html += '<button class="warn-modal-confirm" id="warn-modal-confirm-btn">休診にする</button>';
    html += '</div></div></div>';
    el.innerHTML = html;
    el.style.display = 'block';
    document.getElementById('warn-modal-confirm-btn').onclick = function() {
      closeWarnModal();
      onConfirm();
    };
  }

  function closeWarnModal() {
    var el = document.getElementById('warn-modal');
    el.style.display = 'none';
    el.innerHTML = '';
  }

  /* ════ Init ════ */
  /* 今日の日付を UI にセット */
  document.getElementById('topbar-date').textContent = todayStr;
  document.getElementById('dash-gantt-date').textContent = todayStr;

  buildMonthOptions();

  /* 日曜日は休診日 → ガントチャート非表示 */
  if (TODAY.getDay() === 0) {
    document.getElementById('dash-gantt-area').style.display = 'none';
    document.getElementById('dash-closed-message').style.display = 'flex';
  } else {
    renderGantt();
  }

  // ===== パスワード認証モーダル =====
  const ADMIN_PASSWORD = '1234'; // モック用パスワード
  let authCallback = null;

  function showAuthModal(callback) {
    authCallback = callback;
    const modal = document.getElementById('authModal');
    modal.style.display = 'flex';
    document.getElementById('authInput').value = '';
    document.getElementById('authInput').style.borderColor = '#ddd';
    document.getElementById('authError').textContent = '';
    setTimeout(() => document.getElementById('authInput').focus(), 100);
  }

  function authSubmit() {
    const pw = document.getElementById('authInput').value;
    const input = document.getElementById('authInput');
    const err = document.getElementById('authError');
    if (!pw) {
      err.textContent = 'パスワードを入力してください';
      input.style.borderColor = '#EF4444';
      return;
    }
    if (pw !== ADMIN_PASSWORD) {
      err.textContent = 'パスワードが正しくありません';
      input.style.borderColor = '#EF4444';
      input.value = '';
      setTimeout(() => input.focus(), 50);
      return;
    }
    // 認証成功
    document.getElementById('authModal').style.display = 'none';
    if (authCallback) authCallback();
  }

  function authCancel() {
    document.getElementById('authModal').style.display = 'none';
    authCallback = null;
  }

  function authToggleEye() {
    const inp = document.getElementById('authInput');
    const btn = inp.nextElementSibling;
    if (inp.type === 'password') { inp.type = 'text'; btn.textContent = '🙈'; }
    else { inp.type = 'password'; btn.textContent = '👁'; }
  }

  // モーダル外クリックで閉じる（DOM生成後に実行）
  document.addEventListener('DOMContentLoaded', function() {
    var authModal = document.getElementById('authModal');
    if (authModal) {
      authModal.addEventListener('click', function(e) {
        if (e.target === this) authCancel();
      });
    }
  });

  // チェック状態を見てからパスを挟む共通関数
  function requireAuthIfNeeded(secKey, callback) {
    const val = stgData.secRequirePassword[secKey];
    console.log('requireAuthIfNeeded:', secKey, val, stgData.secRequirePassword);
    if (val === true) {
      showAuthModal(callback);
    } else {
      callback();
    }
  }

// ===== 反映日選択モーダル =====
var effectiveCallback = null;
var effectiveSelectedType = null;

function showEffectiveModal(callback, subtitle) {
  effectiveCallback = callback;
  effectiveSelectedType = null;

  // サブタイトル更新
  document.getElementById('effSubtitle').innerHTML = subtitle || '担当医のスケジュール変更の<br>反映開始日を選択してください';

  // 選択状態リセット
  document.querySelectorAll('.eff-btn').forEach(b => {
    b.style.borderColor = '#E2E8F0';
    b.style.background = '#fff';
    b.querySelector('div > div').style.color = '#1a1a1a';
  });
  document.getElementById('effCalendar').style.display = 'none';
  document.getElementById('effWarning').style.display = 'none';
  document.getElementById('effCustomDate').value = '';
  document.getElementById('effOkBtn').disabled = true;
  document.getElementById('effOkBtn').style.opacity = '0.5';

  // 日付ヒント更新
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
  const days = ['日','月','火','水','木','金','土'];
  document.getElementById('effTodayHint').textContent =
    `${y}年${m+1}月${d}日（${days[now.getDay()]}）`;
  const nm = new Date(y, m+1, 1);
  document.getElementById('effNextMonthHint').textContent =
    `${nm.getFullYear()}年${nm.getMonth()+1}月1日（${days[nm.getDay()]}）〜`;

  document.getElementById('effectiveModal').style.display = 'flex';
}

function effectiveSelect(btn, type) {
  effectiveSelectedType = type;

  document.querySelectorAll('.eff-btn').forEach(b => {
    b.style.borderColor = '#E2E8F0';
    b.style.background = '#fff';
    b.querySelector('div > div').style.color = '#1a1a1a';
  });
  btn.style.borderColor = '#3B82F6';
  btn.style.background = '#EFF6FF';
  btn.querySelector('div > div').style.color = '#1D4ED8';

  const cal = document.getElementById('effCalendar');
  if (type === 'custom') {
    cal.style.display = 'block';
    document.getElementById('effWarning').style.display = 'none';
    document.getElementById('effOkBtn').disabled = true;
    document.getElementById('effOkBtn').style.opacity = '0.5';
  } else {
    cal.style.display = 'none';
    document.getElementById('effWarning').style.display = 'block';
    document.getElementById('effOkBtn').disabled = false;
    document.getElementById('effOkBtn').style.opacity = '1';
  }
}

function effectiveDateChange() {
  const val = document.getElementById('effCustomDate').value;
  if (val) {
    document.getElementById('effWarning').style.display = 'block';
    document.getElementById('effOkBtn').disabled = false;
    document.getElementById('effOkBtn').style.opacity = '1';
  }
}

function effectiveSubmit() {
  const type = effectiveSelectedType;
  let dateStr = null;
  const now = new Date();
  if (type === 'today') {
    dateStr = now.toISOString().split('T')[0];
  } else if (type === 'next-month') {
    const nm = new Date(now.getFullYear(), now.getMonth()+1, 1);
    dateStr = nm.toISOString().split('T')[0];
  } else if (type === 'custom') {
    dateStr = document.getElementById('effCustomDate').value;
  }
  document.getElementById('effectiveModal').style.display = 'none';
  if (effectiveCallback) effectiveCallback(dateStr);
}

function effectiveCancel() {
  document.getElementById('effectiveModal').style.display = 'none';
  effectiveCallback = null;
}

const _effModal = document.getElementById('effectiveModal');
if (_effModal) {
  _effModal.addEventListener('click', function(e) {
    if (e.target === this) effectiveCancel();
  });
}

/* ════════════════════════════════════════════
   API連携: スタッフ・予約・患者データ読み込み
   ════════════════════════════════════════════ */

async function loadStaffData() {
  try {
    const res = await fetch('/api/admin/staff');
    const { staff } = await res.json();
    DOCTORS.length = 0;
    staff.forEach(function(s) {
      DOCTORS.push({
        id: s.slug,
        name: s.name,
        role: s.role,
        color: s.color,
        docBg: '#ffffff',
        reservedBg: '#ffffff',
        reservedText: '#000000',
        listColor: s.color,
        textColor: '#ffffff'
      });
    });
    // staffScheduleStore を担当医ごとの個別スケジュールで構築
    staffScheduleStore = {};
    DOCTORS.forEach(doc => {
      const sched = {};
      if (doc.id === 'tanaka') {
        // 田中 誠（院長）: 月〜金 午前+午後、土 午前のみ
        [1,2,3,4,5].forEach(d => {
          sched[d] = { am: '09:00〜13:00', pm: '16:00〜20:00' };
        });
        sched[6] = { am: '09:00〜13:00' };
      } else if (doc.id === 'suzuki') {
        // 鈴木 由美（副院長）: 月水金 午前+午後、火木 午前のみ、土 休み
        [1,3,5].forEach(d => {
          sched[d] = { am: '09:00〜13:00', pm: '16:00〜20:00' };
        });
        [2,4].forEach(d => {
          sched[d] = { am: '09:00〜13:00' };
        });
      } else if (doc.id === 'sato') {
        // 佐藤 健: 月〜金 午前10:30〜12:00+午後16:00〜18:00、土 午前のみ
        [1,2,3,4,5].forEach(d => {
          sched[d] = { am: '10:30〜12:00', pm: '16:00〜18:00' };
        });
        sched[6] = { am: '09:00〜13:00' };
      } else {
        // その他: 院の基本スケジュール（月〜土）
        (clinicSettings.workDays || [1,2,3,4,5,6]).forEach(d => {
          sched[d] = {
            am: csTimeStr(clinicSettings.amStart) + '〜' + csTimeStr(clinicSettings.amEnd),
            pm: csTimeStr(clinicSettings.pmStart) + '〜' + csTimeStr(clinicSettings.pmEnd)
          };
        });
      }
      staffScheduleStore[doc.id] = { schedule: sched, holidays: [], extraWorkDays: [] };
    });
  } catch (e) {
    console.error('スタッフデータの読み込みに失敗しました（モックデータで動作します）', e);
  }
}

async function loadReservationData(dateStr) {
  try {
    const res = await fetch('/api/admin/reservations?date=' + dateStr);
    const { reservations: data } = await res.json();
    Object.keys(reservations).forEach(function(k) { delete reservations[k]; });
    var statusMap = { visited: '来院済', unprocessed: '未処理', confirmed: '予約済' };
    // 曜日を取得（スケジュール判定用）
    var dp = dateStr.split('-');
    var loadDow = new Date(parseInt(dp[0]), parseInt(dp[1])-1, parseInt(dp[2])).getDay();
    // staff_idがある予約を先に配置
    data.filter(function(r) { return r.staffId; }).forEach(function(r) {
      var key = r.staffId + '_' + r.time.slice(0, 5);
      reservations[key] = {
        resId: r.id,
        name: r.patientName,
        card: r.patientId,
        status: statusMap[r.status] || '予約済',
        doctorPreferred: true,
        preferredStaffId: r.staffId,
        originalDocId: r.staffId,
        doctorHistory: []
      };
    });
    // staff_idがnullの予約を空きスロットにランダム割り振り（スケジュール内のみ）
    var docIds = DOCTORS.map(function(d) { return d.id; });
    var seed = 7;
    data.filter(function(r) { return !r.staffId; }).forEach(function(r) {
      var time = r.time.slice(0, 5);
      var shuffled = docIds.slice();
      for (var i = shuffled.length - 1; i > 0; i--) {
        var x = Math.sin(seed++) * 10000; x = x - Math.floor(x);
        var j = Math.floor(x * (i + 1));
        var tmp = shuffled[i]; shuffled[i] = shuffled[j]; shuffled[j] = tmp;
      }
      for (var k = 0; k < shuffled.length; k++) {
        var key = shuffled[k] + '_' + time;
        if (!reservations[key] && isScheduledSlot(shuffled[k], loadDow, time)) {
          reservations[key] = {
            resId: r.id,
            name: r.patientName,
            card: r.patientId,
            status: statusMap[r.status] || '予約済',
            doctorPreferred: false,
            preferredStaffId: null,
            originalDocId: null,
            doctorHistory: []
          };
          break;
        }
      }
    });
  } catch (e) {
    console.error('予約データの読み込みに失敗しました（モックデータで動作します）', e);
  }
}

async function loadReservationDataForDate(dateStr) {
  listDateReservations = {};
  renderListGantt();
  try {
    const res = await fetch('/api/admin/reservations?date=' + dateStr);
    const { reservations: data } = await res.json();
    var result = {};
    var statusMap = { visited: '来院済', unprocessed: '未処理', confirmed: '予約済' };
    // 曜日を取得（スケジュール判定用）
    var dp = dateStr.split('-');
    var loadDow = new Date(parseInt(dp[0]), parseInt(dp[1])-1, parseInt(dp[2])).getDay();
    // staff_idがある予約を先に配置
    data.filter(function(r) { return r.staffId; }).forEach(function(r) {
      var key = r.staffId + '_' + r.time.slice(0, 5);
      result[key] = {
        resId: r.id,
        name: r.patientName,
        card: r.patientId,
        status: statusMap[r.status] || '予約済',
        doctorPreferred: true,
        preferredStaffId: r.staffId,
        originalDocId: r.staffId,
        doctorHistory: []
      };
    });
    // staff_idがnullの予約を空きスロットにランダム割り振り（スケジュール内のみ）
    var docIds = DOCTORS.map(function(d) { return d.id; });
    var seed = 13;
    data.filter(function(r) { return !r.staffId; }).forEach(function(r) {
      var time = r.time.slice(0, 5);
      var shuffled = docIds.slice();
      for (var i = shuffled.length - 1; i > 0; i--) {
        var x = Math.sin(seed++) * 10000; x = x - Math.floor(x);
        var j = Math.floor(x * (i + 1));
        var tmp = shuffled[i]; shuffled[i] = shuffled[j]; shuffled[j] = tmp;
      }
      for (var k = 0; k < shuffled.length; k++) {
        var key = shuffled[k] + '_' + time;
        if (!result[key] && isScheduledSlot(shuffled[k], loadDow, time)) {
          result[key] = {
            resId: r.id,
            name: r.patientName,
            card: r.patientId,
            status: statusMap[r.status] || '予約済',
            doctorPreferred: false,
            preferredStaffId: null,
            originalDocId: null,
            doctorHistory: []
          };
          break;
        }
      }
    });
    return result;
  } catch (e) {
    console.error('予約データの読み込みに失敗しました', e);
    return {};
  }
}

async function loadPatientData() {
  try {
    const res = await fetch('/api/admin/patients');
    const { patients } = await res.json();
    Object.keys(PATIENT_DATA).forEach(function(k) { delete PATIENT_DATA[k]; });
    patients.forEach(function(p) {
      PATIENT_DATA[p.card_id] = {
        uuid: p.id,
        name: p.name,
        kana: p.kana || '',
        dob: p.dob || '',
        gender: p.gender || '',
        zip: p.zip || '',
        phone: p.phone || '',
        address: p.address || '',
        lastVisit: '',
        notes: p.notes || ''
      };
    });
  } catch (e) {
    console.error('患者データの読み込みに失敗しました（モックデータで動作します）', e);
  }
}

async function loadInitialData() {
  await Promise.all([
    loadStaffData(),
    loadReservationData(todayISO),
    loadPatientData()
  ]);
  // データ読み込み後に画面を再描画
  if (TODAY.getDay() !== 0) {
    renderGantt();
  }
  searchPatients();
}

document.addEventListener('DOMContentLoaded', function() {
  loadInitialData();
});

</script>
<!-- パスワード認証モーダル -->
<div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:8px; padding:28px 24px 20px; width:320px; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
    <h3 style="text-align:center;font-size:15px;font-weight:600;color:#1a1a1a;margin-bottom:4px;">管理者パスワードの確認</h3>
    <p style="text-align:center;font-size:12px;color:#888;margin-bottom:18px;line-height:1.6;">この操作には管理者パスワードが<br>必要です</p>
    <div style="position:relative;margin-bottom:6px;">
      <input id="authInput" type="password" placeholder="パスワードを入力"
        style="width:100%;border:1.5px solid #ddd;border-radius:6px;padding:10px 40px 10px 12px;font-size:14px;outline:none;font-family:inherit;box-sizing:border-box;"
        oninput="document.getElementById('authInput').style.borderColor='#ddd';document.getElementById('authError').textContent='';"
        onkeydown="if(event.key==='Enter')authSubmit();">
      <button onclick="authToggleEye()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#aaa;font-size:16px;padding:2px;">👁</button>
    </div>
    <div id="authError" style="font-size:11px;color:#EF4444;margin-bottom:14px;padding-left:2px;min-height:16px;"></div>
    <div style="display:flex;gap:8px;">
      <button onclick="authCancel()" style="flex:1;padding:10px;border:1.5px solid #ddd;border-radius:6px;background:#fff;color:#555;font-size:13px;cursor:pointer;font-family:inherit;">閉じる</button>
      <button onclick="authSubmit()" style="flex:1;padding:10px;border:none;border-radius:6px;background:#3B82F6;color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;">確認</button>
    </div>
  </div>
</div>
<!-- 反映日選択モーダル -->
<div id="effectiveModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:8px; padding:24px; width:320px; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
    <h3 style="font-size:15px; font-weight:600; color:#1a1a1a; margin-bottom:4px;">いつから反映しますか？</h3>
    <p id="effSubtitle" style="font-size:12px; color:#888; margin-bottom:20px; line-height:1.6;">担当医のスケジュール変更の<br>反映開始日を選択してください</p>
    <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px;">
      <button onclick="effectiveSelect(this,'today')" class="eff-btn" style="display:flex; align-items:center; padding:11px 14px; border:1.5px solid #E2E8F0; border-radius:8px; background:#fff; cursor:pointer; font-family:inherit; text-align:left; width:100%;">
        <div><div style="font-size:13px; font-weight:600; color:#1a1a1a;">本日</div><div id="effTodayHint" style="font-size:11px; color:#888; margin-top:2px;"></div></div>      </button>
      <button onclick="effectiveSelect(this,'next-month')" class="eff-btn" style="display:flex; align-items:center; padding:11px 14px; border:1.5px solid #E2E8F0; border-radius:8px; background:#fff; cursor:pointer; font-family:inherit; text-align:left; width:100%;">
        <div><div style="font-size:13px; font-weight:600; color:#1a1a1a;">来月から</div><div id="effNextMonthHint" style="font-size:11px; color:#888; margin-top:2px;"></div></div>
      </button>
      <button onclick="effectiveSelect(this,'custom')" class="eff-btn" style="display:flex; align-items:center; padding:11px 14px; border:1.5px solid #E2E8F0; border-radius:8px; background:#fff; cursor:pointer; font-family:inherit; text-align:left; width:100%;">
       <div><div style="font-size:13px; font-weight:600; color:#1a1a1a;">カレンダーから選択</div><div style="font-size:11px; color:#888; margin-top:2px;">日付を指定する</div></div>
      </button>
    </div>
    <div id="effCalendar" style="display:none; margin-bottom:16px; padding:10px 14px; border:1.5px solid #3B82F6; border-radius:8px; background:#F8FBFF;">
      <label style="font-size:11px; color:#555; display:block; margin-bottom:6px;">反映開始日</label>
           <input type="date" id="effCustomDate" onchange="effectiveDateChange()" style="width:100%; border:1.5px solid #CBD5E1; border-radius:6px; padding:8px 10px; font-size:13px; font-family:inherit; outline:none; color:#1a1a1a; box-sizing:border-box;">
    </div>
    <div id="effWarning" style="display:none; background:#FFFBEB; border:1.5px solid #FCD34D; border-radius:6px; padding:10px 12px; font-size:12px; color:#92400E; line-height:1.6; margin-bottom:16px;">
      以降に予約がありますが、予約はそのままでよろしいですか？
    </div>
    <div style="display:flex; gap:8px;">
      <button onclick="effectiveCancel()" style="flex:1; padding:10px; border:1.5px solid #ddd; border-radius:6px; background:#fff; color:#555; font-size:13px; cursor:pointer; font-family:inherit;">閉じる</button>
      <button id="effOkBtn" onclick="effectiveSubmit()" disabled style="flex:1; padding:10px; border:none; border-radius:6px; background:#3B82F6; color:#fff; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; opacity:0.5;">反映する</button>
    </div>
  </div>
</div>
</body>
</html>
